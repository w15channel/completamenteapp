<!DOCTYPE html><html lang="pt-br"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" content="#0f172a"><title>Harmonia Diária - WR TERAPIA</title><script src="https://cdn.tailwindcss.com"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"><script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script><script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script><style>@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Quicksand:wght@400;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&family=Playfair+Display:ital,wght@0,700;1,600&display=swap');:root{--bg-dark:#0f172a;--card-bg:#1e293b;--primary:#0ea5e9;--text-light:#f1f5f9;--text-dim:#94a3b8;--gold:#c4a661}*{box-sizing:border-box}body{font-family:'Inter',sans-serif;background-color:var(--bg-dark);color:var(--text-light);margin:0;padding:0;position:fixed;inset:0;display:flex;flex-direction:column}.heading-font{font-family:'Quicksand',sans-serif}.glass-card{background:rgba(30,41,59,0.98);border:1px solid rgba(255,255,255,0.1);border-radius:1.5rem;box-shadow:0 4px 6px -1px rgba(0,0,0,0.5)}main{flex:1;position:relative;width:100%;max-width:480px;margin:0 auto;transition:max-width 0.3s}.tab-content{display:none;position:absolute;inset:0;padding:1rem;overflow-y:auto;-webkit-overflow-scrolling:touch}.tab-content.active{display:flex;flex-direction:column;animation:fadeIn .3s ease-out}@keyframes fadeIn{from{opacity:0}to{opacity:1}}#chat.tab-content{padding:0;overflow:hidden}.chat-layout{display:flex;flex-direction:column;height:100%}.chat-messages-area{flex:1;overflow-y:auto;padding:1rem;background:rgba(15,23,42,0.5)}.message{max-width:85%;padding:12px 16px;border-radius:1.2rem;font-size:.95rem;line-height:1.5;margin-bottom:12px}.message.user{align-self:flex-end;background:var(--primary);color:#fff;border-bottom-right-radius:.2rem;margin-left:auto}.message.therapist{align-self:flex-start;background:#334155;color:#e2e8f0;border-bottom-left-radius:.2rem;margin-right:auto}.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px}.status-online{background-color:#10b981;box-shadow:0 0 5px #10b981}.status-busy{background-color:#f59e0b;box-shadow:0 0 5px #f59e0b}.status-offline{background-color:#94a3b8}.admin-grid{display:grid;grid-template-columns:300px 1fr 350px;gap:16px;height:100%}@media(max-width:1024px){.admin-grid{display:flex;flex-direction:column}}::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#475569;border-radius:2px}input,select,textarea{background-color:#334155;color:#fff;border-color:#475569}input::placeholder,textarea::placeholder{color:#94a3b8}input:disabled{opacity:0.6;cursor:not-allowed}.toggle-checkbox:checked{right:0;border-color:#10b981}.toggle-checkbox:checked+.toggle-label{background-color:#10b981}</style><script src="https://www.youtube.com/iframe_api"></script></head><body><header class="flex-none p-4 text-center bg-slate-900/95 backdrop-blur-md border-b border-slate-700 z-20 relative"><button id="music-toggle" onclick="window.toggleMusic()" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-sky-400 transition-colors w-8 h-8 flex items-center justify-center rounded-full active:bg-slate-800"><i id="music-icon" class="fas fa-volume-mute"></i></button><h1 class="text-lg uppercase tracking-widest font-bold text-sky-400 font-sans">ESPAÇO | WR TERAPIA®</h1></header><main id="main-area"><div id="bg-music-player" style="display:none;"></div><div id="consent-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/95 backdrop-blur-sm"><div class="glass-card p-6 w-full max-w-sm animate-fade-in border border-sky-500/30"><div class="w-16 h-16 bg-sky-900/50 rounded-full flex items-center justify-center mb-4 mx-auto text-sky-400"><i class="fas fa-hand-holding-heart text-3xl animate-pulse"></i></div><h3 class="text-xl font-bold text-center text-white mb-4 heading-font">Seu acolhimento em primeiro lugar</h3><div class="text-xs text-slate-300 space-y-3 mb-6 text-justify leading-relaxed"><p>"Sempre que nossos profissionais estiverem ocupados, acionamos nossa Inteligência Artificial supervisionada para lhe dar conforto imediato."</p></div><div class="flex flex-col gap-3"><button onclick="window.acceptTerms()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold shadow-lg transition-all">Aceitar termos</button><button onclick="window.declineTerms()" class="w-full bg-slate-700 hover:bg-slate-600 text-slate-300 py-3 rounded-xl font-bold transition-all">Voltar</button></div></div></div><section id="onboarding" class="tab-content active"><div class="h-full flex flex-col items-center justify-center p-4"><div class="glass-card p-8 text-center w-full"><div class="w-20 h-20 bg-slate-700 rounded-full flex items-center justify-center mb-6 mx-auto ring-2 ring-sky-500/50"><i class="fas fa-fingerprint text-sky-400 text-3xl"></i></div><h2 class="text-2xl font-bold text-white mb-2 heading-font">Acesso Restrito</h2><p class="text-[10px] text-emerald-400 mb-6 font-bold"><i class="fas fa-shield-alt mr-1"></i>Ambiente Seguro e Criptografado</p><div class="w-full mb-4 space-y-3"><input type="text" id="user-name-input" oninput="this.value=this.value.toUpperCase()" placeholder="PRIMEIRO E SEGUNDO NOME" class="w-full p-4 rounded-2xl text-center uppercase font-bold outline-none focus:ring-2 focus:ring-sky-500 text-sm"><input type="password" id="user-pass-input" placeholder="SENHA (DDMMAAAA)" maxlength="8" class="w-full p-4 rounded-2xl text-center font-bold outline-none focus:ring-2 focus:ring-sky-500 tracking-widest"></div><button onclick="window.login()" class="w-full bg-sky-600 text-white py-4 rounded-2xl font-bold shadow-lg mt-2 hover:bg-sky-500 transition-all">Entrar / Registrar</button></div></div></section><section id="home" class="tab-content"><div class="glass-card p-6 mb-4"><p class="text-xs text-slate-400">Muito bom te ver aqui,</p><h2 class="text-xl font-bold text-white heading-font mb-6 client-name">Visitante</h2><div class="grid grid-cols-2 gap-4"><button onclick="window.triggerChatSelection()" class="p-3 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-2 hover:bg-slate-700"><i class="fas fa-comment-medical text-2xl text-sky-400"></i><span class="text-[9px] font-bold uppercase text-slate-300">Conversar</span></button><button onclick="window.showTab('routines')" class="p-3 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-2 hover:bg-slate-700"><i class="fas fa-clock text-2xl text-emerald-400"></i><span class="text-[9px] font-bold uppercase text-slate-300">Minha Rotina</span></button><button onclick="window.showTab('cycle')" class="p-3 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-2 hover:bg-slate-700"><i class="fas fa-calendar-alt text-2xl text-rose-400"></i><span class="text-[9px] font-bold uppercase text-slate-300">Meu Ciclo</span></button><button onclick="window.showTab('agenda')" class="p-3 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-2 hover:bg-slate-700"><i class="fas fa-calendar-check text-2xl text-amber-400"></i><span class="text-[9px] font-bold uppercase text-slate-300">Agendar</span></button></div></div><div class="mt-auto pt-8 pb-4 text-center flex flex-col items-center justify-center gap-2"><p class="text-[9px] text-slate-600 uppercase font-bold tracking-widest">Desenvolvido por WR-TECNOLOGIA</p><i onclick="window.showAdminLogin()" class="fas fa-lock text-slate-700 text-xs admin-trigger" title="Admin"></i></div></section><section id="routines" class="tab-content"><div class="glass-card p-5 h-full flex flex-col"><div class="flex items-center gap-3 mb-4 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-emerald-400">Lembretes & Rotina</h2></div><div class="flex-1 overflow-y-auto space-y-4 pr-1 text-sm"><div class="bg-slate-800 p-3 rounded-xl border border-slate-700"><label class="flex justify-between items-center text-slate-300 font-bold mb-2"><span class="flex items-center gap-2"><i class="fas fa-sun text-yellow-400"></i> Acordar</span><input type="time" id="rt-wake" class="p-1 rounded bg-slate-700"></label></div><div class="bg-slate-800 p-3 rounded-xl border border-slate-700"><label class="flex justify-between items-center text-slate-300 font-bold mb-2"><span class="flex items-center gap-2"><i class="fas fa-tint text-sky-400"></i> Água (Notificar a cada min)</span><input type="number" id="rt-water" placeholder="Ex: 60" class="p-1 rounded bg-slate-700 w-16 text-center"></label></div><div class="bg-slate-800 p-3 rounded-xl border border-slate-700"><label class="flex justify-between items-center text-slate-300 font-bold mb-2"><span class="flex items-center gap-2"><i class="fas fa-running text-orange-400"></i> Exercício (>20min)</span><input type="time" id="rt-exercise" class="p-1 rounded bg-slate-700"></label></div><div class="bg-slate-800 p-3 rounded-xl border border-slate-700"><label class="flex justify-between items-center text-slate-300 font-bold mb-2"><span class="flex items-center gap-2"><i class="fas fa-wind text-teal-400"></i> Luz/Ar Puro</span><input type="time" id="rt-air" class="p-1 rounded bg-slate-700"></label></div><div class="bg-slate-800 p-3 rounded-xl border border-slate-700"><label class="flex justify-between items-center text-slate-300 font-bold mb-2"><span class="flex items-center gap-2"><i class="fas fa-praying-hands text-purple-400"></i> Meditação/Religião</span><input type="time" id="rt-meditation" class="p-1 rounded bg-slate-700"></label></div><div class="bg-slate-800 p-3 rounded-xl border border-slate-700"><label class="flex justify-between items-center text-slate-300 font-bold mb-2"><span class="flex items-center gap-2"><i class="fas fa-moon text-indigo-400"></i> Dormir (Alarme)</span><input type="time" id="rt-sleep" class="p-1 rounded bg-slate-700"></label><label class="flex justify-between items-center text-slate-400 text-xs mt-2">Horas desejadas: <input type="number" id="rt-sleep-hrs" placeholder="8" class="p-1 rounded bg-slate-700 w-12 text-center"></label></div></div><button onclick="window.saveRoutines()" class="w-full mt-4 bg-emerald-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2"><i class="fas fa-bell"></i> Ativar Notificações</button></div></section><section id="cycle" class="tab-content"><div class="glass-card p-5 h-full flex flex-col"><div class="flex items-center gap-3 mb-4 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-rose-400">Meu Ciclo</h2></div><div class="bg-slate-800 p-4 rounded-xl border border-slate-700 mb-4 flex-none"><label class="block text-slate-300 text-sm font-bold mb-2">Primeiro dia da última menstruação:</label><input type="date" id="cy-date" onchange="window.calcCycle()" class="w-full p-2 rounded bg-slate-700 mb-3"><div id="cy-result" class="text-xs text-rose-300 italic hidden bg-rose-900/30 p-2 rounded border border-rose-800"></div></div><div class="flex-1 flex flex-col"><label class="block text-slate-300 text-sm font-bold mb-2"><i class="fas fa-book-open text-sky-400 mr-2"></i>Diário / Sentimentos (Notepad):</label><textarea id="cy-notes" placeholder="Ex: Hoje acordei com cólicas, me sinto cansada..." class="w-full flex-1 p-3 rounded-xl resize-none text-sm"></textarea></div><button onclick="window.saveCycle()" class="w-full mt-4 bg-rose-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2"><i class="fas fa-save"></i> Salvar Registro</button></div></section><section id="admin-login-screen" class="tab-content justify-center items-center"><div class="glass-card p-6 w-full text-center"><div class="flex justify-between items-center mb-4"><button onclick="window.showTab('home')" class="text-slate-400"><i class="fas fa-arrow-left"></i></button><h2 class="font-bold text-white">Administração</h2><div class="w-4"></div></div><input type="text" id="admin-user" placeholder="Login Admin" class="w-full p-3 mb-3 rounded-xl text-center"><input type="password" id="admin-pass" placeholder="Senha Admin" class="w-full p-3 mb-4 rounded-xl text-center"><button onclick="window.attemptAdminLogin()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold">Acessar</button></div></section><section id="admin-dashboard" class="tab-content"><div class="glass-card p-4 h-full flex flex-col"><div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-700 flex-none"><h2 class="font-bold text-emerald-400"><i class="fas fa-satellite-dish mr-2"></i>Torre de Controle WR</h2><button onclick="window.logoutAdmin()" class="bg-red-900/50 text-red-300 px-3 py-1 rounded-full text-xs border border-red-800">Sair</button></div><div class="admin-grid flex-1 overflow-hidden"><div class="bg-slate-900/50 rounded-xl border border-slate-700 flex flex-col overflow-hidden"><div class="p-2 bg-slate-800 text-xs font-bold text-slate-300 border-b border-slate-700 text-center">Pacientes Online/Histórico</div><div id="admin-chat-list" class="flex-1 overflow-y-auto p-2 space-y-2"></div></div><div class="bg-slate-900/50 rounded-xl border border-slate-700 flex flex-col overflow-hidden"><div class="p-2 bg-slate-800 flex justify-between items-center border-b border-slate-700"><span id="admin-target-name" class="text-xs font-bold text-white truncate">Selecione um Chat</span><button onclick="window.toggleAiStatus()" id="ai-toggle-btn" class="text-[9px] bg-slate-600 px-2 py-1 rounded hidden">IA</button></div><div id="admin-chat-preview" class="flex-1 overflow-y-auto p-4 text-sm"></div><div class="p-2 bg-slate-800 border-t border-slate-700 flex gap-2"><input type="text" id="admin-reply-input" placeholder="Assumir o controle..." class="flex-1 p-2 rounded bg-slate-700 text-sm"><button onclick="window.sendAdminReply()" class="bg-emerald-600 px-4 py-2 rounded text-white shadow"><i class="fas fa-paper-plane"></i></button></div></div><div class="bg-slate-900/50 rounded-xl border border-slate-700 flex flex-col overflow-hidden"><div class="p-2 bg-slate-800 text-xs font-bold text-sky-400 border-b border-slate-700 text-center">Ficha & Notepad</div><div id="admin-user-data" class="flex-1 overflow-y-auto p-4 text-xs space-y-4 text-slate-300">Selecione um usuário para visualizar as rotinas, ciclo e bloco de notas.</div></div></div></div></section><section id="agenda" class="tab-content"><div class="glass-card p-4 h-full flex flex-col"><div class="flex items-center gap-3 mb-4 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-sky-400 heading-font">Agendamento</h2></div><div class="flex-1 rounded-xl overflow-hidden border border-slate-600 bg-white"><iframe src="https://calendly.com/wrterapia/atendimentos" width="100%" height="100%" frameborder="0"></iframe></div></div></section><section id="chat-selection" class="tab-content"><div class="glass-card p-6 h-full overflow-y-auto"><div class="flex items-center gap-3 mb-4"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-sky-400 text-lg">Nossa Equipe</h2></div><div id="therapist-list" class="space-y-3 pb-20"></div></div></section><section id="chat" class="tab-content"><div class="chat-layout h-full"><div class="p-4 border-b border-slate-700 flex items-center gap-3 bg-slate-800/95 flex-none z-10"><div id="active-avatar" class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-md"></div><div class="flex-1"><p id="active-name" class="font-bold text-white text-sm"></p><div class="flex items-center"><span id="active-status-dot" class="status-dot"></span><span id="active-status-text" class="text-[9px] uppercase font-bold text-slate-400">Status</span></div></div><button onclick="window.showTab('chat-selection')" class="text-slate-400 hover:text-white p-2"><i class="fas fa-times"></i></button></div><div id="chat-messages" class="chat-messages-area"></div><div class="flex-none bg-slate-800 border-t border-slate-700 pb-2"><div id="typing-box" class="px-4 py-2 hidden text-xs text-sky-400 italic font-medium bg-slate-900/30">Digitando <span class="animate-pulse">...</span></div><div class="p-3"><form id="chat-form" class="flex items-center gap-2"><input type="text" id="chat-input" placeholder="Digite aqui..." class="flex-1 bg-slate-700 border-0 text-white rounded-full px-4 py-2 text-sm outline-none"><button type="submit" id="submit-btn" class="w-10 h-10 bg-sky-600 text-white rounded-full"><i class="fas fa-paper-plane"></i></button></form></div></div></div></section></main><nav id="bottom-nav" class="flex-none bg-slate-900/95 backdrop-blur-md border-t border-slate-800 py-3 flex justify-around z-50"><button onclick="window.showTab('home')" class="text-sky-500 flex flex-col items-center gap-1"><i class="fas fa-home"></i><span class="text-[9px] font-bold tracking-widest">INÍCIO</span></button><button onclick="window.triggerChatSelection()" class="text-slate-500 flex flex-col items-center gap-1"><i class="fas fa-comment"></i><span class="text-[9px] font-bold tracking-widest">CHAT</span></button></nav><script>const firebaseConfig={apiKey:"AIzaSyCCi1hrmt4OQFlgrQThbB6-n54v5WwlJoY",authDomain:"completamenteapp.firebaseapp.com",databaseURL:"https://completamenteapp-default-rtdb.firebaseio.com",projectId:"completamenteapp",storageBucket:"completamenteapp.firebasestorage.app",messagingSenderId:"343038230333",appId:"1:343038230333:web:2338b20d2e706743b40f54",measurementId:"G-YTWX2RSV32"};let db=null;try{firebase.initializeApp(firebaseConfig);db=firebase.database();}catch(e){console.warn("DB offline",e);}window.AI_PROXY_URL="https://completamenteapp.vercel.app/api/ai";window.clientName="";window.clientId="";window.hasAcceptedTerms=sessionStorage.getItem('wr_terms_accepted')==='true';window.userDataCache={};window.setupPresence=function(){if(!db||!window.clientId)return;const userStatusRef=db.ref('/status/'+window.clientId);db.ref('.info/connected').on('value',(s)=>{if(s.val()===false)return;userStatusRef.onDisconnect().set({online:false,last_seen:firebase.database.ServerValue.TIMESTAMP}).then(()=>{userStatusRef.set({online:true,last_seen:firebase.database.ServerValue.TIMESTAMP});});});};window.showTab=function(id){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.getElementById(id).classList.add('active');if(id==='admin-dashboard'){document.getElementById('main-area').style.maxWidth='100%';document.getElementById('bottom-nav').style.display='none';}else{document.getElementById('main-area').style.maxWidth='480px';document.getElementById('bottom-nav').style.display='flex';}}
window.login=async function(){const n=document.getElementById('user-name-input').value.trim().toUpperCase();const p=document.getElementById('user-pass-input').value.trim();if(n.split(' ').length<2)return alert("Digite o PRIMEIRO e SEGUNDO nome.");if(!/^\d{8}$/.test(p))return alert("A senha deve ser sua DATA DE NASCIMENTO (8 números).");window.clientId=n.replace(/\s+/g,'_');window.clientName=n.split(' ')[0];if(db){const snap=await db.ref('users/'+window.clientId).once('value');if(!snap.exists()){await db.ref('users/'+window.clientId).set({pass:p,fullName:n,created:Date.now()});}else{if(snap.val().pass!==p)return alert("Senha incorreta. Verifique sua data de nascimento.");window.userDataCache=snap.val()||{};if(window.userDataCache.routines)window.fillRoutinesForm(window.userDataCache.routines);if(window.userDataCache.cycle)window.fillCycleForm(window.userDataCache.cycle);}}localStorage.setItem('wr_client_id',window.clientId);document.querySelectorAll('.client-name').forEach(e=>e.innerText=window.clientName);window.setupPresence();window.showTab('home');if(Notification.permission!=='granted')Notification.requestPermission();startReminderLoop();}
window.onYouTubeIframeAPIReady=function(){window.player=new YT.Player('bg-music-player',{height:'0',width:'0',videoId:'Cg0dAc4-UCY',playerVars:{'autoplay':0,'controls':0,'loop':1,'playlist':'Cg0dAc4-UCY'}});}
window.toggleMusic=function(){if(!window.player)return;const btn=document.getElementById('music-icon');const state=window.player.getPlayerState();if(state===1||state===3){window.player.pauseVideo();btn.className="fas fa-volume-mute text-slate-400";}else{window.player.playVideo();window.player.unMute();window.player.setVolume(30);btn.className="fas fa-volume-up text-sky-400";}}
window.saveRoutines=async function(){const r={wake:document.getElementById('rt-wake').value,water:document.getElementById('rt-water').value,exercise:document.getElementById('rt-exercise').value,air:document.getElementById('rt-air').value,meditation:document.getElementById('rt-meditation').value,sleep:document.getElementById('rt-sleep').value,sleepHrs:document.getElementById('rt-sleep-hrs').value};if(db){await db.ref('users/'+window.clientId+'/routines').set(r);window.userDataCache.routines=r;alert("Notificações e Rotinas Ativadas!");if(Notification.permission==='default')Notification.requestPermission();}}
window.fillRoutinesForm=function(r){if(r.wake)document.getElementById('rt-wake').value=r.wake;if(r.water)document.getElementById('rt-water').value=r.water;if(r.exercise)document.getElementById('rt-exercise').value=r.exercise;if(r.air)document.getElementById('rt-air').value=r.air;if(r.meditation)document.getElementById('rt-meditation').value=r.meditation;if(r.sleep)document.getElementById('rt-sleep').value=r.sleep;if(r.sleepHrs)document.getElementById('rt-sleep-hrs').value=r.sleepHrs;}
window.calcCycle=function(){const d=document.getElementById('cy-date').value;if(!d)return;const date=new Date(d);date.setDate(date.getDate()+10);const f1=date.toLocaleDateString('pt-BR');date.setDate(date.getDate()+5);const f2=date.toLocaleDateString('pt-BR');const r=document.getElementById('cy-result');r.innerHTML=`<b>Projeção Fértil:</b><br>Aproximadamente entre ${f1} e ${f2}.`;r.classList.remove('hidden');}
window.saveCycle=async function(){const c={date:document.getElementById('cy-date').value,notes:document.getElementById('cy-notes').value,lastUpdate:Date.now()};if(db){await db.ref('users/'+window.clientId+'/cycle').set(c);window.userDataCache.cycle=c;alert("Diário e Ciclo Salvos com Sucesso!");}}
window.fillCycleForm=function(c){if(c.date){document.getElementById('cy-date').value=c.date;window.calcCycle();}if(c.notes)document.getElementById('cy-notes').value=c.notes;}
let rInterval;function startReminderLoop(){if(rInterval)clearInterval(rInterval);rInterval=setInterval(()=>{if(!window.userDataCache.routines)return;const now=new Date();const curTime=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;const r=window.userDataCache.routines;if(r.wake===curTime)notifyUser("Bom dia!","Hora de levantar e brilhar.");if(r.exercise===curTime)notifyUser("Saúde e Corpo!","Momento de pelo menos 20 min de atividade física.");if(r.air===curTime)notifyUser("Respire...","Vá tomar luz solar e ar puro.");if(r.meditation===curTime)notifyUser("Paz Interior","Hora da sua meditação ou reflexão religiosa.");if(r.sleep===curTime)notifyUser("Descanso","Hora de dormir. Meta: "+r.sleepHrs+" horas.");if(r.water&&parseInt(r.water)>0){const m=now.getHours()*60+now.getMinutes();if(m%parseInt(r.water)===0)notifyUser("Hidratação!","Beba um copo de água agora.");}},60000);}
function notifyUser(title,body){if(Notification.permission==="granted"){new Notification(title,{body:body,icon:"https://cdn-icons-png.flaticon.com/512/2965/2965306.png"});}}
const therapists=[{id:'lia',name:'Dra. Lia',color:'#ec4899',icon:'heart',schedule:'Seg-Sex (08:00 - 22:00)'},{id:'marcos',name:'Dr. Marcos',color:'#10b981',icon:'user-md',schedule:'Sáb (08-12h / 14-22h)'}];window.checkAvailability=function(id){return{s:'online',t:'Online',c:'#10b981',allow:true};}
window.triggerChatSelection=function(){if(!window.hasAcceptedTerms)document.getElementById('consent-modal').classList.remove('hidden');else window.renderTherapistList();}
window.acceptTerms=function(){window.hasAcceptedTerms=true;sessionStorage.setItem('wr_terms_accepted','true');document.getElementById('consent-modal').classList.add('hidden');window.renderTherapistList();}
window.declineTerms=function(){document.getElementById('consent-modal').classList.add('hidden');window.showTab('home');}
window.renderTherapistList=function(){const l=document.getElementById('therapist-list');l.innerHTML='';therapists.forEach(t=>{const st=window.checkAvailability(t.id);const c=document.createElement('div');c.className=`flex items-center gap-4 p-4 rounded-xl border shadow-sm transition-all mb-3 bg-slate-800 border-slate-700 cursor-pointer hover:bg-slate-700`;c.onclick=()=>window.startChat(t.id);c.innerHTML=`<div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" style="background-color:${t.color}"><i class="fas fa-${t.icon}"></i></div><div class="flex-1"><span class="font-bold text-sm text-slate-200">${t.name}</span><p class="text-[9px] text-slate-500">${t.schedule}</p><div class="flex items-center mt-1"><span class="status-dot" style="background:${st.c};box-shadow:0 0 5px ${st.c}"></span><span class="text-[8px] uppercase font-bold text-slate-400">${st.t}</span></div></div>`;l.appendChild(c);});window.showTab('chat-selection');}
window.getSystemPrompt=function(id){const base="REGRA ABSOLUTA: Você é humano. NUNCA diga ser IA. Profissão: TERAPEUTA (nunca psicólogo).";const p={'lia':`${base} Você é a Dra. Lia, terapeuta acolhedora.`,'marcos':`${base} Você é o Dr. Marcos, terapeuta estabilizador.`};let prompt=p[id]||base;const u=window.userDataCache;if(u){prompt+=`\n\n[DADOS SECRETOS DO PACIENTE PARA USO EMPÁTICO]: Nome Completo: ${u.fullName}. `;if(u.cycle&&u.cycle.notes){prompt+=`\nBLOCO DE NOTAS DO CICLO/SENTIMENTOS RECENTES: "${u.cycle.notes}". (Se a pessoa citou dores ou cólicas aqui, pergunte sutilmente se já está melhor). `;}if(u.routines){prompt+=`\nROTINAS ATIVAS: Água a cada ${u.routines.water}min, Sono: ${u.routines.sleepHrs}h. (Use isso para perguntar se a pessoa bebeu água ou dormiu bem, provando que você a acompanha e cuida dela).`;}prompt+=`\nREGRA: Se for o primeiro contato (você não sabe Whatsapp, nem Demandas Principais), faça perguntas BEM SUTIS e uma por vez para descobrir o número de contato dela e o que ela busca na terapia.`}return prompt;}
window.startChat=async function(id){window.activeTherapist=therapists.find(t=>t.id===id);document.getElementById('active-name').innerText=window.activeTherapist.name;document.getElementById('active-avatar').style.backgroundColor=window.activeTherapist.color;document.getElementById('active-avatar').innerHTML=`<i class="fas fa-${window.activeTherapist.icon}"></i>`;const chatId=`${window.clientId}_${id}`;if(db){window.activeChatRef=db.ref(`chats/${chatId}`);window.activeAiStatusRef=db.ref(`ai_status/${chatId}`);window.activeAiStatusRef.on('value',s=>{window.isBotPaused=s.val()?s.val().paused:false;});window.activeChatRef.on('value',(s)=>{let h=s.val();if(!h){h=[{role:"system",content:`${window.getSystemPrompt(id)} Paciente: ${window.clientName}.`}];window.activeChatRef.set(h);}window.refreshChatDisplay(h);if(window.isWaiting&&h[h.length-1].role==='assistant'){document.getElementById('typing-box').classList.add('hidden');window.isWaiting=false;document.getElementById('submit-btn').disabled=false;}});}window.showTab('chat');}
window.refreshChatDisplay=function(h){const mc=document.getElementById('chat-messages');mc.innerHTML='';h.forEach(m=>{if(m.role!=='system'){window.renderMessage(m.content,m.role==='user'?'user':'therapist');}});mc.scrollTop=mc.scrollHeight;}
window.renderMessage=function(t,type){const d=document.createElement('div');d.className=`message ${type}`;d.innerHTML=t;document.getElementById('chat-messages').appendChild(d);}
window.submitChat=async function(t){if(!t||window.isWaiting)return;const chatId=`${window.clientId}_${window.activeTherapist.id}`;document.getElementById('chat-input').value='';window.isWaiting=true;document.getElementById('submit-btn').disabled=true;if(db){const s=await db.ref(`chats/${chatId}`).once('value');let h=s.val()||[];h.push({role:'user',content:t});await db.ref(`chats/${chatId}`).set(h);if(window.isBotPaused){document.getElementById('typing-box').classList.remove('hidden');document.getElementById('typing-box').innerHTML='<i class="fas fa-user-md"></i> O Terapeuta está acompanhando...';return;}const start=Date.now();try{const res=await fetch(window.AI_PROXY_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:h,temperature:0.7,max_tokens:350})});const data=await res.json();const rt=data.choices?data.choices[0].message.content:"Conexão oscilou. Pode repetir?";const wps=130/60;const hiatus=Math.max(0,((Math.max(t.split(/\s+/).length,1)/wps)*1000)-(Date.now()-start));setTimeout(()=>{if(window.isBotPaused)return;document.getElementById('typing-box').innerHTML='Digitando <span class="animate-pulse">...</span>';document.getElementById('typing-box').classList.remove('hidden');setTimeout(async()=>{if(window.isBotPaused)return;h.push({role:'assistant',content:rt});await db.ref(`chats/${chatId}`).set(h);},((Math.max(rt.split(/\s+/).length,1)/wps)*1000));},hiatus);}catch(e){window.isWaiting=false;document.getElementById('submit-btn').disabled=false;}}}
document.getElementById('chat-form').onsubmit=(e)=>{e.preventDefault();window.submitChat(document.getElementById('chat-input').value.trim());};
window.adminStatusRef=null;window.adminChatsRef=null;window.showAdminLogin=function(){window.showTab('admin-login-screen')}
window.attemptAdminLogin=async function(){const u=document.getElementById('admin-user').value.trim();const p=document.getElementById('admin-pass').value.trim();if(!db)return alert("BD Offline");const snap=await db.ref('admin_auth').once('value');if(!snap.exists()){await db.ref('admin_auth').set({user:u,pass:p});alert("Admin Registrado! Guarde seu acesso.");window.initAdminPanel();}else{const val=snap.val();if(val.user===u&&val.pass===p)window.initAdminPanel();else alert("Credenciais Incorretas");}}
window.initAdminPanel=function(){window.showTab('admin-dashboard');if(!window.adminStatusRef){window.adminStatusRef=db.ref('status');window.adminStatusRef.on('value',s=>{window.globalUsersStatus=s.val()||{};if(window.lastAllChats)window.renderAdminDashboard(window.lastAllChats);});}if(!window.adminChatsRef){window.adminChatsRef=db.ref('chats');window.adminChatsRef.on('value',s=>{const allChats=s.val()||{};window.lastAllChats=allChats;window.renderAdminDashboard(allChats);if(window.adminTarget){const tk=`${window.adminTarget.clientId}_${window.adminTarget.therapistId}`;if(allChats[tk])window.refreshAdminChatBox(allChats[tk]);}});}}
window.logoutAdmin=function(){window.showTab('home');}
window.renderAdminDashboard=function(allChats){const l=document.getElementById('admin-chat-list');l.innerHTML='';let arr=[];for(const[k,h]of Object.entries(allChats)){if(h&&h.length>0){const parts=k.split('_');const clientId=`${parts[0]}_${parts[1]}`;const isOnline=window.globalUsersStatus[clientId]?window.globalUsersStatus[clientId].online:false;arr.push({k,clientId,therapistId:parts[2]||parts[1],h,isOnline});}}arr.sort((a,b)=>{if(a.isOnline===b.isOnline)return b.h.length-a.h.length;return a.isOnline?-1:1;});arr.forEach(c=>{const last=c.h.slice().reverse().find(m=>m.role!=='system');const d=document.createElement('div');d.className=`p-3 bg-slate-800 rounded border ${c.isOnline?'border-emerald-500/50':'border-slate-700'} cursor-pointer hover:bg-slate-700`;d.onclick=()=>window.openAdminChat(c.clientId,c.therapistId,c.h);d.innerHTML=`<div class="flex justify-between items-center"><span class="font-bold text-[11px] text-white"><span class="w-2 h-2 rounded-full ${c.isOnline?'bg-emerald-500 animate-pulse':'bg-slate-600'} inline-block mr-1"></span>${c.clientId.replace('_',' ')}</span><span class="text-[9px] text-slate-400">${c.therapistId}</span></div><p class="text-[10px] text-slate-400 mt-1 truncate">${last?last.content:'-'}</p>`;l.appendChild(d);});}
window.openAdminChat=async function(clientId,therapistId,h){window.adminTarget={clientId,therapistId};document.getElementById('admin-target-name').innerText=`${clientId.replace('_',' ')} c/ ${therapistId}`;document.getElementById('ai-toggle-btn').classList.remove('hidden');db.ref(`ai_status/${clientId}_${therapistId}`).on('value',s=>{const p=s.val()?s.val().paused:false;const b=document.getElementById('ai-toggle-btn');b.innerText=p?"IA: PAUSADA":"IA: ATIVA";b.className=`text-[9px] px-2 py-1 rounded ${p?'bg-red-600 animate-pulse':'bg-emerald-600'}`;});window.refreshAdminChatBox(h);const snap=await db.ref('users/'+clientId).once('value');const u=snap.val();if(u){let h=`<div class="mb-4"><b class="text-emerald-400">CADASTRO</b><br>Nome: ${u.fullName}<br>Senha(Nasc): ${u.pass}</div>`;if(u.routines){h+=`<div class="mb-4"><b class="text-sky-400">ROTINAS</b><br>Acordar: ${u.routines.wake||'-'}<br>Água: a cada ${u.routines.water||'-'} min<br>Dormir: ${u.routines.sleep||'-'} (${u.routines.sleepHrs||'-'}h)</div>`;}if(u.cycle){h+=`<div class="mb-4"><b class="text-rose-400">NOTEPAD / CICLO</b><br>Última: ${u.cycle.date||'-'}<br>Notas: ${u.cycle.notes||'Nenhuma nota'}</div>`;}document.getElementById('admin-user-data').innerHTML=h;}else{document.getElementById('admin-user-data').innerHTML='Dados não encontrados.';}}
window.refreshAdminChatBox=function(h){if(!window.adminTarget||!h)return;const p=document.getElementById('admin-chat-preview');p.innerHTML=h.filter(m=>m.role!=='system').map(m=>`<div class="mb-2"><b class="${m.role==='user'?'text-sky-400':'text-emerald-400'}">${m.role==='user'?'Paciente':'Terapeuta/IA'}:</b> ${m.content}</div>`).join('');p.scrollTop=p.scrollHeight;}
window.toggleAiStatus=function(){const tk=`${window.adminTarget.clientId}_${window.adminTarget.therapistId}`;db.ref(`ai_status/${tk}`).once('value').then(s=>{db.ref(`ai_status/${tk}`).set({paused:!(s.val()&&s.val().paused)});});}
window.sendAdminReply=async function(){const i=document.getElementById('admin-reply-input');const txt=i.value.trim();if(!txt||!window.adminTarget)return;const tk=`${window.adminTarget.clientId}_${window.adminTarget.therapistId}`;i.value='...';const snap=await db.ref(`chats/${tk}`).once('value');let h=snap.val()||[];h.push({role:'assistant',content:txt});await db.ref(`chats/${tk}`).set(h);await db.ref(`ai_status/${tk}`).set({paused:true});i.value='';}</script></body></html>
