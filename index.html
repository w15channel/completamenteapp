<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonia Di√°ria - WR TERAPIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Quicksand:wght@400;600&display=swap');

        :root {
            --primary: #0ea5e9;
            --text: #334155;
            --bg-grad-1: #f0f9ff;
            --bg-grad-2: #e0f2fe;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(255, 255, 255, 0.6);
            --msg-therapist: #ffffff;
        }
        body.dark-mode {
            --text: #dbeafe;
            --bg-grad-1: #0f172a;
            --bg-grad-2: #1e293b;
            --glass-bg: rgba(15, 23, 42, 0.88);
            --glass-border: rgba(71, 85, 105, 0.4);
            --msg-therapist: #1e293b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-grad-1) 0%, var(--bg-grad-2) 100%);
            min-height: 100vh;
            color: var(--text);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }
        .heading-font { font-family: 'Quicksand', sans-serif; }
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.08);
        }
        .tab-content { display: none; opacity: 0; transform: translateY(8px); transition: all 0.3s ease; }
        .tab-content.active { display: block; opacity: 1; transform: translateY(0); }

        .chat-container { height: calc(100vh - 380px); overflow-y: auto; }
        .message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 1rem;
            font-size: 0.9rem;
            line-height: 1.35;
            margin-bottom: 10px;
            word-break: break-word;
            overflow-wrap: anywhere;
        }
        .message.user { align-self: flex-end; background: var(--primary); color: #fff; border-bottom-right-radius: 0.2rem; margin-left: auto; }
        .message.therapist { align-self: flex-start; background: var(--msg-therapist); color: var(--text); border-bottom-left-radius: 0.2rem; margin-right: auto; }
        .message.system { align-self: center; background: #fef3c7; color: #92400e; border-radius: 0.75rem; font-size: 0.78rem; max-width: 100%; }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .status-online { background-color: #10b981; box-shadow: 0 0 5px #10b981; }
        .status-busy { background-color: #f59e0b; box-shadow: 0 0 5px #f59e0b; }
        .status-offline { background-color: #94a3b8; }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        .mic-active { background-color: #ef4444 !important; color: #fff !important; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239,68,68,.7);} 70% { box-shadow: 0 0 0 10px rgba(239,68,68,0);} 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0);} }

        .mini-select {
            border: 1px solid #fde68a;
            background: #fffbeb;
            border-radius: .8rem;
            font-size: .72rem;
            font-weight: 700;
            letter-spacing: .03em;
            color: #b45309;
            width: 100%;
            padding: .65rem .7rem;
            text-transform: uppercase;
        }

        .theme-toggle {
            width: 38px;
            height: 38px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, .3);
            background: rgba(255,255,255,.55);
            color: #0f172a;
        }
        body.dark-mode .theme-toggle { background: rgba(15,23,42,.8); color: #f8fafc; }
        body.dark-mode .soft-text, body.dark-mode .title-dark { color: #cbd5e1 !important; }
        body.dark-mode .bg-white, body.dark-mode .bg-white\/80, body.dark-mode .bg-white\/50 { background-color: rgba(30, 41, 59, 0.85) !important; color: #e2e8f0; }

        .game-target { width: 54px; height: 54px; border-radius: 999px; position: absolute; cursor: pointer; }
    </style>
</head>
<body class="pb-24">

    <header class="p-5 text-center sticky top-0 z-10 bg-white/30 backdrop-blur-md border-b border-white/20">
        <div class="max-w-md mx-auto flex items-center justify-between">
            <div class="text-left">
                <h1 class="text-2xl font-bold text-sky-800 heading-font">Harmonia Di√°ria</h1>
                <p class="text-sky-600 text-[10px] uppercase tracking-[0.2em] font-bold mt-1">WR TERAPIA</p>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema"><i id="theme-icon" class="fas fa-moon"></i></button>
        </div>
    </header>

    <main class="max-w-md mx-auto px-4 pt-4">
        <section id="onboarding" class="tab-content active">
            <div class="glass-card p-8 text-center flex flex-col items-center justify-center min-h-[450px]">
                <div class="w-20 h-20 bg-sky-100 rounded-full flex items-center justify-center mb-6"><i class="fas fa-fingerprint text-sky-500 text-3xl"></i></div>
                <h2 class="text-2xl font-bold text-sky-900 mb-2 heading-font">Bem-vindo(a)</h2>
                <p class="text-sm text-gray-500 mb-8 soft-text">Identifique-se para acessar seu espa√ßo.</p>
                <div class="w-full mb-4">
                    <select id="user-gender" class="w-full p-4 mb-3 rounded-2xl border border-sky-100 bg-white/80 text-sm outline-none focus:ring-2 focus:ring-sky-200">
                        <option value="homem">Sou Homem</option>
                        <option value="mulher">Sou Mulher</option>
                    </select>
                    <input type="text" id="user-name-input" oninput="this.value = this.value.toUpperCase()" placeholder="SEU NOME" class="w-full p-4 rounded-2xl border border-sky-100 bg-white/80 text-center uppercase font-bold text-sky-900 outline-none focus:ring-2 focus:ring-sky-200">
                </div>
                <button onclick="login()" class="w-full bg-sky-500 text-white py-4 rounded-2xl font-bold shadow-lg mt-2 hover:bg-sky-600 transition-all">Entrar</button>
            </div>
        </section>

        <section id="home" class="tab-content">
            <div class="glass-card p-6 mb-4">
                <p class="text-xs text-gray-400">Ol√°,</p>
                <h2 class="text-xl font-bold text-gray-800 heading-font mb-6 client-name">Visitante</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="openChatSelection()" class="p-5 bg-white/80 rounded-2xl border border-sky-50 flex flex-col items-center gap-3 hover:bg-sky-50 shadow-sm"><i class="fas fa-comment-medical text-2xl text-sky-500"></i><span class="text-[10px] font-bold uppercase">Conversar</span></button>
                    <button onclick="showTab('agenda')" class="p-5 bg-white/80 rounded-2xl border border-emerald-50 flex flex-col items-center gap-3 hover:bg-emerald-50 shadow-sm"><i class="fas fa-calendar-check text-2xl text-emerald-500"></i><span class="text-[10px] font-bold uppercase">Agendar</span></button>
                    <button onclick="showTab('moral')" class="p-5 bg-white/80 rounded-2xl border border-blue-50 flex flex-col items-center gap-3 hover:bg-blue-50 shadow-sm"><i class="fas fa-feather text-2xl text-blue-500"></i><span class="text-[10px] font-bold uppercase">Moral das Palavras</span></button>
                    <button onclick="showTab('hope')" class="p-5 bg-white/80 rounded-2xl border border-amber-50 flex flex-col items-center gap-3 hover:bg-amber-50 shadow-sm"><i class="fas fa-lightbulb text-2xl text-amber-500"></i><span class="text-[10px] font-bold uppercase">Caixinha IA</span></button>
                </div>
                <button onclick="showTab('regulacao')" class="w-full mt-4 p-4 bg-purple-50 rounded-2xl border border-purple-100 flex items-center justify-center gap-3 hover:bg-purple-100 shadow-sm"><i class="fas fa-gamepad text-purple-500"></i><span class="text-[10px] font-bold uppercase text-purple-700">Regula√ß√£o Divertida</span></button>
            </div>
        </section>

        <section id="agenda" class="tab-content">
            <div class="glass-card p-6 h-[75vh] flex flex-col">
                <div class="flex items-center gap-2 mb-4"><button onclick="showTab('home')"><i class="fas fa-arrow-left text-gray-500"></i></button><h2 class="font-bold text-sky-900 heading-font">Agendamento Autom√°tico</h2></div>
                <div class="flex-1 rounded-xl overflow-hidden border border-sky-100"><iframe src="https://calendly.com/wrterapia/atendimentos" width="100%" height="100%" frameborder="0"></iframe></div>
            </div>
        </section>

        <section id="chat-selection" class="tab-content">
            <div class="glass-card p-6">
                <h2 class="text-lg font-bold text-sky-900 mb-4 text-center">Nossa Equipe</h2>
                <div id="therapist-list" class="space-y-3"></div>
                <button onclick="showTab('home')" class="mt-6 w-full text-xs text-gray-400 font-bold uppercase">Voltar</button>
            </div>
        </section>

        <section id="chat" class="tab-content">
            <div class="glass-card flex flex-col h-[75vh]">
                <div class="p-4 border-b border-gray-100 flex items-center gap-3 bg-white/40">
                    <div id="active-avatar" class="w-10 h-10 rounded-full flex items-center justify-center text-white"></div>
                    <div class="flex-1">
                        <p id="active-name" class="font-bold text-gray-800 text-sm"></p>
                        <div class="flex items-center"><span id="active-status-dot" class="status-dot"></span><span id="active-status-text" class="text-[9px] uppercase font-bold text-gray-400">Status</span></div>
                    </div>
                    <button onclick="openChatSelection()" class="text-gray-400"><i class="fas fa-times"></i></button>
                </div>
                <div id="chat-messages" class="chat-container p-4 flex flex-col"></div>
                <div id="typing-box" class="px-4 hidden text-xs text-sky-500 italic mb-2 font-medium">Digitando...</div>
                <div class="p-4 bg-white/50 rounded-b-[1.5rem] border-t border-sky-50">
                    <form id="chat-form" class="flex items-center gap-2">
                        <button type="button" id="mic-btn" onclick="toggleMic()" class="w-10 h-10 bg-gray-100 rounded-full text-gray-500"><i class="fas fa-microphone"></i></button>
                        <input type="text" id="chat-input" placeholder="Digite aqui..." class="flex-1 bg-white border border-gray-200 rounded-full px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-sky-400">
                        <button type="submit" class="w-10 h-10 bg-sky-500 text-white rounded-full shadow-md"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>
        </section>

        <section id="moral" class="tab-content">
            <div class="glass-card p-5">
                <div class="flex items-center gap-2 mb-4"><button onclick="showTab('home')"><i class="fas fa-arrow-left text-gray-500"></i></button><h2 class="font-bold text-sky-900">Moral das Palavras</h2></div>
                <p class="text-xs text-gray-500 mb-3">Deixe um conselho an√¥nimo para ajudar outras pessoas.</p>
                <textarea id="moral-input" placeholder="Escreva aqui uma boa palavra ou conselho..." class="w-full p-4 rounded-xl border border-sky-100 h-28 resize-none text-sm bg-white/60 mb-3"></textarea>
                <button onclick="saveMoral()" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold">Publicar An√¥nimo</button>
                <div id="moral-list" class="mt-5 space-y-2 max-h-72 overflow-y-auto"></div>
            </div>
        </section>

        <section id="regulacao" class="tab-content">
            <div class="glass-card p-5">
                <div class="flex items-center gap-2 mb-4"><button onclick="showTab('home')"><i class="fas fa-arrow-left text-gray-500"></i></button><h2 class="font-bold text-sky-900">Regula√ß√£o Divertida</h2></div>
                <p class="text-xs text-gray-500 mb-3">Clique nas bolinhas para aliviar o estresse em 20 segundos.</p>
                <div class="flex justify-between mb-3 text-xs font-bold">
                    <span>Pontos: <span id="game-score">0</span></span>
                    <span>Tempo: <span id="game-time">20</span>s</span>
                </div>
                <button onclick="startGame()" class="w-full bg-purple-500 text-white py-3 rounded-xl font-bold mb-3">Iniciar Jogo</button>
                <div id="game-area" class="relative bg-white/70 border border-purple-100 rounded-xl h-64 overflow-hidden"></div>
            </div>
        </section>

        <section id="hope" class="tab-content">
            <div class="glass-card p-6 text-center min-h-[450px] flex flex-col justify-center relative">
                <div class="flex justify-between items-center absolute top-4 left-4 right-4">
                    <button onclick="showTab('home')"><i class="fas fa-arrow-left text-gray-400"></i></button>
                    <span class="text-[10px] uppercase font-bold text-amber-500 tracking-widest">Caixinha M√°gica</span>
                </div>
                <div id="hope-start">
                    <div class="w-20 h-20 bg-amber-50 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-gift text-amber-400 text-3xl"></i></div>
                    <h2 class="text-xl font-bold text-gray-800 mb-2 title-dark">Uma dose de encorajamento</h2>
                    <p class="text-xs text-gray-500 mb-6 soft-text">Gere uma imagem bonita + uma mensagem para fortalecer seu dia.</p>
                    <button onclick="generateHopeGemini()" class="w-full bg-amber-500 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-amber-600">Gerar Mensagem de Esperan√ßa</button>
                </div>
                <div id="hope-loading" class="hidden">
                    <div class="loader mx-auto mb-4 border-t-amber-500"></div>
                    <p class="text-[10px] text-amber-500 uppercase font-bold tracking-widest animate-pulse">Gerando seu momento...</p>
                </div>
                <div id="hope-result" class="hidden w-full flex-col items-center">
                    <div class="grid grid-cols-2 gap-2 mb-3 w-full">
                        <select id="hope-theme" class="mini-select">
                            <option value="natureza">Natureza</option>
                            <option value="oceano">Oceano</option>
                            <option value="montanhas">Montanhas</option>
                            <option value="flores">Flores</option>
                        </select>
                        <select id="hope-style" class="mini-select">
                            <option value="fotografia">Fotografia</option>
                            <option value="aquarela">Aquarela</option>
                            <option value="cinematica">Cinem√°tica</option>
                            <option value="pintura">Pintura</option>
                        </select>
                    </div>
                    <div class="relative w-full rounded-xl overflow-hidden shadow-lg mb-4"><img id="hope-img" src="" class="w-full h-56 object-cover bg-gray-200" onerror="handleImageError(this)"></div>
                    <div class="bg-white/80 p-5 rounded-xl border border-amber-100 shadow-sm w-full"><p id="hope-msg" class="text-sm italic text-gray-700 font-medium leading-relaxed"></p></div>
                    <div class="mt-6 flex items-center gap-4 justify-center">
                        <button onclick="generateHopeGemini()" class="text-xs text-amber-600 font-bold uppercase tracking-wide hover:underline">Gerar Outra</button>
                        <button onclick="downloadHopeImage()" class="text-xs text-sky-600 font-bold uppercase tracking-wide hover:underline">Baixar Imagem</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <nav class="fixed bottom-0 w-full bg-white/95 backdrop-blur-md border-t border-gray-100 py-3 flex justify-around z-50">
        <button onclick="showTab('home')" class="text-sky-500 flex flex-col items-center gap-1"><i class="fas fa-home"></i><span class="text-[9px] font-bold tracking-widest">IN√çCIO</span></button>
        <button onclick="openChatSelection()" class="text-gray-400 flex flex-col items-center gap-1"><i class="fas fa-comment"></i><span class="text-[9px] font-bold tracking-widest">CHAT</span></button>
    </nav>

    <script>
        const GROQ_API_KEY = "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";
        const GEMINI_API_KEY = "AIzaSyDeJ4tLe98pPnfRXRoWTsGM5uc_HAlhsnE";

        let clientName = "Visitante";
        let clientGender = "homem";
        let chatHistory = [];
        let isWaiting = false;
        let messageCounter = 0;
        let hopeImageSrc = "";
        let activeTherapist = null;
        let gameTimer = null;
        let gameSpawner = null;

        const offlineResponses = {
            lia: ["Respire fundo, querida(o). Estou com voc√™.", "Voc√™ n√£o est√° sozinha(o), vamos um passo por vez."],
            william: ["Vamos simplificar: qual √© o problema principal agora?", "Escolha um pr√≥ximo passo pequeno e execute hoje."],
            yara: ["No sil√™ncio, seu cora√ß√£o encontra dire√ß√£o.", "Permita-se desacelerar e acolher a pr√≥pria noite."],
            fer: ["A agenda autom√°tica est√° na tela inicial; posso te orientar por aqui."],
            generico: ["Estou aqui com voc√™."]
        };

        const hopeFallback = [
            "Voc√™ j√° superou dias dif√≠ceis antes. Hoje tamb√©m vai passar.",
            "Um passo de cada vez tamb√©m √© avan√ßo. Voc√™ est√° indo bem.",
            "Respire fundo: dentro de voc√™ existe mais for√ßa do que imagina."
        ];

        const therapists = [
            { id: 'lia', name: 'Dra. Lia', color: '#f472b6', icon: 'heart' },
            { id: 'william', name: 'Dr. William', color: '#0ea5e9', icon: 'user-tie' },
            { id: 'yara', name: 'Dra. Yara', color: '#6366f1', icon: 'moon' },
            { id: 'fer', name: 'Fernanda', color: '#10b981', icon: 'headset' }
        ];

        function truncateText(text, max = 220) {
            if (!text) return "";
            const clean = String(text).replace(/\s+/g, ' ').trim();
            return clean.length > max ? `${clean.slice(0, max)}...` : clean;
        }

        function safeTimeout(ms, promise) {
            return Promise.race([
                promise,
                new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), ms))
            ]);
        }

        function getSystemPrompt(therapistId) {
            const tratamento = clientGender === "homem" ? "querido" : "querida";
            return {
                lia: `Voc√™ √© a Dra. Lia. Chame o paciente de '${tratamento}'. Responda em no m√°ximo 2 frases curtas e acolhedoras.`,
                william: `Voc√™ √© Dr. William. Seja objetivo e pr√°tico. No m√°ximo 2 frases curtas.`,
                yara: `Voc√™ √© Dra. Yara. Seja serena e po√©tica em no m√°ximo 2 frases curtas.`,
                fer: `Voc√™ √© Fernanda, secret√°ria. Explique com simpatia em no m√°ximo 2 frases curtas.`
            }[therapistId] || "Responda de forma breve.";
        }

        function login() {
            const name = document.getElementById('user-name-input').value.trim();
            clientGender = document.getElementById('user-gender').value;
            if (!name) return alert('Por favor, digite seu nome.');
            clientName = name;
            document.querySelectorAll('.client-name').forEach(el => el.textContent = clientName);
            loadMorais();
            showTab('home');
        }

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'moral') loadMorais();
        }

        function checkAvailability() {
            const hour = new Date().getHours();
            const isNight = (hour >= 22 || hour < 6);
            return therapists.map(t => {
                let status = 'online';
                let label = 'Online';
                if (isNight && t.id !== 'yara') { status = 'offline'; label = 'Offline'; }
                if (!isNight && t.id === 'yara') { status = 'offline'; label = 'Offline'; }
                if (!isNight && t.id === 'william') { status = 'busy'; label = 'Ocupado'; }
                return { ...t, status, label };
            });
        }

        function openChatSelection() {
            const list = document.getElementById('therapist-list');
            list.innerHTML = '';
            checkAvailability().forEach(t => {
                const card = document.createElement('div');
                card.className = `flex items-center gap-4 p-4 bg-white rounded-xl border border-gray-100 shadow-sm ${t.status === 'offline' ? 'opacity-50 grayscale' : 'cursor-pointer hover:bg-sky-50'}`;
                if (t.status !== 'offline') card.onclick = () => startChat(t.id);
                card.innerHTML = `<div class="w-10 h-10 rounded-full flex items-center justify-center text-white" style="background:${t.color}"><i class="fas fa-${t.icon}"></i></div><div class="flex-1"><span class="font-bold text-sm text-gray-700">${t.name}</span><div><span class="status-dot status-${t.status}"></span><span class="text-[8px] uppercase font-bold text-gray-400">${t.label}</span></div></div>`;
                list.appendChild(card);
            });
            showTab('chat-selection');
        }

        function startChat(id) {
            activeTherapist = therapists.find(t => t.id === id);
            const availability = checkAvailability().find(t => t.id === id);
            document.getElementById('active-name').textContent = activeTherapist.name;
            document.getElementById('active-avatar').style.backgroundColor = activeTherapist.color;
            document.getElementById('active-avatar').innerHTML = `<i class="fas fa-${activeTherapist.icon}"></i>`;
            document.getElementById('active-status-dot').className = `status-dot status-${availability.status}`;
            document.getElementById('active-status-text').textContent = availability.label;
            document.getElementById('chat-messages').innerHTML = '';
            chatHistory = [{ role: 'system', content: `${getSystemPrompt(id)} Paciente: ${clientName}.` }];
            addMessage(id === 'william' ? 'Dr. William pode responder com pequena demora enquanto atende.' : `Ol√° ${clientName}, como posso ajudar hoje?`, id === 'william' ? 'system' : 'therapist', false);
            showTab('chat');
        }

        function addMessage(text, type, saveToHistory = true) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = truncateText(text, type === 'therapist' ? 220 : 260);
            document.getElementById('chat-messages').appendChild(div);
            document.getElementById('chat-messages').scrollTop = 99999;
            if (saveToHistory && type !== 'system') chatHistory.push({ role: type === 'user' ? 'user' : 'assistant', content: truncateText(text, 220) });
        }

        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text || isWaiting || !activeTherapist) return;
            addMessage(text, 'user');
            input.value = '';
            isWaiting = true;
            document.getElementById('typing-box').classList.remove('hidden');

            try {
                const data = await safeTimeout(12000, fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${GROQ_API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: 'llama-3.3-70b-versatile', messages: chatHistory, temperature: 0.6, max_tokens: 85 })
                }).then(r => r.json()));

                const resposta = data?.choices?.[0]?.message?.content || offlineResponses[activeTherapist.id]?.[0] || offlineResponses.generico[0];
                addMessage(resposta, 'therapist');
            } catch {
                const responses = offlineResponses[activeTherapist.id] || offlineResponses.generico;
                addMessage(responses[Math.floor(Math.random() * responses.length)], 'therapist');
            } finally {
                document.getElementById('typing-box').classList.add('hidden');
                isWaiting = false;
            }
        };

        async function generateHopeGemini() {
            if (isWaiting) return;
            isWaiting = true;
            document.getElementById('hope-start').classList.add('hidden');
            document.getElementById('hope-result').classList.add('hidden');
            document.getElementById('hope-loading').classList.remove('hidden');

            const theme = document.getElementById('hope-theme')?.value || 'natureza';
            const style = document.getElementById('hope-style')?.value || 'fotografia';
            const themeMap = {
                natureza: 'paisagem de natureza serena com luz suave',
                oceano: 'oceano calmo com ondas leves ao p√¥r do sol',
                montanhas: 'montanhas tranquilas com neblina leve',
                flores: 'campo de flores delicadas com atmosfera acolhedora'
            };
            const styleMap = {
                fotografia: 'professional photography, high detail',
                aquarela: 'watercolor style, soft brush, pastel',
                cinematica: 'cinematic composition, volumetric light',
                pintura: 'digital painting, dreamy texture'
            };

            let frase = hopeFallback[Math.floor(Math.random() * hopeFallback.length)];

            try {
                const textReq = safeTimeout(9000, fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Escreva uma frase curta de encorajamento em portugu√™s. Tema: ${theme}. Responda s√≥ a frase.` }] }] })
                }).then(r => r.json()));

                const imageReq = safeTimeout(9000, fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instances: [{ prompt: `${themeMap[theme]}, ${styleMap[style]}, peaceful, hopeful` }], parameters: { sampleCount: 1 } })
                }).then(r => r.json()));

                const [textRes, imageRes] = await Promise.allSettled([textReq, imageReq]);

                if (textRes.status === 'fulfilled') {
                    frase = truncateText(textRes.value?.candidates?.[0]?.content?.parts?.[0]?.text || frase, 180);
                }
                if (imageRes.status === 'fulfilled' && imageRes.value?.predictions?.[0]?.bytesBase64Encoded) {
                    hopeImageSrc = `data:image/png;base64,${imageRes.value.predictions[0].bytesBase64Encoded}`;
                    document.getElementById('hope-img').src = hopeImageSrc;
                } else {
                    handleImageError(document.getElementById('hope-img'));
                }
            } catch {
                handleImageError(document.getElementById('hope-img'));
            }

            document.getElementById('hope-msg').textContent = frase;
            document.getElementById('hope-loading').classList.add('hidden');
            document.getElementById('hope-result').classList.remove('hidden');
            document.getElementById('hope-result').style.display = 'flex';
            isWaiting = false;
        }

        function handleImageError(img) {
            const fallbackImages = {
                natureza: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=900&q=80',
                oceano: 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=900&q=80',
                montanhas: 'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?auto=format&fit=crop&w=900&q=80',
                flores: 'https://images.unsplash.com/photo-1490750967868-88aa4486c946?auto=format&fit=crop&w=900&q=80'
            };
            const theme = document.getElementById('hope-theme')?.value || 'natureza';
            hopeImageSrc = `${fallbackImages[theme]}&sig=${Math.random()}`;
            img.src = hopeImageSrc;
        }

        function downloadHopeImage() {
            if (!hopeImageSrc) return;
            const link = document.createElement('a');
            link.href = hopeImageSrc;
            link.download = `encorajamento-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            link.remove();
        }

        function saveMoral() {
            const input = document.getElementById('moral-input');
            const text = truncateText(input.value, 280);
            if (!text) return;
            const items = JSON.parse(localStorage.getItem('moral_wall') || '[]');
            items.unshift({ date: new Date().toLocaleString('pt-BR'), text });
            localStorage.setItem('moral_wall', JSON.stringify(items.slice(0, 80)));
            input.value = '';
            loadMorais();
        }

        function loadMorais() {
            const items = JSON.parse(localStorage.getItem('moral_wall') || '[]');
            const list = document.getElementById('moral-list');
            list.innerHTML = items.length
                ? items.map(i => `<div class="bg-white p-3 rounded-lg border text-xs"><b>An√¥nimo ‚Ä¢ ${i.date}</b><p class="mt-1">${i.text}</p></div>`).join('')
                : '<p class="text-xs text-gray-400">Ainda n√£o h√° mensagens. Seja o primeiro a deixar um conselho üíô</p>';
        }

        function startGame() {
            const area = document.getElementById('game-area');
            let score = 0;
            let time = 20;
            document.getElementById('game-score').textContent = score;
            document.getElementById('game-time').textContent = time;
            area.innerHTML = '';
            clearInterval(gameTimer);
            clearInterval(gameSpawner);

            gameSpawner = setInterval(() => {
                const ball = document.createElement('button');
                ball.className = 'game-target';
                ball.style.left = `${Math.random() * (area.clientWidth - 54)}px`;
                ball.style.top = `${Math.random() * (area.clientHeight - 54)}px`;
                ball.style.background = `hsl(${Math.random() * 360}, 85%, 65%)`;
                ball.onclick = () => { score++; document.getElementById('game-score').textContent = score; ball.remove(); };
                area.appendChild(ball);
                setTimeout(() => ball.remove(), 900);
            }, 420);

            gameTimer = setInterval(() => {
                time--;
                document.getElementById('game-time').textContent = time;
                if (time <= 0) {
                    clearInterval(gameTimer);
                    clearInterval(gameSpawner);
                    alert(`Fim! Voc√™ marcou ${score} pontos. √ìtimo para descarregar o estresse!`);
                }
            }, 1000);
        }

        function toggleTheme() {
            const dark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme_mode', dark ? 'dark' : 'light');
            document.getElementById('theme-icon').className = dark ? 'fas fa-sun' : 'fas fa-moon';
        }

        (function initTheme() {
            const saved = localStorage.getItem('theme_mode');
            if (saved === 'dark') document.body.classList.add('dark-mode');
            document.getElementById('theme-icon').className = document.body.classList.contains('dark-mode') ? 'fas fa-sun' : 'fas fa-moon';
        })();

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const rec = new SpeechRecognition();
            rec.lang = 'pt-BR';
            rec.onresult = e => { document.getElementById('chat-input').value = e.results[0][0].transcript; toggleMic(); };
            window.toggleMic = () => {
                const btn = document.getElementById('mic-btn');
                if (btn.classList.contains('mic-active')) { rec.stop(); btn.classList.remove('mic-active'); }
                else { rec.start(); btn.classList.add('mic-active'); }
            };
        } else {
            window.toggleMic = () => {};
        }
    </script>
</body>
</html>
