<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Espa√ßo Terapia ‚Ä¢ Ecossistema de Intelig√™ncia de Vida</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; }
    body { background: radial-gradient(circle at top, #1e293b, #020617 60%); }
    .glass { background: rgba(15,23,42,0.78); border: 1px solid rgba(148,163,184,.25); backdrop-filter: blur(8px); }
    .sector-dot { width: 12px; height: 12px; border-radius: 9999px; display: inline-block; }
  </style>
</head>
<body class="text-slate-100 min-h-screen pb-24">
  <header class="sticky top-0 z-30 border-b border-slate-700/80 bg-slate-950/85 backdrop-blur">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div>
        <h1 class="text-xl md:text-2xl font-bold">Espa√ßo Terapia</h1>
        <p class="text-xs md:text-sm text-slate-300">Deep Wellness com IA Serena, dados locais e vis√£o sist√™mica.</p>
      </div>
      <button id="resetCycleBtn" class="px-3 py-2 text-xs rounded-lg bg-rose-600 hover:bg-rose-500 font-semibold">Novo ciclo di√°rio</button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-5 space-y-5">
    <section class="grid lg:grid-cols-3 gap-4">
      <article class="glass rounded-2xl p-4 lg:col-span-2">
        <div class="flex items-start justify-between gap-2">
          <div>
            <h2 class="text-lg font-semibold">1) Mapa Sist√™mico Progressivo</h2>
            <p class="text-sm text-slate-300">Pontua√ß√£o em tempo real dos 7 setores vitais. Reinicia a cada ciclo para incentivar const√¢ncia.</p>
          </div>
          <span id="balanceBadge" class="text-xs font-semibold px-2 py-1 rounded-full bg-emerald-600">Equil√≠brio 0%</span>
        </div>
        <div id="radarLike" class="mt-4 grid sm:grid-cols-2 gap-3"></div>
      </article>

      <article class="glass rounded-2xl p-4">
        <h2 class="text-lg font-semibold">2) Atendimento Serena (IA Terap√™utica)</h2>
        <p class="text-sm text-slate-300 mt-1">Converse naturalmente para atualizar hidrata√ß√£o, exerc√≠cio, finan√ßas e humor sem formul√°rios.</p>
        <div id="serenaChat" class="mt-3 h-56 overflow-auto space-y-2 text-sm"></div>
        <div class="mt-3 flex gap-2">
          <input id="serenaInput" class="w-full rounded-lg bg-slate-800 border border-slate-600 px-3 py-2 text-sm" placeholder="Ex: Hoje bebi 2L de √°gua e caminhei 35 min" />
          <button id="serenaSend" class="px-4 rounded-lg bg-cyan-600 hover:bg-cyan-500 text-sm font-semibold">Enviar</button>
        </div>
      </article>
    </section>

    <section class="glass rounded-2xl p-4">
      <h2 class="text-lg font-semibold">3) Os 7 Setores de Sa√∫de</h2>
      <p class="text-sm text-slate-300">Ecossistema completo: f√≠sico, mental, relacional, profissional, financeiro, intelectual e espiritual.</p>
      <div id="sectorsGrid" class="mt-4 grid md:grid-cols-2 xl:grid-cols-3 gap-3"></div>
    </section>

    <section class="grid xl:grid-cols-3 gap-4">
      <article class="glass rounded-2xl p-4">
        <h3 class="font-semibold">4) Caixinha Surpresa</h3>
        <p class="text-sm text-slate-300">Mensagem inspiradora + paisagem relaxante sob demanda.</p>
        <button id="surpriseBtn" class="mt-3 px-3 py-2 rounded-lg bg-violet-600 hover:bg-violet-500 text-sm font-semibold">Gerar recompensa emocional</button>
        <p id="surpriseText" class="mt-3 text-sm leading-relaxed text-violet-100"></p>
        <img id="surpriseImage" class="mt-2 hidden rounded-xl w-full h-40 object-cover" alt="Paisagem relaxante" />
      </article>

      <article class="glass rounded-2xl p-4">
        <h3 class="font-semibold">Atmosfera (Music Player)</h3>
        <p class="text-sm text-slate-300">Lo-fi / Medita√ß√£o para estado de fluxo durante a navega√ß√£o.</p>
        <select id="musicSelect" class="mt-3 w-full rounded-lg bg-slate-800 border border-slate-600 px-3 py-2 text-sm"></select>
        <audio id="musicPlayer" class="mt-3 w-full" controls loop></audio>
      </article>

      <article class="glass rounded-2xl p-4">
        <h3 class="font-semibold">Gerador de Estrutura (CSV)</h3>
        <p class="text-sm text-slate-300">Exporte seus dados com soberania total para an√°lises externas.</p>
        <button id="exportBtn" class="mt-3 px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-sm font-semibold">Exportar CSV</button>
        <pre id="executiveSummary" class="mt-3 text-xs text-slate-200 whitespace-pre-wrap"></pre>
      </article>
    </section>
  </main>

  <script>
    const STORAGE_KEY = 'espacoTerapiaState.v2';
    const today = new Date().toISOString().slice(0, 10);

    const sectorsMeta = {
      fisica: { title: 'A. Sa√∫de F√≠sica', focus: 'Biometria e ritmo biol√≥gico', tools: ['Hidrata√ß√£o', 'Atividades f√≠sicas', 'Cronobiologia alimentar'], color: 'bg-sky-500' },
      mental: { title: 'B. Sa√∫de Mental', focus: 'Estabilidade emocional', tools: ['Logs emocionais', 'Chat de acolhimento'], color: 'bg-fuchsia-500' },
      relacional: { title: 'C. Sa√∫de Relacional', focus: 'Sincronia biol√≥gica e apoio interpessoal', tools: ['Ciclo menstrual', 'C√≥digo de acesso do parceiro'], color: 'bg-rose-500' },
      profissional: { title: 'D. Sa√∫de Profissional', focus: 'Miss√£o e equil√≠brio trabalho-vida', tools: ['Carga hor√°ria', 'Side Hustles', 'An√°lise de mercado IA'], color: 'bg-amber-500' },
      financeira: { title: 'E. Sa√∫de Financeira', focus: 'Prosperidade e fluxo de caixa', tools: ['Ativos e passivos', 'Saldo real', 'Gr√°fico mensal'], color: 'bg-emerald-500' },
      intelectual: { title: 'F. Sa√∫de Intelectual', focus: 'Expans√£o do conhecimento', tools: ['Logs de estudo', 'Progresso'], color: 'bg-indigo-500' },
      espiritual: { title: 'G. Sa√∫de Espiritual', focus: 'Paz interior e prop√≥sito', tools: ['H√°bitos espirituais', 'XP e ins√≠gnias'], color: 'bg-purple-500' }
    };

    const initialData = {
      cycleDate: today,
      hydrationMl: 0,
      exerciseMin: 0,
      mood: 50,
      cycle: { day: 1, phase: 'Fluxo', partnerCode: '' },
      workHours: 0,
      sideHustles: 0,
      salaryHint: '',
      finance: { assets: 0, liabilities: 0 },
      studyLogs: 0,
      spiritualXp: 0,
      badges: [],
      emotionalLog: '',
      sectors: Object.fromEntries(Object.keys(sectorsMeta).map(k => [k, 0]))
    };

    const state = loadState();

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return structuredClone(initialData);
      const parsed = JSON.parse(raw);
      if (parsed.cycleDate !== today) {
        return { ...structuredClone(initialData), badges: parsed.badges || [] };
      }
      return { ...structuredClone(initialData), ...parsed, sectors: { ...initialData.sectors, ...(parsed.sectors || {}) } };
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function pct(v) { return Math.max(0, Math.min(100, Math.round(v))); }

    function recomputeScores() {
      state.sectors.fisica = pct((state.hydrationMl / 2000) * 45 + (state.exerciseMin / 45) * 45 + (state.mood / 100) * 10);
      state.sectors.mental = pct((state.mood * 0.7) + (state.emotionalLog.length > 20 ? 30 : 5));
      state.sectors.relacional = pct((state.cycle.partnerCode ? 45 : 15) + ((state.cycle.day % 28) / 28) * 55);
      state.sectors.profissional = pct((state.workHours / 8) * 60 + state.sideHustles * 20 + (state.salaryHint ? 20 : 0));
      const saldo = state.finance.assets - state.finance.liabilities;
      state.sectors.financeira = pct((saldo > 0 ? 60 : 20) + Math.min(40, Math.abs(saldo) / 100));
      state.sectors.intelectual = pct(state.studyLogs * 18);
      state.sectors.espiritual = pct(state.spiritualXp);
      if (state.spiritualXp >= 100 && !state.badges.includes('Guardi√£o Interior')) {
        state.badges.push('Guardi√£o Interior');
      }
    }

    function renderDashboard() {
      recomputeScores();
      const radarLike = document.getElementById('radarLike');
      radarLike.innerHTML = '';
      Object.entries(state.sectors).forEach(([key, value]) => {
        const meta = sectorsMeta[key];
        const card = document.createElement('div');
        card.className = 'rounded-xl border border-slate-700 p-3 bg-slate-900/70';
        card.innerHTML = `
          <div class="flex justify-between items-center text-sm mb-1">
            <span class="font-medium flex items-center gap-2"><span class="sector-dot ${meta.color}"></span>${meta.title}</span>
            <span>${value}%</span>
          </div>
          <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
            <div class="h-full ${meta.color}" style="width:${value}%"></div>
          </div>
          <p class="text-xs text-slate-400 mt-2">${meta.focus}</p>
        `;
        radarLike.appendChild(card);
      });

      const avg = pct(Object.values(state.sectors).reduce((a, b) => a + b, 0) / 7);
      const badge = document.getElementById('balanceBadge');
      badge.textContent = `Equil√≠brio ${avg}%`;
      badge.className = `text-xs font-semibold px-2 py-1 rounded-full ${avg > 70 ? 'bg-emerald-600' : avg > 40 ? 'bg-amber-600' : 'bg-rose-600'}`;

      document.getElementById('executiveSummary').textContent = [
        'Resumo Executivo para Acionistas',
        `‚Ä¢ Centraliza√ß√£o: 7 setores em painel √∫nico (${avg}% equil√≠brio di√°rio).`,
        '‚Ä¢ IA Generativa: Serena + Caixinha Surpresa para experi√™ncia ativa e acolhedora.',
        '‚Ä¢ Privacidade: armazenamento local e exporta√ß√£o sob controle da pessoa usu√°ria.',
        '‚Ä¢ Design Premium: proposta visual de Deep Wellness com foco em reten√ß√£o por gamifica√ß√£o.'
      ].join('\n');

      renderSectors();
      saveState();
    }

    function renderSectors() {
      const root = document.getElementById('sectorsGrid');
      root.innerHTML = '';
      Object.entries(sectorsMeta).forEach(([key, meta]) => {
        const current = state.sectors[key];
        const el = document.createElement('article');
        el.className = 'rounded-xl border border-slate-700 p-3 bg-slate-900/70';
        el.innerHTML = `
          <h4 class="font-semibold">${meta.title}</h4>
          <p class="text-xs text-slate-300 mt-1">Foco: ${meta.focus}</p>
          <p class="text-xs text-slate-400 mt-1">Ferramentas: ${meta.tools.join(', ')}</p>
          <p class="text-sm mt-2">Progresso do dia: <strong>${current}%</strong></p>
          <div class="mt-2 flex gap-2 flex-wrap">
            <button data-sector="${key}" data-op="plus" class="px-2 py-1 text-xs rounded bg-slate-700 hover:bg-slate-600">+5</button>
            <button data-sector="${key}" data-op="minus" class="px-2 py-1 text-xs rounded bg-slate-700 hover:bg-slate-600">-5</button>
          </div>
        `;
        root.appendChild(el);
      });

      root.querySelectorAll('button[data-sector]').forEach(btn => {
        btn.onclick = () => {
          const key = btn.dataset.sector;
          state.sectors[key] = pct(state.sectors[key] + (btn.dataset.op === 'plus' ? 5 : -5));
          renderDashboard();
        };
      });
    }

    function addChat(role, text) {
      const box = document.getElementById('serenaChat');
      const b = document.createElement('div');
      b.className = `rounded-lg px-3 py-2 ${role === 'user' ? 'bg-cyan-700/50 ml-6' : 'bg-slate-700/70 mr-6'}`;
      b.textContent = text;
      box.appendChild(b);
      box.scrollTop = box.scrollHeight;
    }

    function parseSerenaMessage(text) {
      const low = text.toLowerCase();
      const waterMatch = low.match(/(\d+[\.,]?\d*)\s*l/);
      const mlMatch = low.match(/(\d{2,4})\s*ml/);
      if (waterMatch) state.hydrationMl += Number(waterMatch[1].replace(',', '.')) * 1000;
      if (mlMatch) state.hydrationMl += Number(mlMatch[1]);

      const exMatch = low.match(/(\d{1,3})\s*(min|mins|minutos)/);
      if (exMatch && /(caminh|corr|trein|academ|bike|yoga|exerc)/.test(low)) state.exerciseMin += Number(exMatch[1]);

      const moodGood = /(feliz|bem|√≥tim|animad|leve|gratid)/.test(low);
      const moodBad = /(ansios|triste|cansad|estress|mal|desanim)/.test(low);
      if (moodGood) state.mood = Math.min(100, state.mood + 12);
      if (moodBad) state.mood = Math.max(0, state.mood - 10);
      state.emotionalLog = text;

      const asset = low.match(/(?:recebi|ganhei|entrada|faturei)\s*(?:r\$)?\s*(\d+[\.,]?\d*)/);
      const liability = low.match(/(?:gastei|paguei|sa[i√≠]da|despesa)\s*(?:r\$)?\s*(\d+[\.,]?\d*)/);
      if (asset) state.finance.assets += Number(asset[1].replace(',', '.'));
      if (liability) state.finance.liabilities += Number(liability[1].replace(',', '.'));

      if (/ciclo|menstru|tpm|f[e√©]rtil/.test(low)) state.cycle.day = (state.cycle.day % 28) + 1;
      if (/parceir|c[o√≥]digo/.test(low) && !state.cycle.partnerCode) state.cycle.partnerCode = Math.random().toString(36).slice(2, 8).toUpperCase();
      if (/trabalh|hora/.test(low)) state.workHours += 1;
      if (/freela|extra|side hustle/.test(low)) state.sideHustles += 1;
      if (/sal[a√°]rio|mercado|carreira/.test(low)) state.salaryHint = 'Mercado local analisado por IA: foco em negocia√ß√£o por compet√™ncias.';
      if (/estudei|li|curso|aprendi/.test(low)) state.studyLogs += 1;
      if (/orei|meditei|refleti|espiritual/.test(low)) state.spiritualXp += 15;

      recomputeScores();
      saveState();

      const saldo = (state.finance.assets - state.finance.liabilities).toFixed(2);
      return `Atualizei seus indicadores üíô √Ågua: ${Math.round(state.hydrationMl)}ml | Exerc√≠cios: ${state.exerciseMin}min | Humor: ${state.mood}% | Saldo Real: R$ ${saldo}.`;
    }

    document.getElementById('serenaSend').onclick = () => {
      const input = document.getElementById('serenaInput');
      const text = input.value.trim();
      if (!text) return;
      addChat('user', text);
      const answer = parseSerenaMessage(text);
      addChat('ai', answer);
      input.value = '';
      renderDashboard();
    };

    document.getElementById('serenaInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') document.getElementById('serenaSend').click();
    });

    const surpriseLines = [
      'Voc√™ n√£o est√° atrasada: est√° construindo consist√™ncia em sil√™ncio.',
      'Respire fundo. O equil√≠brio nasce de pequenos atos repetidos com carinho.',
      'Seu progresso invis√≠vel de hoje ser√° sua for√ßa vis√≠vel amanh√£.'
    ];

    document.getElementById('surpriseBtn').onclick = () => {
      document.getElementById('surpriseText').textContent = surpriseLines[Math.floor(Math.random() * surpriseLines.length)];
      const seed = Math.floor(Math.random() * 9999);
      const image = document.getElementById('surpriseImage');
      image.src = `https://picsum.photos/seed/serena-${seed}/800/400`;
      image.classList.remove('hidden');
    };

    const tracks = [
      { label: 'Lo-fi Focus', url: 'https://cdn.pixabay.com/download/audio/2022/03/15/audio_c8c8a73467.mp3?filename=lofi-study-112191.mp3' },
      { label: 'Meditation Ambient', url: 'https://cdn.pixabay.com/download/audio/2022/10/30/audio_8af9a9f971.mp3?filename=meditation-relaxing-ambient-124340.mp3' }
    ];
    const musicSelect = document.getElementById('musicSelect');
    const musicPlayer = document.getElementById('musicPlayer');
    tracks.forEach(track => {
      const option = document.createElement('option');
      option.value = track.url;
      option.textContent = track.label;
      musicSelect.appendChild(option);
    });
    musicPlayer.src = tracks[0].url;
    musicSelect.onchange = () => { musicPlayer.src = musicSelect.value; musicPlayer.play().catch(() => {}); };

    document.getElementById('exportBtn').onclick = () => {
      const rows = [
        ['campo', 'valor'],
        ['cycleDate', state.cycleDate],
        ['hydrationMl', state.hydrationMl],
        ['exerciseMin', state.exerciseMin],
        ['mood', state.mood],
        ['financeAssets', state.finance.assets],
        ['financeLiabilities', state.finance.liabilities],
        ['studyLogs', state.studyLogs],
        ['spiritualXp', state.spiritualXp],
        ...Object.entries(state.sectors).map(([k, v]) => [`setor_${k}`, v]),
        ['badges', state.badges.join('|')]
      ];
      const csv = rows.map(r => r.map(v => `"${String(v).replaceAll('"', '""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `espaco-terapia-${today}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    };

    document.getElementById('resetCycleBtn').onclick = () => {
      Object.assign(state, structuredClone(initialData), { badges: state.badges, cycleDate: today });
      addChat('ai', 'Novo ciclo iniciado. Todos os setores reiniciaram para estimular const√¢ncia di√°ria.');
      renderDashboard();
    };

    addChat('ai', 'Ol√°, eu sou a Serena üå∑ Me conte como foi seu dia para atualizar seu mapa sist√™mico.');
    renderDashboard();
  </script>
</body>
</html>
