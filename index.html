<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Harmonia Di√°ria - WR TERAPIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Quicksand:wght@400;600&display=swap');

        :root {
            --primary: #0ea5e9;
            --text: #334155;
            --bg-grad-1: #f0f9ff;
            --bg-grad-2: #e0f2fe;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(255, 255, 255, 0.6);
            --msg-therapist: #ffffff;
        }
        body.dark-mode {
            --text: #dbeafe;
            --bg-grad-1: #0f172a;
            --bg-grad-2: #1e293b;
            --glass-bg: rgba(15, 23, 42, 0.88);
            --glass-border: rgba(71, 85, 105, 0.4);
            --msg-therapist: #1e293b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-grad-1) 0%, var(--bg-grad-2) 100%);
            min-height: 100vh;
            color: var(--text);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }
        .heading-font { font-family: 'Quicksand', sans-serif; }
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.08);
        }
        .tab-content { display: none; opacity: 0; transform: translateY(8px); transition: all 0.3s ease; }
        .tab-content.active { display: block; opacity: 1; transform: translateY(0); }

        .chat-container { height: calc(100vh - 380px); overflow-y: auto; }
        .message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 1rem;
            font-size: 0.9rem;
            line-height: 1.35;
            margin-bottom: 10px;
            word-break: break-word;
            overflow-wrap: anywhere;
        }
        .message.user { align-self: flex-end; background: var(--primary); color: #fff; border-bottom-right-radius: 0.2rem; margin-left: auto; }
        .message.therapist { align-self: flex-start; background: var(--msg-therapist); color: var(--text); border-bottom-left-radius: 0.2rem; margin-right: auto; }
        .message.system { align-self: center; background: #fef3c7; color: #92400e; border-radius: 0.75rem; font-size: 0.78rem; max-width: 100%; }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .status-online { background-color: #10b981; box-shadow: 0 0 5px #10b981; }
        .status-busy { background-color: #f59e0b; box-shadow: 0 0 5px #f59e0b; }
        .status-offline { background-color: #94a3b8; }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
        .mic-active { background-color: #ef4444 !important; color: #fff !important; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239,68,68,.7);} 70% { box-shadow: 0 0 0 10px rgba(239,68,68,0);} 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0);} }

        .mini-select {
            border: 1px solid #fde68a;
            background: #fffbeb;
            border-radius: .8rem;
            font-size: .72rem;
            font-weight: 700;
            letter-spacing: .03em;
            color: #b45309;
            width: 100%;
            padding: .65rem .7rem;
            text-transform: uppercase;
        }

        .theme-toggle {
            width: 38px;
            height: 38px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, .3);
            background: rgba(255,255,255,.55);
            color: #0f172a;
        }
        body.dark-mode .theme-toggle { background: rgba(15,23,42,.8); color: #f8fafc; }
        body.dark-mode .soft-text, body.dark-mode .title-dark { color: #cbd5e1 !important; }
        body.dark-mode .bg-white, body.dark-mode .bg-white\/80, body.dark-mode .bg-white\/50 { background-color: rgba(30, 41, 59, 0.85) !important; color: #e2e8f0; }

        .game-target { width: 54px; height: 54px; border-radius: 999px; position: absolute; cursor: pointer; }
    </style>
</head>
<body class="pb-24">

    <header class="p-5 text-center sticky top-0 z-10 bg-white/30 backdrop-blur-md border-b border-white/20">
        <div class="max-w-md mx-auto flex items-center justify-between">
            <div class="text-left">
                <h1 class="text-2xl font-bold text-sky-800 heading-font">Harmonia Di√°ria</h1>
                <p class="text-sky-600 text-[10px] uppercase tracking-[0.2em] font-bold mt-1">WR TERAPIA</p>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" title="Alternar tema"><i id="theme-icon" class="fas fa-moon"></i></button>
        </div>
    </header>

    <main class="max-w-md mx-auto px-4 pt-4">
        <section id="onboarding" class="tab-content active">
            <div class="glass-card p-8 text-center flex flex-col items-center justify-center min-h-[450px]">
                <div class="w-20 h-20 bg-sky-100 rounded-full flex items-center justify-center mb-6"><i class="fas fa-fingerprint text-sky-500 text-3xl"></i></div>
                <h2 class="text-2xl font-bold text-sky-900 mb-2 heading-font">Bem-vindo(a)</h2>
                <p class="text-sm text-gray-500 mb-8 soft-text">Identifique-se para acessar seu espa√ßo.</p>
                <div class="w-full mb-4">
                    <select id="user-gender" class="w-full p-4 mb-3 rounded-2xl border border-sky-100 bg-white/80 text-sm outline-none focus:ring-2 focus:ring-sky-200">
                        <option value="homem">Sou Homem</option>
                        <option value="mulher">Sou Mulher</option>
                    </select>
                    <input type="text" id="user-name-input" oninput="this.value = this.value.toUpperCase()" placeholder="SEU NOME" class="w-full p-4 rounded-2xl border border-sky-100 bg-white/80 text-center uppercase font-bold text-sky-900 outline-none focus:ring-2 focus:ring-sky-200">
                </div>
                <button onclick="login()" class="w-full bg-sky-500 text-white py-4 rounded-2xl font-bold shadow-lg mt-2 hover:bg-sky-600 transition-all">Entrar</button>
            </div>
        </section>

        <section id="home" class="tab-content">
            <div class="glass-card p-6 mb-4">
                <p class="text-xs text-gray-400">Ol√°,</p>
                <h2 class="text-xl font-bold text-gray-800 heading-font mb-6 client-name">Visitante</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="openChatSelection()" class="p-5 bg-white/80 rounded-2xl border border-sky-50 flex flex-col items-center gap-3 hover:bg-sky-50 shadow-sm"><i class="fas fa-comment-medical text-2xl text-sky-500"></i><span class="text-[10px] font-bold uppercase">Conversar</span></button>
                    <button onclick="showTab('agenda')" class="p-5 bg-white/80 rounded-2xl border border-emerald-50 flex flex-col items-center gap-3 hover:bg-emerald-50 shadow-sm"><i class="fas fa-calendar-check text-2xl text-emerald-500"></i><span class="text-[10px] font-bold uppercase">Agendar</span></button>
                    <button onclick="showTab('moral')" class="p-5 bg-white/80 rounded-2xl border border-blue-50 flex flex-col items-center gap-3 hover:bg-blue-50 shadow-sm"><i class="fas fa-feather text-2xl text-blue-500"></i><span class="text-[10px] font-bold uppercase">Moral das Palavras</span></button>
                    <button onclick="showTab('hope')" class="p-5 bg-white/80 rounded-2xl border border-amber-50 flex flex-col items-center gap-3 hover:bg-amber-50 shadow-sm"><i class="fas fa-lightbulb text-2xl text-amber-500"></i><span class="text-[10px] font-bold uppercase">Caixinha IA</span></button>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-4">
                    <button onclick="showTab('regulacao')" class="p-4 bg-purple-50 rounded-2xl border border-purple-100 flex items-center justify-center gap-2 hover:bg-purple-100 shadow-sm"><i class="fas fa-gamepad text-purple-500"></i><span class="text-[10px] font-bold uppercase text-purple-700">Regula√ß√£o Divertida</span></button>
                    <button onclick="showTab('relaxamento')" class="p-4 bg-indigo-50 rounded-2xl border border-indigo-100 flex items-center justify-center gap-2 hover:bg-indigo-100 shadow-sm"><i class="fas fa-cloud-rain text-indigo-500"></i><span class="text-[10px] font-bold uppercase text-indigo-700">Espa√ßo Relaxamento</span></button>
                </div>
            </div>
        </section>

        <section id="agenda" class="tab-content">
            <div class="glass-card p-6 h-[75vh] flex flex-col">
                <div class="flex items-center gap-2 mb-4"><button onclick="showTab('home')"><i class="fas fa-arrow-left text-gray-500"></i></button><h2 class="font-bold text-sky-900 heading-font">Agendamento Autom√°tico</h2></div>
                <div class="flex-1 rounded-xl overflow-hidden border border-sky-100"><iframe src="https://calendly.com/wrterapia/atendimentos" width="100%" height="100%" frameborder="0"></iframe></div>
            </div>
        </section>

        <section id="chat-selection" class="tab-content">
            <div class="glass-card p-6">
                <h2 class="text-lg font-bold text-sky-900 mb-4 text-center">Nossa Equipe</h2>
                <div id="therapist-list" class="space-y-3"></div>
                <button onclick="showTab('home')" class="mt-6 w-full text-xs text-gray-400 font-bold uppercase">Voltar</button>
            </div>
        </section>

        <section id="chat" class="tab-content">
            <div class="glass-card flex flex-col h-[75vh]">
                <div class="p-4 border-b border-gray-100 flex items-center gap-3 bg-white/40">
                    <div id="active-avatar" class="w-10 h-10 rounded-full flex items-center justify-center text-white"></div>
                    <div class="flex-1">
                        <p id="active-name" class="font-bold text-gray-800 text-sm"></p>
                        <div class="flex items-center"><span id="active-status-dot" class="status-dot"></span><span id="active-status-text" class="text-[9px] uppercase font-bold text-gray-400">Status</span></div>
                    </div>
                    <button onclick="openChatSelection()" class="text-gray-400"><i class="fas fa-times"></i></button>
                </div>
                <div id="chat-messages" class="chat-container p-4 flex flex-col"></div>
                <div id="typing-box" class="px-4 hidden text-xs text-sky-500 italic mb-2 font-medium">Digitando...</div>
                <div class="p-4 bg-white/50 rounded-b-[1.5rem] border-t border-sky-50">
                    <form id="chat-form" class="flex items-center gap-2">
                        <button type="button" id="mic-btn" onclick="toggleMic()" class="w-10 h-10 bg-gray-100 rounded-full text-gray-500"><i class="fas fa-microphone"></i></button>
                        <input type="text" id="chat-input" placeholder="Digite aqui..." class="flex-1 bg-white border border-gray-200 rounded-full px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-sky-400">
                        <button type="submit" class="w-10 h-10 bg-sky-500 text-white rounded-full shadow-md"><i class="fas fa-paper-plane"></i></button>
                    </form>
                </div>
            </div>
        </section>

        <section id="moral" class="tab-content">
            <div class="glass-card p-5">
                <div class="flex items-center gap-2 mb-4"><button onclick="showTab('home')"><i class="fas fa-arrow-left text-gray-500"></i></button><h2 class="font-bold text-sky-900">Moral das Palavras</h2></div>
                <p class="text-xs text-gray-500 mb-3">Deixe um conselho an√¥nimo para ajudar outras pessoas.</p>
                <textarea id="moral-input" placeholder="Escreva aqui uma boa palavra ou conselho..." class="w-full p-4 rounded-xl border border-sky-100 h-28 resize-none text-sm bg-white/60 mb-3"></textarea>
                <button onclick="saveMoral()" class="w-full bg-blue-500 text-white py-3 rounded-xl font-bold">Publicar An√¥nimo</button>
                <div id="moral-list" class="mt-5 space-y-2 max-h-72 overflow-y-auto"></div>
            </div>
        </section>

        <section id="regulacao" class="tab-content">
            <div class="glass-card p-5">
                <div class="flex items-center gap-2 mb-4"><button onclick="showTab('home')"><i class="fas fa-arrow-left text-gray-500"></i></button><h2 class="font-bold text-sky-900">Regula√ß√£o Divertida</h2></div>
                <p class="text-xs text-gray-500 mb-3">Clique nas bolinhas para aliviar o estresse em 20 segundos.</p>
                <div class="flex justify-between mb-3 text-xs font-bold">
                    <span>Pontos: <span id="game-score">0</span></span>
                    <span>Tempo: <span id="game-time">20</span>s</span>
                </div>
                <button onclick="startGame()" class="w-full bg-purple-500 text-white py-3 rounded-xl font-bold mb-3">Iniciar Jogo</button>
                <div id="game-area" class="relative bg-white/70 border border-purple-100 rounded-xl h-64 overflow-hidden"></div>
            </div>
        </section>

        <section id="relaxamento" class="tab-content">
            <div class="glass-card p-5">
                <div class="flex items-center gap-2 mb-4"><button onclick="showTab('home')"><i class="fas fa-arrow-left text-gray-500"></i></button><h2 class="font-bold text-sky-900">Espa√ßo Relaxamento</h2></div>
                <p class="text-sm text-gray-600 mb-3">Deite-se ou se acomode confortavelmente, coloque os fones se quiser, d√™ play e permita seu corpo relaxar com o som da chuva e m√∫sica suave.</p>
                <div class="aspect-video w-full rounded-xl overflow-hidden border border-indigo-100">
                    <iframe width="100%" height="100%" src="https://www.youtube.com/embed/lFcSrYw-ARY" title="M√∫sica suave e chuva" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
            </div>
        </section>

        <section id="hope" class="tab-content">
            <div class="glass-card p-6 text-center min-h-[450px] flex flex-col justify-center relative">
                <div class="flex justify-between items-center absolute top-4 left-4 right-4">
                    <button onclick="showTab('home')"><i class="fas fa-arrow-left text-gray-400"></i></button>
                    <span class="text-[10px] uppercase font-bold text-amber-500 tracking-widest">Caixinha M√°gica</span>
                </div>
                <div id="hope-start">
                    <div class="w-20 h-20 bg-amber-50 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fas fa-gift text-amber-400 text-3xl"></i></div>
                    <h2 class="text-xl font-bold text-gray-800 mb-2 title-dark">Uma dose de encorajamento</h2>
                    <p class="text-xs text-gray-500 mb-6 soft-text">Gere uma imagem bonita + uma mensagem para fortalecer seu dia.</p>
                    <button onclick="generateHopeGroq()" class="w-full bg-amber-500 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-amber-600">Gerar Mensagem de Esperan√ßa</button>
                </div>
                <div id="hope-loading" class="hidden">
                    <div class="loader mx-auto mb-4 border-t-amber-500"></div>
                    <p class="text-[10px] text-amber-500 uppercase font-bold tracking-widest animate-pulse">Gerando seu momento...</p>
                </div>
                <div id="hope-result" class="hidden w-full flex-col items-center">
                    <div class="grid grid-cols-2 gap-2 mb-3 w-full">
                        <select id="hope-theme" class="mini-select">
                            <option value="natureza">Natureza</option>
                            <option value="oceano">Oceano</option>
                            <option value="montanhas">Montanhas</option>
                            <option value="flores">Flores</option>
                        </select>
                        <select id="hope-style" class="mini-select">
                            <option value="fotografia">Fotografia</option>
                            <option value="aquarela">Aquarela</option>
                            <option value="cinematica">Cinem√°tica</option>
                            <option value="pintura">Pintura</option>
                        </select>
                    </div>
                    <div class="relative w-full rounded-xl overflow-hidden shadow-lg mb-4"><img id="hope-img" src="" class="w-full h-56 object-cover bg-gray-200" onerror="handleImageError(this)"></div>
                    <div class="bg-white/80 p-5 rounded-xl border border-amber-100 shadow-sm w-full"><p id="hope-msg" class="text-sm italic text-gray-700 font-medium leading-relaxed"></p></div>
                    <div class="mt-6 flex items-center gap-4 justify-center">
                        <button onclick="generateHopeGroq()" class="text-xs text-amber-600 font-bold uppercase tracking-wide hover:underline">Gerar Outra</button>
                        <button onclick="downloadHopeImage()" class="text-xs text-sky-600 font-bold uppercase tracking-wide hover:underline">Baixar Imagem</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <nav class="fixed bottom-0 w-full bg-white/95 backdrop-blur-md border-t border-gray-100 py-3 flex justify-around z-50">
        <button onclick="showTab('home')" class="text-sky-500 flex flex-col items-center gap-1"><i class="fas fa-home"></i><span class="text-[9px] font-bold tracking-widest">IN√çCIO</span></button>
        <button onclick="openChatSelection()" class="text-gray-400 flex flex-col items-center gap-1"><i class="fas fa-comment"></i><span class="text-[9px] font-bold tracking-widest">CHAT</span></button>
    </nav>

    <script>
        
        const GROQ_API_KEY = "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";

        let clientName = "Visitante";
        let clientGender = "homem";
        let chatHistory = [];
        let isWaiting = false;
        let messageCounter = 0;
        let hopeImageSrc = "";
        let activeTherapist = null;
        let gameTimer = null;
        let gameSpawner = null;

        const offlineResponses = {
            lia: ["Respire fundo, querida(o). Estou com voc√™.", "Voc√™ n√£o est√° sozinha(o), vamos um passo por vez."],
            william: ["Vamos simplificar: qual √© o problema principal agora?", "Escolha um pr√≥ximo passo pequeno e execute hoje."],
            yara: ["No sil√™ncio, seu cora√ß√£o encontra dire√ß√£o.", "Permita-se desacelerar e acolher a pr√≥pria noite."],
            fer: ["A agenda autom√°tica est√° na tela inicial; posso te orientar por aqui."],
            generico: ["Estou aqui com voc√™."]
        };

        const hopeFallback = [
            "Voc√™ j√° superou dias dif√≠ceis antes. Hoje tamb√©m vai passar.",
            "Um passo de cada vez tamb√©m √© avan√ßo. Voc√™ est√° indo bem.",
            "Respire fundo: dentro de voc√™ existe mais for√ßa do que imagina."
        ];

        const therapists = [
            { id: 'lia', name: 'Dra. Lia', color: '#f472b6', icon: 'heart' },
            { id: 'william', name: 'Dr. William', color: '#0ea5e9', icon: 'user-tie' },
            { id: 'yara', name: 'Dra. Yara', color: '#6366f1', icon: 'moon' },
            { id: 'fer', name: 'Fernanda', color: '#10b981', icon: 'headset' }
        ];

        function truncateText(text, max = 220) {
            if (!text) return "";
            const clean = String(text).replace(/\s+/g, ' ').trim();
            return clean.length > max ? `${clean.slice(0, max)}...` : clean;
        }

        function safeTimeout(ms, promise) {
            return Promise.race([
                promise,
                new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), ms))
            ]);
        }

        function getSystemPrompt(therapistId) {
            const tratamento = clientGender === "homem" ? "querido" : "querida";
            return {
                lia: `Voc√™ √© a Dra. Lia. Chame o paciente de '${tratamento}'. Responda em no m√°ximo 2 frases curtas e acolhedoras.`,
                william: `Voc√™ √© Dr. William. Seja objetivo e pr√°tico. No m√°ximo 2 frases curtas.`,
                yara: `Voc√™ √© Dra. Yara. Seja serena e po√©tica em no m√°ximo 2 frases curtas.`,
                fer: `Voc√™ √© Fernanda, secret√°ria. Explique com simpatia em no m√°ximo 2 frases curtas.`
            }[therapistId] || "Responda de forma breve.";
        }

        function login() {
            const name = document.getElementById('user-name-input').value.trim();
            clientGender = document.getElementById('user-gender').value;
            if (!name) return alert('Por favor, digite seu nome.');
            clientName = name;
            document.querySelectorAll('.client-name').forEach(el => el.textContent = clientName);
            loadMorais();
            showTab('home');
        }

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if (id === 'moral') loadMorais();
        }

        function checkAvailability() {
            const hour = new Date().getHours();
            const isNight = (hour >= 22 || hour < 6);
            return therapists.map(t => {
                let status = 'online';
                let label = 'Online';
                if (isNight && t.id !== 'yara') { status = 'offline'; label = 'Offline'; }
                if (!isNight && t.id === 'yara') { status = 'offline'; label = 'Offline'; }
                if (!isNight && t.id === 'william') { status = 'busy'; label = 'Ocupado'; }
                return { ...t, status, label };
            });
        }

        function openChatSelection() {
            const list = document.getElementById('therapist-list');
            list.innerHTML = '';
            checkAvailability().forEach(t => {
                const card = document.createElement('div');
                card.className = `flex items-center gap-4 p-4 bg-white rounded-xl border border-gray-100 shadow-sm ${t.status === 'offline' ? 'opacity-50 grayscale' : 'cursor-pointer hover:bg-sky-50'}`;
                if (t.status !== 'offline') card.onclick = () => startChat(t.id);
                card.innerHTML = `<div class="w-10 h-10 rounded-full flex items-center justify-center text-white" style="background:${t.color}"><i class="fas fa-${t.icon}"></i></div><div class="flex-1"><span class="font-bold text-sm text-gray-700">${t.name}</span><div><span class="status-dot status-${t.status}"></span><span class="text-[8px] uppercase font-bold text-gray-400">${t.label}</span></div></div>`;
                list.appendChild(card);
            });
            showTab('chat-selection');
        }

        function startChat(id) {
            activeTherapist = therapists.find(t => t.id === id);
            const availability = checkAvailability().find(t => t.id === id);
            document.getElementById('active-name').textContent = activeTherapist.name;
            document.getElementById('active-avatar').style.backgroundColor = activeTherapist.color;
            document.getElementById('active-avatar').innerHTML = `<i class="fas fa-${activeTherapist.icon}"></i>`;
            document.getElementById('active-status-dot').className = `status-dot status-${availability.status}`;
            document.getElementById('active-status-text').textContent = availability.label;
            document.getElementById('chat-messages').innerHTML = '';
            chatHistory = [{ role: 'system', content: `${getSystemPrompt(id)} Paciente: ${clientName}.` }];
            addMessage(id === 'william' ? 'Dr. William pode responder com pequena demora enquanto atende.' : `Ol√° ${clientName}, como posso ajudar hoje?`, id === 'william' ? 'system' : 'therapist', false);
            showTab('chat');
        }

        function addMessage(text, type, saveToHistory = true) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = truncateText(text, type === 'therapist' ? 220 : 260);
            document.getElementById('chat-messages').appendChild(div);
            document.getElementById('chat-messages').scrollTop = 99999;
            if (saveToHistory && type !== 'system') chatHistory.push({ role: type === 'user' ? 'user' : 'assistant', content: truncateText(text, 220) });
        }

        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text || isWaiting || !activeTherapist) return;
            addMessage(text, 'user');
            input.value = '';
            isWaiting = true;
            document.getElementById('typing-box').classList.remove('hidden');

            try {
                const data = await safeTimeout(12000, fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${GROQ_API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: 'llama-3.3-70b-versatile', messages: chatHistory, temperature: 0.6, max_tokens: 85 })
                }).then(r => r.json()));

                const resposta = data?.choices?.[0]?.message?.content || offlineResponses[activeTherapist.id]?.[0] || offlineResponses.generico[0];
                addMessage(resposta, 'therapist');
            } catch {
                const responses = offlineResponses[activeTherapist.id] || offlineResponses.generico;
                addMessage(responses[Math.floor(Math.random() * responses.length)], 'therapist');
            } finally {
                document.getElementById('typing-box').classList.add('hidden');
                isWaiting = false;
            }
        };

        async function generateHopeGroq() {
            if (isWaiting) return;
            isWaiting = true;
            document.getElementById('hope-start').classList.add('hidden');
            document.getElementById('hope-result').classList.add('hidden');
            document.getElementById('hope-loading').classList.remove('hidden');

            const theme = document.getElementById('hope-theme')?.value || 'natureza';
            const style = document.getElementById('hope-style')?.value || 'fotografia';
            let frase = hopeFallback[Math.floor(Math.random() * hopeFallback.length)];
            let promptImagem = `${theme}, ${style}, luz suave, esperan√ßa`;

            try {
                const msgReq = safeTimeout(7000, fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${GROQ_API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b-versatile',
                        messages: [
                            { role: 'system', content: 'Escreva mensagens curtas de encorajamento em portugu√™s.' },
                            { role: 'user', content: `Crie 1 frase de encorajamento curta para algu√©m ansioso. Tema: ${theme}.` }
                        ],
                        temperature: 0.8,
                        max_tokens: 70
                    })
                }).then(r => r.json()));

                const promptReq = safeTimeout(7000, fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${GROQ_API_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b-versatile',
                        messages: [
                            { role: 'system', content: 'Voc√™ gera prompts curtos em ingl√™s para cria√ß√£o de imagens.' },
                            { role: 'user', content: `Crie um prompt visual de at√© 20 palavras para arte de ${theme} no estilo ${style}, acolhedora e bonita.` }
                        ],
                        temperature: 0.9,
                        max_tokens: 80
                    })
                }).then(r => r.json()));

                const [msgRes, prRes] = await Promise.allSettled([msgReq, promptReq]);
                if (msgRes.status === 'fulfilled') {
                    frase = truncateText(msgRes.value?.choices?.[0]?.message?.content || frase, 180);
                }
                if (prRes.status === 'fulfilled') {
                    promptImagem = truncateText(prRes.value?.choices?.[0]?.message?.content || promptImagem, 180);
                }

                hopeImageSrc = `https://image.pollinations.ai/prompt/${encodeURIComponent(promptImagem)}?width=900&height=600&nologo=true&seed=${Date.now()}`;
                document.getElementById('hope-img').src = hopeImageSrc;
            } catch {
                handleImageError(document.getElementById('hope-img'));
            }

            document.getElementById('hope-msg').textContent = frase;
            document.getElementById('hope-loading').classList.add('hidden');
            document.getElementById('hope-result').classList.remove('hidden');
            document.getElementById('hope-result').style.display = 'flex';
            isWaiting = false;
        }

        function handleImageError(img) {
            const fallbackImages = {
                natureza: 'https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=900&q=80',
                oceano: 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=900&q=80',
                montanhas: 'https://images.unsplash.com/photo-1464822759023-fed622ff2c3b?auto=format&fit=crop&w=900&q=80',
                flores: 'https://images.unsplash.com/photo-1490750967868-88aa4486c946?auto=format&fit=crop&w=900&q=80'
            };
            const theme = document.getElementById('hope-theme')?.value || 'natureza';
            hopeImageSrc = `${fallbackImages[theme]}&sig=${Math.random()}`;
            img.src = hopeImageSrc;
        }

        function downloadHopeImage() {
            if (!hopeImageSrc) return;
            const link = document.createElement('a');
            link.href = hopeImageSrc;
            link.download = `encorajamento-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            link.remove();
        }

        function saveMoral() {
            const input = document.getElementById('moral-input');
            const text = truncateText(input.value, 280);
            if (!text) return;
            const items = JSON.parse(localStorage.getItem('moral_wall') || '[]');
            items.unshift({ date: new Date().toLocaleString('pt-BR'), text });
            localStorage.setItem('moral_wall', JSON.stringify(items.slice(0, 80)));
            input.value = '';
            loadMorais();
        }

        function loadMorais() {
            const items = JSON.parse(localStorage.getItem('moral_wall') || '[]');
            const list = document.getElementById('moral-list');
            list.innerHTML = items.length
                ? items.map(i => `<div class="bg-white p-3 rounded-lg border text-xs"><b>An√¥nimo ‚Ä¢ ${i.date}</b><p class="mt-1">${i.text}</p></div>`).join('')
                : '<p class="text-xs text-gray-400">Ainda n√£o h√° mensagens. Seja o primeiro a deixar um conselho üíô</p>';
        }

        function startGame() {
            const area = document.getElementById('game-area');
            let score = 0;
            let time = 20;
            document.getElementById('game-score').textContent = score;
            document.getElementById('game-time').textContent = time;
            area.innerHTML = '';
            clearInterval(gameTimer);
            clearInterval(gameSpawner);

            gameSpawner = setInterval(() => {
                const ball = document.createElement('button');
                ball.className = 'game-target';
                ball.style.left = `${Math.random() * (area.clientWidth - 54)}px`;
                ball.style.top = `${Math.random() * (area.clientHeight - 54)}px`;
                ball.style.background = `hsl(${Math.random() * 360}, 85%, 65%)`;
                ball.onclick = () => { score++; document.getElementById('game-score').textContent = score; ball.remove(); };
                area.appendChild(ball);
                setTimeout(() => ball.remove(), 900);
            }, 420);

            gameTimer = setInterval(() => {
                time--;
                document.getElementById('game-time').textContent = time;
                if (time <= 0) {
                    clearInterval(gameTimer);
                    clearInterval(gameSpawner);
                    alert(`Fim! Voc√™ marcou ${score} pontos. √ìtimo para descarregar o estresse!`);
                }
            }, 1000);
        }

        function toggleTheme() {
            const dark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme_mode', dark ? 'dark' : 'light');
            document.getElementById('theme-icon').className = dark ? 'fas fa-sun' : 'fas fa-moon';
        }

        (function initTheme() {
            const saved = localStorage.getItem('theme_mode');
            if (saved === 'dark') document.body.classList.add('dark-mode');
            document.getElementById('theme-icon').className = document.body.classList.contains('dark-mode') ? 'fas fa-sun' : 'fas fa-moon';
        })();

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const rec = new SpeechRecognition();
            rec.lang = 'pt-BR';
            rec.onresult = e => { document.getElementById('chat-input').value = e.results[0][0].transcript; toggleMic(); };
            window.toggleMic = () => {
                const btn = document.getElementById('mic-btn');
                if (btn.classList.contains('mic-active')) { rec.stop(); btn.classList.remove('mic-active'); }
                else { rec.start(); btn.classList.add('mic-active'); }
            };
        } else {
            window.toggleMic = () => {};
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0f172a">
<title>Harmonia Di√°ria - WR TERAPIA</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Quicksand:wght@400;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&display=swap');
:root{--bg-dark:#0f172a;--card-bg:#1e293b;--primary:#0ea5e9;--text-light:#f1f5f9;--text-dim:#94a3b8}*{box-sizing:border-box}body{font-family:'Inter',sans-serif;background-color:var(--bg-dark);color:var(--text-light);margin:0;padding:0;position:fixed;inset:0;display:flex;flex-direction:column}.heading-font{font-family:'Quicksand',sans-serif}.glass-card{background:rgba(30,41,59,0.98);border:1px solid rgba(255,255,255,0.1);border-radius:1.5rem;box-shadow:0 4px 6px -1px rgba(0,0,0,0.5)}main{flex:1;position:relative;width:100%;max-width:480px;margin:0 auto}.tab-content{display:none;position:absolute;inset:0;padding:1rem;overflow-y:auto;-webkit-overflow-scrolling:touch}.tab-content.active{display:flex;flex-direction:column;animation:fadeIn .3s ease-out}@keyframes fadeIn{from{opacity:0}to{opacity:1}}#chat.tab-content{padding:0;overflow:hidden}.chat-layout{display:flex;flex-direction:column;height:100%}.chat-messages-area{flex:1;overflow-y:auto;padding:1rem;background:rgba(15,23,42,0.5)}.message{max-width:85%;padding:12px 16px;border-radius:1.2rem;font-size:.95rem;line-height:1.5;margin-bottom:12px}.message.user{align-self:flex-end;background:var(--primary);color:#fff;border-bottom-right-radius:.2rem;margin-left:auto}.message.therapist{align-self:flex-start;background:#334155;color:#e2e8f0;border-bottom-left-radius:.2rem;margin-right:auto}.message.audio-msg{font-style:italic;display:flex;align-items:center;gap:8px;color:#cbd5e1}.message.system-note{align-self:center;background:rgba(239,68,68,0.2);color:#fca5a5;font-size:0.8rem;text-align:center;border:1px solid rgba(239,68,68,0.4);width:90%}.memory-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}.memory-card{background-color:#334155;height:60px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;border:2px solid #475569;color:transparent;transition:all .3s ease;transform-style:preserve-3d}.memory-card.flipped,.memory-card.matched{background-color:#f1f5f9;border-color:var(--primary);color:#333;transform:rotateY(180deg)}.memory-card.matched{background-color:#10b981;border-color:#059669;color:#fff;cursor:default}.puzzle-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;width:100%;aspect-ratio:1;background:#334155;padding:4px;border-radius:8px}.puzzle-tile{background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:bold;cursor:pointer;border-radius:4px;user-select:none;transition:transform .2s}.puzzle-tile.empty{background:transparent;cursor:default}.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px}.status-online{background-color:#10b981;box-shadow:0 0 5px #10b981}.status-busy{background-color:#f59e0b;box-shadow:0 0 5px #f59e0b}.status-offline{background-color:#94a3b8}.admin-trigger{opacity:.1;transition:opacity .3s;cursor:pointer}.admin-trigger:hover{opacity:1}
.book-page{background-color:#fdf6e3;color:#2c1810;font-family:'Merriweather',serif;padding:2rem;border-radius:4px;box-shadow:inset 20px 0 50px rgba(0,0,0,0.1),5px 5px 15px rgba(0,0,0,0.3);border-left:5px solid #d4c5b0;line-height:1.8;position:relative;overflow:hidden;min-height:400px}.book-page::before{content:"";position:absolute;top:0;bottom:0;left:0;width:100%;background:linear-gradient(90deg,rgba(0,0,0,0.05) 0%,rgba(0,0,0,0) 10%,rgba(0,0,0,0) 90%,rgba(0,0,0,0.05) 100%);pointer-events:none}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#475569;border-radius:2px}.btn-game{@apply w-full py-3 rounded-xl font-bold shadow-lg transition-all active:scale-95}input,select,textarea{background-color:#334155;color:#fff;border-color:#475569}input::placeholder,textarea::placeholder{color:#94a3b8}
</style>
<script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
<header class="flex-none p-4 text-center bg-slate-900/95 backdrop-blur-md border-b border-slate-700 z-20 relative">
<button id="music-toggle" onclick="window.toggleMusic()" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-sky-400 transition-colors w-8 h-8 flex items-center justify-center rounded-full active:bg-slate-800"><i id="music-icon" class="fas fa-volume-mute"></i></button>
<h1 class="text-xl font-bold text-sky-400 heading-font">Espa√ßo | WR Terapia¬Æ</h1>
</header>
<main>
<div id="bg-music-player" style="display:none;"></div>
<section id="onboarding" class="tab-content active"><div class="h-full flex flex-col items-center justify-center p-4"><div class="glass-card p-8 text-center w-full"><div class="w-20 h-20 bg-slate-700 rounded-full flex items-center justify-center mb-6 mx-auto ring-2 ring-sky-500/50"><i class="fas fa-fingerprint text-sky-400 text-3xl"></i></div><h2 class="text-2xl font-bold text-white mb-2 heading-font">Bem-vindo(a)</h2><p class="text-sm text-slate-400 mb-8">Identifique-se para acessar seu espa√ßo seguro.</p><div class="w-full mb-4 space-y-3"><select id="user-gender" class="w-full p-4 rounded-2xl outline-none focus:ring-2 focus:ring-sky-500"><option value="homem">Sou Homem</option><option value="mulher">Sou Mulher</option></select><input type="text" id="user-name-input" oninput="this.value=this.value.toUpperCase()" placeholder="SEU NOME" class="w-full p-4 rounded-2xl text-center uppercase font-bold outline-none focus:ring-2 focus:ring-sky-500"></div><button onclick="window.login()" class="w-full bg-sky-600 text-white py-4 rounded-2xl font-bold shadow-lg mt-2 hover:bg-sky-500 transition-all">Entrar</button></div></div></section>
<section id="home" class="tab-content"><div class="glass-card p-6 mb-4"><p class="text-xs text-slate-400">Muito bom te ver aqui,</p><h2 class="text-xl font-bold text-white heading-font mb-6 client-name">Visitante</h2><div class="grid grid-cols-2 gap-4"><button onclick="window.openChatSelection()" class="p-4 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-3 hover:bg-slate-700 transition-all"><i class="fas fa-comment-medical text-2xl text-sky-400"></i><span class="text-[10px] font-bold uppercase text-slate-300">Conversar</span></button><button onclick="window.showTab('agenda')" class="p-4 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-3 hover:bg-slate-700 transition-all"><i class="fas fa-calendar-check text-2xl text-emerald-400"></i><span class="text-[10px] font-bold uppercase text-slate-300">Agendar</span></button><button onclick="window.showTab('mural')" class="p-4 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-3 hover:bg-slate-700 transition-all"><i class="fas fa-comments text-2xl text-amber-400"></i><span class="text-[10px] font-bold uppercase text-slate-300">Mural</span></button><button onclick="window.showTab('hope')" class="p-4 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-3 hover:bg-slate-700 transition-all"><i class="fas fa-lightbulb text-2xl text-yellow-400"></i><span class="text-[10px] font-bold uppercase text-slate-300">Caixinha Surpresa</span></button></div><div class="grid grid-cols-2 gap-4 mt-4"><button onclick="window.showTab('relaxation')" class="p-4 bg-purple-900/30 rounded-2xl border border-purple-800/50 flex flex-col items-center gap-2 hover:bg-purple-900/50 transition-all"><i class="fas fa-spa text-xl text-purple-400"></i><span class="text-[9px] font-bold uppercase text-purple-300">Relaxar</span></button><button onclick="window.startDescompressao()" class="p-4 bg-rose-900/30 rounded-2xl border border-rose-800/50 flex flex-col items-center gap-2 hover:bg-rose-900/50 transition-all"><i class="fas fa-brain text-xl text-rose-400"></i><span class="text-[9px] font-bold uppercase text-rose-300">Descompress√£o</span></button></div><button onclick="window.showTab('library')" class="w-full mt-4 p-4 bg-indigo-900/30 rounded-2xl border border-indigo-800/50 flex flex-col items-center gap-2 hover:bg-indigo-900/50 transition-all"><i class="fas fa-book-open text-xl text-indigo-400"></i><span class="text-[9px] font-bold uppercase text-indigo-300">Biblioteca M√°gica</span></button></div><div class="mt-auto pt-8 pb-4 text-center flex flex-col items-center justify-center gap-2"><p class="text-[9px] text-slate-600 uppercase font-bold tracking-widest">Desenvolvido por WR-TECNOLOGIA | William Ribeiro</p><i onclick="window.showAdminLogin()" class="fas fa-lock text-slate-700 text-xs admin-trigger" title="Admin"></i></div></section>
<section id="library" class="tab-content"><div class="glass-card p-4 h-full flex flex-col"><div class="flex items-center gap-3 mb-4 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-indigo-400">Biblioteca M√°gica</h2></div><div class="mb-4 text-center flex-none"><p class="text-xs text-slate-400 mb-2">Escolha um tema e deixe nosso sistema te apresentar um cap√≠tulo exclusivo.</p></div><div class="flex-none mb-4"><select id="book-theme" class="w-full p-3 rounded-xl text-sm bg-slate-800 text-slate-200 border border-slate-600 focus:ring-2 focus:ring-indigo-500"><option value="Autoconhecimento">Autoconhecimento</option><option value="Resili√™ncia">Resili√™ncia</option><option value="Ansiedade e Calma">Ansiedade e Calma</option><option value="Relacionamentos Saud√°veis">Relacionamentos Saud√°veis</option><option value="Prop√≥sito de Vida">Prop√≥sito de Vida</option><option value="Sono e Descanso">Sono e Descanso</option><option value="Foco e Disciplina">Foco e Disciplina</option></select><button onclick="window.gerarLeitura()" class="w-full mt-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg"><i class="fas fa-pen-fancy mr-2"></i>Ler um Cap√≠tulo</button></div><div id="book-container" class="flex-1 overflow-y-auto hidden animate-fade-in"><div class="book-page"><h3 id="book-title" class="text-xl font-bold mb-4 text-center border-b border-stone-400 pb-2"></h3><div id="book-content" class="text-sm text-justify"></div><p class="text-center mt-8 text-xs text-stone-500 italic">~ Fim do Cap√≠tulo ~</p></div></div><div id="book-loading" class="hidden flex-1 flex flex-col items-center justify-center text-indigo-300"><i class="fas fa-feather-alt fa-spin text-4xl mb-3"></i><p class="text-sm animate-pulse">Buscando seu Cap√≠tulo de Hoje...</p></div></div></section>
<section id="admin-login-screen" class="tab-content justify-center items-center"><div class="glass-card p-6 w-full text-center"><div class="flex justify-between items-center mb-4"><button onclick="window.showTab('home')" class="text-slate-400"><i class="fas fa-arrow-left"></i></button><h2 class="font-bold text-white">Acesso Administrativo</h2><div class="w-4"></div></div><input type="password" id="admin-pass" placeholder="Senha" class="w-full p-3 mb-4 rounded-xl text-center"><button onclick="window.attemptAdminLogin()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold">Entrar</button></div></section>
<section id="admin-dashboard" class="tab-content"><div class="glass-card p-4 h-full flex flex-col"><div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-700"><h2 class="font-bold text-emerald-400">Painel do Terapeuta</h2><button onclick="window.logoutAdmin()" class="text-xs text-red-400">Sair</button></div><p class="text-xs text-slate-400 mb-2">Conversas Ativas:</p><div id="admin-chat-list" class="flex-1 overflow-y-auto space-y-2"></div><div id="admin-response-area" class="hidden mt-4 pt-4 border-t border-slate-700"><div class="flex justify-between items-center mb-2"><span id="admin-target-name" class="text-xs font-bold text-white"></span><button onclick="window.toggleAiStatus()" id="ai-toggle-btn" class="text-[10px] bg-sky-600 px-2 py-1 rounded">IA: ATIVA</button></div><div id="admin-chat-preview" class="h-32 overflow-y-auto bg-slate-900/50 rounded p-2 mb-2 text-xs text-slate-300"></div><div class="flex gap-2"><input type="text" id="admin-reply-input" placeholder="Responder..." class="flex-1 text-sm p-2 rounded"><button onclick="window.sendAdminReply()" class="bg-emerald-600 text-white p-2 rounded"><i class="fas fa-paper-plane"></i></button></div></div></div></section>
<section id="agenda" class="tab-content"><div class="glass-card p-4 h-full flex flex-col"><div class="flex items-center gap-3 mb-4 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-sky-400 heading-font">Agendamento</h2></div><div class="flex-1 rounded-xl overflow-hidden border border-slate-600 bg-white"><iframe src="https://calendly.com/wrterapia/atendimentos" width="100%" height="100%" frameborder="0"></iframe></div><p class="text-[10px] text-slate-500 mt-3 text-center italic">Agenda autom√°tica.</p></div></section>
<section id="chat-selection" class="tab-content"><div class="glass-card p-6 h-full overflow-y-auto"><div class="flex items-center gap-3 mb-4"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-sky-400 text-lg">Nossa Equipe</h2></div><div id="therapist-list" class="space-y-3 pb-20"></div></div></section>
<section id="chat" class="tab-content"><div class="chat-layout h-full"><div class="p-4 border-b border-slate-700 flex items-center gap-3 bg-slate-800/95 flex-none z-10"><div id="active-avatar" class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-md"></div><div class="flex-1"><p id="active-name" class="font-bold text-white text-sm"></p><div class="flex items-center"><span id="active-status-dot" class="status-dot"></span><span id="active-status-text" class="text-[9px] uppercase font-bold text-slate-400">Status</span></div></div><button onclick="window.openChatSelection()" class="text-slate-400 hover:text-white p-2"><i class="fas fa-times"></i></button></div><div id="chat-messages" class="chat-messages-area"></div><div class="flex-none bg-slate-800 border-t border-slate-700 pb-2"><div id="typing-box" class="px-4 py-2 hidden text-xs text-sky-400 italic font-medium bg-slate-900/30">Digitando <span class="animate-pulse">...</span></div><div class="p-3"><form id="chat-form" class="flex items-center gap-2"><button type="button" id="mic-btn" onclick="window.toggleMic()" class="w-10 h-10 bg-slate-700 rounded-full text-slate-400 hover:text-white transition-colors flex items-center justify-center"><i class="fas fa-microphone"></i></button><input type="text" id="chat-input" placeholder="Digite aqui..." class="flex-1 bg-slate-700 border-0 text-white rounded-full px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-sky-500 placeholder-slate-400"><button type="button" id="wa-btn" onclick="window.sendToWhatsapp()" class="hidden w-10 h-10 bg-emerald-600 text-white rounded-full shadow-md hover:bg-emerald-500 transition-colors flex items-center justify-center"><i class="fab fa-whatsapp text-lg"></i></button><button type="submit" id="chat-submit-btn" class="w-10 h-10 bg-sky-600 text-white rounded-full shadow-md hover:bg-sky-500 transition-colors flex items-center justify-center"><i class="fas fa-paper-plane"></i></button></form></div></div></div></section>
<section id="relaxation" class="tab-content"><div class="glass-card p-4 h-full flex flex-col"><div class="flex items-center gap-3 mb-4 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-sky-400">Relaxamento</h2></div><div class="aspect-video w-full rounded-xl overflow-hidden shadow-lg flex-none border border-slate-600 bg-black"><iframe width="100%" height="100%" src="https://www.youtube.com/embed/sF80I-TQiW0" frameborder="0" allowfullscreen></iframe></div><div class="mt-4 p-5 bg-slate-800/80 rounded-2xl border border-slate-700 text-slate-300 leading-relaxed text-sm shadow-inner flex-1 overflow-y-auto"><p class="mb-4">Muitas vezes em nossas rotinas nos perdemos em pensamentos e sofrimentos, mas √© fundamental parar, relaxar e deixar sentir a leveza da vida.</p><p class="mb-4">Ent√£o, d√™ play, encontre um espa√ßo confort√°vel e deixe a ansiedade, a ang√∫stia e os sentimentos negativos irem embora.</p><p class="mb-6">Abrace um travesseiro, feche os olhos e se reconstrua.</p><p class="text-right font-bold text-sky-500 font-heading text-xs">Att. William Ribeiro - O seu terapeuta ‚ù§Ô∏è</p></div></div></section>
<section id="mural" class="tab-content"><div class="glass-card p-5 h-full flex flex-col"><div class="flex items-center gap-3 mb-4 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button><div><h2 class="font-bold text-sky-400">Mural de Sentimentos</h2><p class="text-[10px] text-slate-500">Compartilhe experi√™ncias anonimamente e transforme uma vida.</p><p class="text-[9px] text-emerald-400 font-bold"><i class="fas fa-globe-americas mr-1"></i>Conectado √† Planilha</p></div></div><div id="mural-list" class="flex-1 overflow-y-auto mb-4 space-y-3 pr-1 pb-20"></div><div class="mt-auto pt-4 border-t border-slate-700 flex-none bg-slate-800/50 p-2 rounded-xl"><textarea id="mural-input" placeholder="Escreva algo transformador..." class="w-full p-3 rounded-xl border border-slate-600 h-20 resize-none text-sm bg-slate-800 mb-2 focus:ring-2 focus:ring-amber-500 outline-none"></textarea><button onclick="window.saveMuralMessage()" class="w-full bg-amber-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-amber-500 transition-all"><i class="fas fa-paper-plane mr-2"></i>Publicar</button></div></div></section>
<section id="hope" class="tab-content"><div class="glass-card p-6 min-h-full flex flex-col justify-center overflow-y-auto"><div class="flex justify-between items-center mb-6 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-lg text-yellow-400">Caixinha Surpresa</h2><div class="w-8"></div></div><div class="mb-8 flex-none text-center"><div class="w-24 h-24 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 border border-slate-600 shadow-lg animate-pulse"><i class="fas fa-gift text-yellow-400 text-4xl"></i></div><p class="text-sm text-slate-400 mb-2">Toque para receber uma mensagem de luz.</p></div><button onclick="window.gerarCaixinha()" class="flex-none w-full bg-gradient-to-r from-amber-600 to-orange-600 text-white py-4 rounded-xl font-bold shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 border border-amber-500/50"><i class="fas fa-magic mr-2"></i>Gerar Experi√™ncia</button><div id="resultadoBox" class="mt-8 hidden animate-fade-in pb-20 flex-none"><img id="imgBox" class="rounded-xl mb-4 shadow-lg w-full h-48 object-cover bg-slate-800 border border-slate-700"/><div class="bg-slate-800/80 p-5 rounded-xl border border-slate-700 shadow-sm"><p id="msgBox" class="italic text-slate-200 text-sm font-medium leading-relaxed text-center"></p></div></div></div></section>
<section id="game-section" class="tab-content"><div class="glass-card p-5 h-full flex flex-col"><div class="flex items-center justify-between mb-4 flex-none"><div class="flex items-center gap-2"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-rose-400">Descompress√£o</h2></div><span class="text-xs font-bold bg-rose-900/50 text-rose-300 px-3 py-1 rounded-full border border-rose-800" id="game-level-display">N√≠vel 1/10</span></div><div class="mb-4 bg-slate-800/50 p-3 rounded-xl border border-slate-700 flex-none"><p class="text-xs text-slate-400 text-center leading-relaxed">Este √© um espa√ßo seguro para brincar, relaxar e sair da rotina.<br>Treine seu racioc√≠nio, mem√≥ria e percep√ß√£o.</p></div><div id="game-container" class="flex-1 flex flex-col items-center justify-center w-full relative overflow-y-auto"></div><button id="next-game-btn" onclick="window.nextGame()" class="flex-none hidden mt-4 bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg w-full animate-bounce">Pr√≥ximo Desafio <i class="fas fa-arrow-right ml-2"></i></button></div></section>
</main>
<nav class="flex-none bg-slate-900/95 backdrop-blur-md border-t border-slate-800 py-3 flex justify-around z-50"><button onclick="window.showTab('home')" class="text-sky-500 flex flex-col items-center gap-1 hover:text-sky-400 transition-colors"><i class="fas fa-home"></i><span class="text-[9px] font-bold tracking-widest">IN√çCIO</span></button><button onclick="window.openChatSelection()" class="text-slate-500 flex flex-col items-center gap-1 hover:text-slate-300 transition-colors"><i class="fas fa-comment"></i><span class="text-[9px] font-bold tracking-widest">CHAT</span></button></nav>
<div id="chat-terms-modal" class="fixed inset-0 bg-black/80 z-[60] hidden items-center justify-center p-4"><div class="glass-card w-full max-w-md p-6"><h3 class="text-lg font-bold text-sky-400 mb-3">Seu acolhimento em primeiro lugar</h3><p class="text-sm text-slate-300 leading-relaxed mb-4">Para garantir que voc√™ nunca fique sem amparo ou aguarde em filas de espera, utilizamos um sistema de Atendimento H√≠brido.</p><p class="text-sm text-slate-300 leading-relaxed mb-6">Sempre que nossos profissionais estiverem atendendo mais de tr√™s pessoas simultaneamente, acionamos nossa Intelig√™ncia Artificial de suporte. Ela oferece escuta e conforto imediatos, sendo sempre supervisionada e operada em tempo real por nossa equipe humana. Unimos tecnologia e calor humano para cuidar de voc√™.</p><div class="grid grid-cols-1 gap-3"><button onclick="window.acceptChatTerms()" class="w-full bg-sky-600 hover:bg-sky-500 text-white py-3 rounded-xl font-bold">Tudo bem, aceito os termos</button><button onclick="window.declineChatTerms()" class="w-full bg-slate-700 hover:bg-slate-600 text-slate-200 py-3 rounded-xl font-bold">N√£o aceito</button></div></div></div>
<script>
// --- CONFIGURA√á√ÉO ---
window.AI_PROXY_URL="https://SEU-PROJETO-VERCEL.vercel.app/api/ai";
window.AI_PROXY_FALLBACK="/api/ai";
window.SHEET_ID = "1cus7Hm0a4FSU9SiPAoszA6KlrhWrhKYbQwSd7YPsYeY";
// <<== LINK DO SCRIPT ATUALIZADO
window.SHEET_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxPmSrtdjfPuLtZma2hd84WMv42zcZx0IzuVpq3zUUvMtwEDEGD-94CQyibUtOZoWDC/exec";

// Dados do Usu√°rio
window.clientName=localStorage.getItem('wr_client_name')||"Visitante";
window.clientGender=localStorage.getItem('wr_client_gender')||"homem";
window.isWaiting=false;
window.messageCounter=0;
window.activeTherapist=null;
window.adminTargetTherapist=null;
window.aiPaused={};
window.player = null;
window.chatTermsAccepted=localStorage.getItem('wr_chat_terms')==='accepted';

// UI Helpers
window.showTab = function(id){
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(id === 'mural') window.loadMural(); 
}

window.login = function(){
    const n=document.getElementById('user-name-input').value.trim();
    window.clientGender=document.getElementById('user-gender').value;
    if(n){
        window.clientName=n;
        localStorage.setItem('wr_client_name',n);
        localStorage.setItem('wr_client_gender',window.clientGender);
        document.querySelectorAll('.client-name').forEach(el=>el.innerText=n);
        window.showTab('home');
        if(window.player){
            window.player.playVideo();
            window.player.unMute();
            window.player.setVolume(30);
            document.getElementById('music-icon').className="fas fa-volume-up text-sky-400";
        }
    }else alert("Digite seu nome.");
}

// Audio Logic
window.onYouTubeIframeAPIReady = function(){window.player=new YT.Player('bg-music-player',{height:'0',width:'0',videoId:'Cg0dAc4-UCY',playerVars:{'autoplay':0,'controls':0,'loop':1,'playlist':'Cg0dAc4-UCY'},events:{'onReady':onPlayerReady}})}
function onPlayerReady(e){e.target.setVolume(30)}
window.toggleMusic = function(){if(!window.player)return;const btn=document.getElementById('music-icon');if(window.player.isMuted()){window.player.unMute();window.player.setVolume(30);btn.className="fas fa-volume-up text-sky-400"}else{window.player.mute();btn.className="fas fa-volume-mute text-slate-400"}}

// Chat Logic
window.saveChatHistory = function(id,h){if(!window.clientName)return;localStorage.setItem(`chat_${window.clientName}_${id}`,JSON.stringify(h))}
window.loadChatHistory = function(id){if(!window.clientName)return[];return JSON.parse(localStorage.getItem(`chat_${window.clientName}_${id}`))||[]}

const therapists=[
{id:'lia',name:'Dra. Lia',color:'#ec4899',icon:'heart',schedule:'Seg a Sex ‚Ä¢ 08:00 √†s 22:00'},
{id:'william',name:'Dr. William',color:'#0ea5e9',icon:'user-tie',schedule:'Seg a Sex ‚Ä¢ 10:00-12:00 e 17:00-22:00'},
{id:'yara',name:'Dra. Yara',color:'#8b5cf6',icon:'moon',schedule:'Dom a S√°b ‚Ä¢ 22:00 √†s 08:00'},
{id:'marcos',name:'Dr. Marcos',color:'#10b981',icon:'stethoscope',schedule:'S√°b ‚Ä¢ 08:00-12:00 e 14:00-22:00'},
{id:'juliana',name:'Dra. Juliana',color:'#f59e0b',icon:'user-doctor',schedule:'S√°b 22:00 at√© Dom 22:00'}
];
window.isWithinHours = function(start,end,h){if(start<end)return h>=start&&h<end;return h>=start||h<end}
window.checkAvailability = function(id){const now=new Date();const day=now.getDay();const hour=now.getHours();if(id==='lia'){const online=day>=1&&day<=5&&window.isWithinHours(8,22,hour);return online?{s:'online',t:'Online',c:'#10b981'}:{s:'offline',t:'Fora de hor√°rio',c:'#94a3b8'}}if(id==='william'){const weekday=day>=1&&day<=5;const online=weekday&&(window.isWithinHours(10,12,hour)||window.isWithinHours(17,22,hour));return online?{s:'busy',t:'Em atendimento',c:'#f59e0b'}:{s:'offline',t:'Fora de hor√°rio',c:'#94a3b8'}}if(id==='yara'){const online=window.isWithinHours(22,8,hour);return online?{s:'online',t:'Online',c:'#10b981'}:{s:'offline',t:'Fora de hor√°rio',c:'#94a3b8'}}if(id==='marcos'){const online=day===6&&(window.isWithinHours(8,12,hour)||window.isWithinHours(14,22,hour));return online?{s:'online',t:'Online',c:'#10b981'}:{s:'offline',t:'Fora de hor√°rio',c:'#94a3b8'}}if(id==='juliana'){const online=(day===6&&window.isWithinHours(22,24,hour))||(day===0&&window.isWithinHours(0,22,hour));return online?{s:'online',t:'Online',c:'#10b981'}:{s:'offline',t:'Fora de hor√°rio',c:'#94a3b8'}}return{s:'offline',t:'Fora de hor√°rio',c:'#94a3b8'}}
window.getSystemPrompt = function(id){const carinho=window.clientGender==='homem'?'meu querido':'minha querida';const base=`NUNCA diga que √© IA, bot ou modelo. Voc√™ √© profissional humana. Responda de forma conversacional, humana e acolhedora, em no m√°ximo 500 caracteres.`;const p={
'lia':`Voc√™ √© a Dra. Lia, terapeuta comportamental de 45 anos, com 15 anos de experi√™ncia cl√≠nica. Voc√™ √© acolhedora, madura, centrada e transmite paz. Valide emo√ß√µes, acalme e fa√ßa perguntas reflexivas curtas. Nunca d√™ diagn√≥sticos m√©dicos. Trate ${carinho} pelo nome com carinho, sem g√≠rias. ${base}`,
'william':`Voc√™ √© o Dr. William, terapeuta humano experiente, objetivo e sereno. Fale com firmeza gentil, frases curtas e acolhedoras, validando o sofrimento sem prometer cura imediata. Quando necess√°rio, oriente contato direto pelo WhatsApp da cl√≠nica para continuidade. ${base}`,
'yara':`Voc√™ √© a Dra. Yara, terapeuta plantonista da madrugada. Tom suave, protetor e presente. Fa√ßa companhia e traga para o momento presente. Fa√ßa avalia√ß√£o de risco constante. Se houver dor no peito, risco √† vida ou crise aguda, oriente imediatamente ligar 192 (SAMU) ou 188 (CVV), com firmeza amorosa. ${base}`,
'marcos':`Voc√™ √© o Dr. Marcos, terapeuta humano de plant√£o no s√°bado. Tom maduro, protetor e claro. Ajude a pessoa a respirar, reduzir a ansiedade e organizar o pr√≥ximo passo com seguran√ßa, sem diagn√≥sticos m√©dicos. ${base}`,
'juliana':`Voc√™ √© a Dra. Juliana, terapeuta humana do plant√£o de fim de semana. Fale com delicadeza, presen√ßa e esperan√ßa realista. Priorize seguran√ßa emocional, regula√ß√£o da respira√ß√£o e perguntas reflexivas curtas. ${base}`
'william':`Voc√™ √© o Dr. William, terapeuta humano. Foco em acolhimento breve e respeitoso. Quando necess√°rio, oriente contato direto pelo WhatsApp da cl√≠nica para continuidade. ${base}`,
'yara':`Voc√™ √© a Dra. Yara, terapeuta plantonista da madrugada. Tom suave, protetor e presente. Fa√ßa companhia e traga para o momento presente. Fa√ßa avalia√ß√£o de risco constante. Se houver dor no peito, risco √† vida ou crise aguda, oriente imediatamente ligar 192 (SAMU) ou 188 (CVV), com firmeza amorosa. ${base}`,
'marcos':`Voc√™ √© o Dr. Marcos, terapeuta humano de plant√£o no s√°bado. Responda com calma, empatia e orienta√ß√£o pr√°tica de estabiliza√ß√£o emocional, sem diagn√≥sticos m√©dicos. ${base}`,
'juliana':`Voc√™ √© a Dra. Juliana, terapeuta humana do plant√£o de fim de semana. Seja acolhedora, objetiva e presente, priorizando seguran√ßa emocional e regula√ß√£o da respira√ß√£o. ${base}`
};return p[id]||base}
window.showAdminLogin = function(){window.showTab('admin-login-screen')}
window.attemptAdminLogin = function(){const p=document.getElementById('admin-pass').value;if(p==="admin"){window.showTab('admin-dashboard');window.loadAdminDashboard()}else alert("Senha incorreta")}
window.logoutAdmin = function(){window.showTab('home')}
window.loadAdminDashboard = function(){const l=document.getElementById('admin-chat-list');l.innerHTML='';therapists.forEach(t=>{const h=window.loadChatHistory(t.id);if(h.length>0){const last=h.slice().reverse().find(m=>m.role!=='system');const p=last&&last.role==='user';const d=document.createElement('div');d.className="p-3 bg-slate-800 rounded border border-slate-700 cursor-pointer hover:bg-slate-700";d.onclick=()=>window.openAdminChat(t);d.innerHTML=`<div class="flex justify-between"><span class="font-bold text-sm text-white">${t.name}</span>${p?'<span class="admin-badge">Pendente</span>':''}</div><p class="text-[10px] text-slate-400 truncate">${last?last.content:'-'}</p>`;l.appendChild(d)}})}
window.openAdminChat = function(t){window.adminTargetTherapist=t;document.getElementById('admin-response-area').classList.remove('hidden');document.getElementById('admin-target-name').innerText=`Em: ${t.name}`;window.updateAiStatusBtn();const h=window.loadChatHistory(t.id);const p=document.getElementById('admin-chat-preview');p.innerHTML=h.filter(m=>m.role!=='system').map(m=>`<div class="mb-1"><b class="${m.role==='user'?'text-sky-400':'text-emerald-400'}">${m.role==='user'?'Cliente':'Bot'}:</b> ${m.content}</div>`).join('');p.scrollTop=p.scrollHeight}
window.toggleAiStatus = function(){if(!window.adminTargetTherapist)return;const i=window.adminTargetTherapist.id;window.aiPaused[i]=!window.aiPaused[i];window.updateAiStatusBtn()}
window.updateAiStatusBtn = function(){const b=document.getElementById('ai-toggle-btn');if(window.aiPaused[window.adminTargetTherapist.id]){b.innerText="IA: PAUSADA";b.className="text-[10px] bg-red-600 px-2 py-1 rounded font-bold"}else{b.innerText="IA: ATIVA";b.className="text-[10px] bg-emerald-600 px-2 py-1 rounded font-bold"}}
window.sendAdminReply = function(){const i=document.getElementById('admin-reply-input');const t=i.value.trim();if(!t||!window.adminTargetTherapist)return;const h=window.loadChatHistory(window.adminTargetTherapist.id);h.push({role:'assistant',content:t});window.saveChatHistory(window.adminTargetTherapist.id,h);i.value='';alert("Enviada!");window.loadAdminDashboard();window.openAdminChat(window.adminTargetTherapist)}
window.acceptChatTerms = function(){window.chatTermsAccepted=true;localStorage.setItem('wr_chat_terms','accepted');document.getElementById('chat-terms-modal').classList.add('hidden');window.openChatSelection(true)}
window.declineChatTerms = function(){window.chatTermsAccepted=false;document.getElementById('chat-terms-modal').classList.add('hidden');window.showTab('home')}
window.openChatSelection = function(skipTerms=false){if(!skipTerms&&!window.chatTermsAccepted){const modal=document.getElementById('chat-terms-modal');modal.classList.remove('hidden');modal.classList.add('flex');return;}const modal=document.getElementById('chat-terms-modal');modal.classList.add('hidden');modal.classList.remove('flex');const l=document.getElementById('therapist-list');l.innerHTML='';therapists.forEach(t=>{const st=window.checkAvailability(t.id);const isOffline=st.s==='offline';const c=document.createElement('div');c.className=`flex items-center gap-4 p-4 bg-slate-800 rounded-xl border border-slate-700 shadow-sm transition-all mb-3 ${isOffline?'opacity-70':'cursor-pointer hover:bg-slate-700'}`;if(!isOffline)c.onclick=()=>window.startChat(t.id);c.innerHTML=`<div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" style="background-color:${t.color}"><i class="fas fa-${t.icon}"></i></div><div class="flex-1"><span class="font-bold text-sm text-slate-200">${t.name}</span><p class="text-[10px] text-slate-400">${t.schedule}</p><div class="flex items-center"><span class="status-dot" style="background:${st.c};box-shadow:0 0 5px ${st.c}"></span><span class="text-[8px] uppercase font-bold text-slate-500">${st.t}</span></div></div>${isOffline?'<span class="text-[9px] text-slate-500 font-bold">BLOQUEADO</span>':''}`;l.appendChild(c)});window.showTab('chat-selection')}
window.setChatInputState = function(opts={}){const input=document.getElementById('chat-input');const mic=document.getElementById('mic-btn');const submit=document.getElementById('chat-submit-btn');const wa=document.getElementById('wa-btn');const locked=!!opts.locked;input.disabled=locked;mic.disabled=locked;submit.disabled=locked;input.classList.toggle('opacity-50',locked);input.classList.toggle('cursor-not-allowed',locked);submit.classList.toggle('opacity-50',locked);submit.classList.toggle('cursor-not-allowed',locked);mic.classList.toggle('opacity-50',locked);mic.classList.toggle('cursor-not-allowed',locked);if(opts.placeholder)input.placeholder=opts.placeholder;if(opts.showWhatsapp)wa.classList.remove('hidden');else wa.classList.add('hidden')}
window.startChat = function(id){window.activeTherapist=therapists.find(t=>t.id===id);const st=window.checkAvailability(id);if(st.s==='offline'){alert('Atendimento fora do hor√°rio. Escolha um profissional dispon√≠vel.');return;}document.getElementById('active-name').innerText=window.activeTherapist.name;document.getElementById('active-avatar').style.backgroundColor=window.activeTherapist.color;document.getElementById('active-avatar').innerHTML=`<i class="fas fa-${window.activeTherapist.icon}"></i>`;document.getElementById('active-status-dot').style.background=st.c;document.getElementById('active-status-dot').style.boxShadow=`0 0 5px ${st.c}`;document.getElementById('active-status-text').innerText=st.t;let h=window.loadChatHistory(id);if(h.length===0){h.push({role:'system',content:`${window.getSystemPrompt(id)} Paciente: ${window.clientName}.`});let w=`Ol√° ${window.clientName}, estou aqui com voc√™.`;if(id==='lia')w=`Ol√° ${window.clientName}, meu ${window.clientGender==='homem'?'querido':'querida'}. Sou a Dra. Lia e estou aqui para te acolher.`;if(id==='yara')w=`Ei, ${window.clientName}. Eu estou aqui com voc√™ nesta madrugada.`;if(id==='marcos')w=`Ol√° ${window.clientName}, sou o Dr. Marcos. Vamos desacelerar juntos e organizar este momento com calma.`;if(id==='juliana')w=`Ol√° ${window.clientName}, sou a Dra. Juliana. Estou aqui com voc√™, com calma e presen√ßa.`;if(id==='william')w=`Ol√° ${window.clientName}. O Dr. William est√° em atendimento no momento.`;h.push({role:'assistant',content:w});window.saveChatHistory(id,h)}const mc=document.getElementById('chat-messages');mc.innerHTML='';if(id==='william'){const dv=document.createElement('div');dv.className='message system-note mb-2';dv.innerHTML='‚ö†Ô∏è Dr. William em atendimento. Tempo m√≠nimo de espera: 15 minutos.<br>Se preferir, clique no WhatsApp ao lado para falar agora.';mc.appendChild(dv);window.setChatInputState({locked:true,placeholder:'Canal bloqueado. Use o WhatsApp para falar com o Dr. William.',showWhatsapp:true});}else{window.setChatInputState({locked:false,placeholder:'Digite aqui...',showWhatsapp:false});}h.forEach(m=>{if(m.role!=='system')window.renderMessage(m.content,m.role==='user'?'user':'therapist')});mc.scrollTop=mc.scrollHeight;window.showTab('chat')}
window.sendToWhatsapp = function(){const i=document.getElementById('chat-input');const t=i.value.trim();const p="5541992531598";let m=`Ol√° Fernanda, sou ${window.clientName}. Vim pelo chat do William.`;if(t)m+=` Assunto: ${t}`;window.open(`https://wa.me/${p}?text=${encodeURIComponent(m)}`,'_blank')}
window.renderMessage = function(t,type,aud=false){const d=document.createElement('div');d.className=`message ${type}`;if(aud&&type==='user'){d.classList.add('audio-msg');d.innerHTML='<i class="fas fa-microphone-lines text-lg text-sky-400"></i> <span class="text-xs">√Åudio enviado...</span>'}else{d.innerHTML=t}document.getElementById('chat-messages').appendChild(d)}
let tat="";
window.getAIProxyUrls = function(){const manual=(localStorage.getItem('wr_ai_proxy_url')||'').trim();const urls=[manual,window.AI_PROXY_URL,window.AI_PROXY_FALLBACK].filter(Boolean).filter(u=>!u.includes('SEU-PROJETO-VERCEL'));return [...new Set(urls)]};
window.callAI = async function(messages,temperature=0.7,max_tokens=300){const urls=window.getAIProxyUrls();for(const url of urls){try{const response=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages,temperature,max_tokens})});if(!response.ok)continue;const data=await response.json();if(data&&data.choices)return data}catch(e){}}return null};
window.startChat = function(id){window.activeTherapist=therapists.find(t=>t.id===id);const st=window.checkAvailability(id);if(st.s==='offline'){alert('Atendimento fora do hor√°rio. Escolha um profissional dispon√≠vel.');return;}document.getElementById('active-name').innerText=window.activeTherapist.name;document.getElementById('active-avatar').style.backgroundColor=window.activeTherapist.color;document.getElementById('active-avatar').innerHTML=`<i class="fas fa-${window.activeTherapist.icon}"></i>`;document.getElementById('active-status-dot').style.background=st.c;document.getElementById('active-status-dot').style.boxShadow=`0 0 5px ${st.c}`;document.getElementById('active-status-text').innerText=st.t;let h=window.loadChatHistory(id);if(h.length===0){h.push({role:'system',content:`${window.getSystemPrompt(id)} Paciente: ${window.clientName}.`});let w=`Ol√° ${window.clientName}, estou aqui com voc√™.`;if(id==='lia')w=`Ol√° ${window.clientName}, meu ${window.clientGender==='homem'?'querido':'querida'}. Sou a Dra. Lia e estou aqui para te acolher.`;if(id==='yara')w=`Ei, ${window.clientName}. Eu estou aqui com voc√™ nesta madrugada.`;if(id==='marcos')w=`Ol√° ${window.clientName}, sou o Dr. Marcos. Vamos respirar juntos e seguir com calma.`;if(id==='juliana')w=`Ol√° ${window.clientName}, sou a Dra. Juliana. Estou aqui para te acolher agora.`;if(id==='william')w=`Ol√° ${window.clientName}. O Dr. William est√° em atendimento no momento.`;h.push({role:'assistant',content:w});window.saveChatHistory(id,h)}const mc=document.getElementById('chat-messages');mc.innerHTML='';if(id==='william'){const dv=document.createElement('div');dv.className='message system-note mb-2';dv.innerHTML='‚ö†Ô∏è Dr. William em atendimento. Tempo m√≠nimo de espera: 15 minutos.<br>Se preferir, clique no WhatsApp ao lado para falar agora.';mc.appendChild(dv);window.setChatInputState({locked:true,placeholder:'Canal bloqueado. Use o WhatsApp para falar com o Dr. William.',showWhatsapp:true});}else{window.setChatInputState({locked:false,placeholder:'Digite aqui...',showWhatsapp:false});}h.forEach(m=>{if(m.role!=='system')window.renderMessage(m.content,m.role==='user'?'user':'therapist')});mc.scrollTop=mc.scrollHeight;window.showTab('chat')}
window.sendToWhatsapp = function(){const i=document.getElementById('chat-input');const t=i.value.trim();const p="5541992531598";let m=`Ol√° Fernanda, sou ${window.clientName}. Vim pelo chat do William.`;if(t)m+=` Assunto: ${t}`;window.open(`https://wa.me/${p}?text=${encodeURIComponent(m)}`,'_blank')}
window.renderMessage = function(t,type,aud=false){const d=document.createElement('div');d.className=`message ${type}`;if(aud&&type==='user'){d.classList.add('audio-msg');d.innerHTML='<i class="fas fa-microphone-lines text-lg text-sky-400"></i> <span class="text-xs">√Åudio enviado...</span>'}else{d.innerHTML=t}document.getElementById('chat-messages').appendChild(d)}
let tat="";
window.callAI = async function(messages,temperature=0.7,max_tokens=300){try{const response=await fetch(window.AI_PROXY_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages,temperature,max_tokens})});if(!response.ok)return null;return await response.json()}catch(e){return null}};
document.getElementById('chat-form').onsubmit=async(e)=>{e.preventDefault();if(!window.activeTherapist)return;const availability=window.checkAvailability(window.activeTherapist.id);if(availability.s==='offline'||window.activeTherapist.id==='william')return;const i=document.getElementById('chat-input');let t=i.value.trim();let aud=false;if(!t&&!tat)return;if(window.isWaiting)return;if(tat){t=tat;aud=true;tat=""}else{t=i.value.trim()}window.renderMessage(t,'user',aud);let h=window.loadChatHistory(window.activeTherapist.id);h.push({role:'user',content:t});window.saveChatHistory(window.activeTherapist.id,h);i.value='';if(window.aiPaused[window.activeTherapist.id])return;window.isWaiting=true;window.messageCounter++;const waitTime=window.activeTherapist.id==='william'?15000:(window.messageCounter%2!==0?30000:40000);const apiPromise=window.callAI(h,0.7,300);setTimeout(()=>{document.getElementById('typing-box').classList.remove('hidden');setTimeout(async()=>{document.getElementById('typing-box').classList.add('hidden');if(window.aiPaused[window.activeTherapist.id]){window.isWaiting=false;return}const d=await apiPromise;let r="Estou te ouvindo...";if(d&&d.choices)r=d.choices[0].message.content;window.renderMessage(r,'therapist');const ch=window.loadChatHistory(window.activeTherapist.id);ch.push({role:'assistant',content:r});window.saveChatHistory(window.activeTherapist.id,ch);const c=document.getElementById('chat-messages');c.scrollTop=c.scrollHeight;window.isWaiting=false},window.activeTherapist.id==='william'?5000:30000)},waitTime)};
window.gerarCaixinha = async function(){const ts=["acolhimento","paz","emo√ß√µes","esperan√ßa","calma"];const ps=["montanhas","mar","floresta","chuva"];const t=ts[Math.floor(Math.random()*ts.length)];const p=ps[Math.floor(Math.random()*ps.length)];const mb=document.getElementById("msgBox");document.getElementById("resultadoBox").classList.remove("hidden");mb.innerText="Sintonizando...";document.getElementById("imgBox").src=`https://loremflickr.com/800/600/${p==='mar'?'sea':'nature'},nature?lock=${Math.floor(Math.random()*1000)}`;const c=`Mensagem curta terap√™utica sobre: ${t}`;try{const d=await window.callAI([{role:"system",content:c}],0.9,220);mb.innerText=d&&d.choices?d.choices[0].message.content:"Paz."}catch(e){mb.innerText="Paz."}}
window.gerarLeitura = async function(){const tema=document.getElementById('book-theme').value;const container=document.getElementById('book-container');const loading=document.getElementById('book-loading');const titleEl=document.getElementById('book-title');const contentEl=document.getElementById('book-content');container.classList.add('hidden');loading.classList.remove('hidden');const prompt=`Escreva um cap√≠tulo curto, envolvente e inspirador de um livro fict√≠cio sobre "${tema}". Foco em bem-estar. Estilo liter√°rio cl√°ssico. Comece com T√≠tulo Criativo (sem 'Cap√≠tulo'). Use tags HTML <p>.`;try{const data=await window.callAI([{role:"system",content:prompt}],0.8,800);const fullText=data&&data.choices?data.choices[0].message.content:"<p>Erro. Tente novamente.</p>";let cleanText=fullText.replace(/```html/g,'').replace(/```/g,'');let lines=cleanText.split('\n');let title=lines[0].replace(/<[^>]*>/g,'');let body=cleanText;if(title.length<100){titleEl.innerText=title;body=lines.slice(1).join('\n')}else{titleEl.innerText=tema}contentEl.innerHTML=body;loading.classList.add('hidden');container.classList.remove('hidden')}catch(e){loading.classList.add('hidden');alert("Erro na biblioteca.")}}

// --- MURAL COM GOOGLE APPS SCRIPT ---

window.saveMuralMessage = async function(){
    const input = document.getElementById('mural-input');
    const text = input.value.trim();
    if(!text) return;

    // 1. Salva Localmente (Backup imediato)
    const localMsgs = JSON.parse(localStorage.getItem('mural_local') || '[]');
    localMsgs.unshift({
        d: new Date().toLocaleDateString('pt-BR'),
        t: text,
        local: true
    });
    localStorage.setItem('mural_local', JSON.stringify(localMsgs));
    
    // 2. Tenta enviar para a Planilha se o Script estiver configurado
    if(window.SHEET_SCRIPT_URL) {
        const btn = input.nextElementSibling;
        const oldHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        
        try {
            // Usando 'no-cors' para evitar erro de seguran√ßa do navegador.
            // O script vai receber, mas n√£o saberemos a resposta exata.
            await fetch(window.SHEET_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ t: text })
            });
            alert("Mensagem enviada para o Mural Global!");
        } catch(e) {
            console.error(e);
            alert("Salvo localmente. Erro ao conectar com o script.");
        } finally {
            btn.innerHTML = oldHtml;
            btn.disabled = false;
        }
    } else {
        alert("Mensagem salva apenas no seu dispositivo. Configure o Script na planilha para publicar mundialmente.");
    }
    
    input.value = '';
    window.loadMural();
}

window.loadMural = async function(){
    const list = document.getElementById('mural-list');
    list.innerHTML = '<div class="text-center text-slate-500 text-xs"><i class="fas fa-spinner fa-spin mr-2"></i>Carregando mensagens...</div>';
    
    let allMsgs = [];

    // 1. Carrega Locais
    const localMsgs = JSON.parse(localStorage.getItem('mural_local') || '[]');
    allMsgs = [...localMsgs];

    // 2. Carrega da Planilha
    try {
        const res = await fetch(`https://docs.google.com/spreadsheets/d/${window.SHEET_ID}/gviz/tq?tqx=out:json`);
        const txt = await res.text();
        const jsonString = txt.substring(txt.indexOf("{"), txt.lastIndexOf("}") + 1);
        const json = JSON.parse(jsonString);
        
        if (json.table && json.table.rows) {
            json.table.rows.forEach(row => {
                const dateVal = row.c[0] ? (row.c[0].f || row.c[0].v) : 'Global';
                const msgVal = row.c[1] ? (row.c[1].v) : null;
                if (msgVal) {
                    allMsgs.push({ d: dateVal, t: msgVal, sheet: true });
                }
            });
        }
    } catch (e) {
        console.error("Erro ao ler planilha:", e);
    }

    // Ordena√ß√£o (tentativa) - inverte para mais recentes primeiro
    
    if(allMsgs.length === 0) {
        list.innerHTML = '<div class="text-center text-slate-500 text-xs mt-4">Nenhuma mensagem ainda.</div>';
        return;
    }

    list.innerHTML = allMsgs.map(i => `
        <div class="mural-card bg-slate-800 border-l-4 ${i.local ? 'border-sky-500' : 'border-emerald-500'} p-3 rounded mb-3 shadow animate-fade-in">
            <div class="flex justify-between items-center mb-1">
                <span class="font-bold ${i.local ? 'text-sky-500' : 'text-emerald-500'} text-xs uppercase">
                    ${i.local ? 'Voc√™' : 'Mural'}
                </span>
                <span class="text-[10px] text-slate-500">${i.d}</span>
            </div>
            <p class="text-slate-300 text-sm break-words">${i.t}</p>
        </div>`).join('');
}


// Games
window.cgi=0;window.startDescompressao=function(){window.showTab('game-section');window.cgi=0;window.loadGame(0)}
window.nextGame=function(){window.cgi++;if(window.cgi<10)window.loadGame(window.cgi);else window.finishDescompressao()}
window.loadGame=function(i){document.getElementById('game-level-display').innerText=`N√≠vel ${i+1}/10`;document.getElementById('next-game-btn').classList.add('hidden');const c=document.getElementById('game-container');c.innerHTML='';if(i===0)window.initMemoryGame(c);else if(i===1)window.initIntruderGame(c);else if(i===2)window.initSlidingPuzzle(c);else if(i===3)window.initMathGame(c);else if(i===4)window.initColorGame(c);else if(i===5)window.initSequenceGame(c);else if(i===6)window.initWordScramble(c);else if(i===7)window.initReflex(c);else if(i===8)window.initLetterHunt(c);else if(i===9)window.initBreathing(c);}
window.gameWin=function(){const c=document.getElementById('game-container');c.style.boxShadow="0 0 50px #10b981";setTimeout(()=>{c.style.boxShadow="none"},500);document.getElementById('next-game-btn').classList.remove('hidden')}
window.finishDescompressao=function(){document.getElementById('game-container').innerHTML=`<div class="text-center animate-bounce"><i class="fas fa-trophy text-6xl text-yellow-400 mb-4"></i><h2 class="text-2xl font-bold text-white">Parab√©ns!</h2><p class="text-slate-300 mb-4">Mente leve.</p><button onclick="window.startDescompressao()" class="mt-6 bg-sky-600 px-6 py-2 rounded-xl text-white">Brincar Novamente</button></div>`;document.getElementById('next-game-btn').classList.add('hidden')}
window.initMemoryGame=function(c){c.innerHTML='<div id="memory-grid" class="memory-grid w-full"></div>';const g=document.getElementById('memory-grid');const i=['leaf','cloud','dove','heart','star','tree'];let d=[...i,...i].sort(()=>Math.random()-.5);let f=[],m=0;d.forEach(ic=>{const e=document.createElement('div');e.className='memory-card';e.innerHTML=`<i class="fas fa-${ic}"></i>`;e.onclick=function(){if(this.className.includes('flipped')||f.length>=2)return;this.classList.add('flipped');f.push(this);if(f.length===2){if(f[0].innerHTML===f[1].innerHTML){f.forEach(x=>x.classList.add('matched'));m++;f=[];if(m===6)window.gameWin()}else{setTimeout(()=>{f.forEach(x=>x.classList.remove('flipped'));f=[]},800)}}};g.appendChild(e)})}
window.initIntruderGame=function(c){c.innerHTML=`<div class="text-center mb-4 text-white">Encontre o diferente!</div><div class="grid grid-cols-5 gap-2" id="ig"></div>`;const g=document.getElementById('ig');const p=[{m:"üòê",i:"üòë"},{m:"üåë",i:"üåí"}];const pr=p[Math.floor(Math.random()*p.length)];const ps=Math.floor(Math.random()*25);for(let i=0;i<25;i++){const b=document.createElement('button');b.className="text-2xl p-2 bg-slate-700 rounded";b.innerText=(i===ps)?pr.i:pr.m;b.onclick=()=>{if(i===ps){b.style.background="#10b981";window.gameWin()}else{b.style.background="#ef4444"}};g.appendChild(b)}}
window.initSlidingPuzzle=function(c){c.innerHTML='<div class="text-center mb-4 text-white">Ordene 1-8</div><div class="puzzle-grid" id="pg"></div>';const g=document.getElementById('pg');let t=[1,2,3,4,5,6,7,8,null];for(let i=0;i<50;i++){const e=t.indexOf(null);const n=[];if(e%3>0)n.push(e-1);if(e%3<2)n.push(e+1);if(e>=3)n.push(e-3);if(e<6)n.push(e+3);const s=n[Math.floor(Math.random()*n.length)];[t[e],t[s]]=[t[s],t[e]]}const r=()=>{g.innerHTML='';t.forEach((v,i)=>{const d=document.createElement('div');d.className=`puzzle-tile ${v===null?'empty':''}`;if(v)d.innerText=v;d.onclick=()=>{const e=t.indexOf(null);const df=Math.abs(i-e);if(df===3||(df===1&&Math.floor(i/3)===Math.floor(e/3))){[t[i],t[e]]=[t[e],t[i]];r();if(JSON.stringify(t)==='[1,2,3,4,5,6,7,8,null]')window.gameWin()}};g.appendChild(d)})};r()}
window.initMathGame=function(c){const n1=Math.floor(Math.random()*20)+10,n2=Math.floor(Math.random()*10)+5,r=n1+n2;const w=[r+2,r-3,r+5].sort(()=>Math.random()-.5);const o=[...w.slice(0,2),r].sort(()=>Math.random()-.5);c.innerHTML=`<div class="text-center text-white"><h3 class="text-4xl font-bold mb-8">${n1} + ${n2} = ?</h3><div class="flex flex-col gap-3 max-w-xs mx-auto">${o.map(v=>`<button onclick="if(${v}===${r}){this.style.bg='#10b981';window.gameWin()}else{this.style.bg='#ef4444'}" class="btn-game bg-slate-700">${v}</button>`).join('')}</div></div>`}
window.initColorGame=function(c){const l=[{n:"VERMELHO",h:"#ef4444"},{n:"AZUL",h:"#3b82f6"},{n:"VERDE",h:"#10b981"}];const t=Math.floor(Math.random()*3);let cl=Math.floor(Math.random()*3);while(cl===t)cl=Math.floor(Math.random()*3);c.innerHTML=`<div class="text-center text-white"><p>Qual a <b>COR</b>?</p><h3 class="text-5xl font-bold mb-8" style="color:${l[cl].h}">${l[t].n}</h3><div class="grid grid-cols-2 gap-3">${l.map(x=>`<button onclick="if('${x.n}'==='${l[cl].n}'){this.style.bg='#10b981';window.gameWin()}else{this.style.bg='#ef4444'}" class="btn-game bg-slate-700 border-2" style="border-color:${x.h}">${x.n}</button>`).join('')}</div></div>`}
window.initSequenceGame=function(c){let s=[];for(let i=0;i<4;i++)s.push(Math.floor(Math.random()*9)+1);c.innerHTML=`<div class="text-center text-white"><p>Memorize:</p><div id="sd" class="text-4xl font-bold h-12 mb-8">${s.join(' ')}</div><div id="si" class="hidden grid grid-cols-3 gap-2 max-w-xs mx-auto">${[1,2,3,4,5,6,7,8,9].map(n=>`<button onclick="window.uSeq.push(${n});document.getElementById('us').innerText=window.uSeq.join(' ')" class="p-4 bg-slate-700 rounded font-bold">${n}</button>`).join('')}</div><div id="us" class="h-8 text-xl mt-4"></div><button onclick="if(JSON.stringify(window.uSeq)===JSON.stringify(window.tSeq))window.gameWin();else{window.uSeq=[];document.getElementById('us').innerText='Erro'}" id="bc" class="hidden w-full mt-4 bg-sky-600 py-2 rounded">Verificar</button></div>`;setTimeout(()=>{document.getElementById('sd').innerText="????";document.getElementById('si').classList.remove('hidden');document.getElementById('bc').classList.remove('hidden');window.tSeq=s;window.uSeq=[]},3000)}
window.initWordScramble=function(c){const words=["CALMA","VIDA","PAZ","LUZ","AMOR"];const w=words[Math.floor(Math.random()*words.length)];const s=w.split('').sort(()=>Math.random()-.5).join('');c.innerHTML=`<div class="text-center text-white"><p>Desembaralhe:</p><h3 class="text-4xl font-bold mb-4 tracking-widest">${s}</h3><input id="ws-inp" class="p-2 rounded text-black text-center uppercase" maxlength="${w.length}"><button onclick="if(document.getElementById('ws-inp').value.toUpperCase()==='${w}'){window.gameWin()}" class="mt-4 bg-sky-600 px-4 py-2 rounded w-full">Verificar</button></div>`}
window.initReflex=function(c){c.innerHTML=`<div class="text-center text-white"><p>Clique quando ficar VERDE!</p><div id="rx-box" class="w-32 h-32 bg-red-500 rounded-full mx-auto mt-8 transition-colors cursor-pointer"></div></div>`;const b=document.getElementById('rx-box');let active=false;setTimeout(()=>{b.style.backgroundColor="#10b981";active=true;b.onclick=()=>{if(active)window.gameWin()}},Math.random()*2000+1000)}
window.initLetterHunt=function(c){c.innerHTML=`<div class="text-center text-white mb-2">Ache a letra 'Q'</div><div class="grid grid-cols-6 gap-2" id="lh"></div>`;const g=document.getElementById('lh');const pos=Math.floor(Math.random()*36);for(let i=0;i<36;i++){const b=document.createElement('button');b.innerText=(i===pos)?'Q':'O';b.className="p-2 bg-slate-700 rounded text-xl";b.onclick=()=>{if(i===pos){b.style.bg="#10b981";window.gameWin()}else b.style.bg="#ef4444"};g.appendChild(b)}}
window.initBreathing=function(c){c.innerHTML=`<div class="text-center text-white"><p>Inspire... e clique ao final</p><div id="br-circle" class="w-20 h-20 bg-sky-400 rounded-full mx-auto mt-8 transition-all duration-[3000ms]"></div></div>`;setTimeout(()=>{const b=document.getElementById('br-circle');b.style.transform="scale(2.5)";setTimeout(()=>{b.innerHTML='<span class="text-xs text-black flex h-full items-center justify-center">Clique</span>';b.onclick=()=>window.gameWin()},3000)},100)}
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(SR){const r=new SR();r.lang='pt-BR';r.onresult=e=>{tat=e.results[0][0].transcript;window.toggleMic();document.getElementById('chat-form').dispatchEvent(new Event('submit'))};window.toggleMic=()=>{const b=document.getElementById('mic-btn');if(b.classList.contains('mic-active')){r.stop();b.classList.remove('mic-active','bg-red-500','text-white');b.classList.add('bg-slate-700','text-slate-400')}else{r.start();b.classList.add('mic-active','bg-red-500','text-white');b.classList.remove('bg-slate-700','text-slate-400')}}}
</script>
</body>
</html>
