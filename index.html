<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0f172a">
<title>Harmonia Diária - WR TERAPIA</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Quicksand:wght@400;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&display=swap');
:root{--bg-dark:#0f172a;--card-bg:#1e293b;--primary:#0ea5e9;--text-light:#f1f5f9;--text-dim:#94a3b8}*{box-sizing:border-box}body{font-family:'Inter',sans-serif;background-color:var(--bg-dark);color:var(--text-light);margin:0;padding:0;position:fixed;inset:0;display:flex;flex-direction:column}.heading-font{font-family:'Quicksand',sans-serif}.glass-card{background:rgba(30,41,59,0.98);border:1px solid rgba(255,255,255,0.1);border-radius:1.5rem;box-shadow:0 4px 6px -1px rgba(0,0,0,0.5)}main{flex:1;position:relative;width:100%;max-width:480px;margin:0 auto}.tab-content{display:none;position:absolute;inset:0;padding:1rem;overflow-y:auto;-webkit-overflow-scrolling:touch}.tab-content.active{display:flex;flex-direction:column;animation:fadeIn .3s ease-out}@keyframes fadeIn{from{opacity:0}to{opacity:1}}#chat.tab-content{padding:0;overflow:hidden}.chat-layout{display:flex;flex-direction:column;height:100%}.chat-messages-area{flex:1;overflow-y:auto;padding:1rem;background:rgba(15,23,42,0.5)}.message{max-width:85%;padding:12px 16px;border-radius:1.2rem;font-size:.95rem;line-height:1.5;margin-bottom:12px}.message.user{align-self:flex-end;background:var(--primary);color:#fff;border-bottom-right-radius:.2rem;margin-left:auto}.message.therapist{align-self:flex-start;background:#334155;color:#e2e8f0;border-bottom-left-radius:.2rem;margin-right:auto}.message.audio-msg{font-style:italic;display:flex;align-items:center;gap:8px;color:#cbd5e1}.message.system-note{align-self:center;background:rgba(239,68,68,0.2);color:#fca5a5;font-size:0.8rem;text-align:center;border:1px solid rgba(239,68,68,0.4);width:90%}.memory-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}.memory-card{background-color:#334155;height:60px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;border:2px solid #475569;color:transparent;transition:all .3s ease;transform-style:preserve-3d}.memory-card.flipped,.memory-card.matched{background-color:#f1f5f9;border-color:var(--primary);color:#333;transform:rotateY(180deg)}.memory-card.matched{background-color:#10b981;border-color:#059669;color:#fff;cursor:default}.puzzle-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;width:100%;aspect-ratio:1;background:#334155;padding:4px;border-radius:8px}.puzzle-tile{background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:bold;cursor:pointer;border-radius:4px;user-select:none;transition:transform .2s}.puzzle-tile.empty{background:transparent;cursor:default}.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px}.status-online{background-color:#10b981;box-shadow:0 0 5px #10b981}.status-busy{background-color:#f59e0b;box-shadow:0 0 5px #f59e0b}.status-offline{background-color:#94a3b8}.admin-trigger{opacity:.1;transition:opacity .3s;cursor:pointer}.admin-trigger:hover{opacity:1}
.book-page{background-color:#fdf6e3;color:#2c1810;font-family:'Merriweather',serif;padding:2rem;border-radius:4px;box-shadow:inset 20px 0 50px rgba(0,0,0,0.1),5px 5px 15px rgba(0,0,0,0.3);border-left:5px solid #d4c5b0;line-height:1.8;position:relative;overflow:hidden;min-height:400px}.book-page::before{content:"";position:absolute;top:0;bottom:0;left:0;width:100%;background:linear-gradient(90deg,rgba(0,0,0,0.05) 0%,rgba(0,0,0,0) 10%,rgba(0,0,0,0) 90%,rgba(0,0,0,0.05) 100%);pointer-events:none}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#475569;border-radius:2px}.btn-game{@apply w-full py-3 rounded-xl font-bold shadow-lg transition-all active:scale-95}input,select,textarea{background-color:#334155;color:#fff;border-color:#475569}input::placeholder,textarea::placeholder{color:#94a3b8}
/* Checkbox customizado */
.custom-checkbox input:checked + div { background-color: #10b981; border-color: #10b981; }
.custom-checkbox input:checked + div:after { content: ''; display: block; width: 5px; height: 10px; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); }
.slide-out { animation: slideOut 0.5s forwards; }
@keyframes slideOut { to { opacity: 0; transform: translateX(100%); height: 0; margin: 0; padding: 0; visibility: hidden; } }
.medal-gold { color: #fbbf24; filter: drop-shadow(0 0 3px rgba(251, 191, 36, 0.5)); }
.medal-silver { color: #94a3b8; filter: drop-shadow(0 0 3px rgba(148, 163, 184, 0.5)); }
.medal-bronze { color: #d97706; filter: drop-shadow(0 0 3px rgba(217, 119, 6, 0.5)); }
</style>
<script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
<header class="flex-none p-4 text-center bg-slate-900/95 backdrop-blur-md border-b border-slate-700 z-20 relative">
<button id="music-toggle" onclick="window.toggleMusic()" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-sky-400 transition-colors w-8 h-8 flex items-center justify-center rounded-full active:bg-slate-800"><i id="music-icon" class="fas fa-volume-mute"></i></button>
<h1 class="text-xl font-bold text-sky-400 heading-font text-center w-full">Espaço | WR Terapia®</h1>
</header>
<main>
<div id="bg-music-player" style="display:none;"></div>

<!-- Onboarding -->
<section id="onboarding" class="tab-content active">
    <div class="h-full flex flex-col items-center justify-center p-4">
        <div class="glass-card p-8 text-center w-full">
            <div class="w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center mb-6 mx-auto ring-2 ring-sky-500/50">
                <i class="fas fa-fingerprint text-sky-400 text-2xl"></i>
            </div>
            <h2 class="text-xl font-bold text-white mb-2 heading-font">Bem-vindo(a)</h2>
            <p class="text-[10px] text-slate-400 mb-6 uppercase tracking-widest font-bold">Identificação Segura</p>
            <div class="w-full mb-4 space-y-3">
                <select id="user-gender" class="w-full p-3 rounded-xl outline-none bg-slate-800 border border-slate-700 text-sm">
                    <option value="homem">Sou Homem</option>
                    <option value="mulher">Sou Mulher</option>
                </select>
                <div>
                    <label class="text-[9px] text-slate-500 uppercase font-bold text-left block mb-1">Seu Nome Real</label>
                    <input type="text" id="user-name-input" oninput="this.value=this.value.toUpperCase()" placeholder="NOME COMPLETO" class="w-full p-3 rounded-xl text-center uppercase font-bold outline-none border border-slate-700 bg-slate-800 focus:ring-2 focus:ring-sky-500 text-sm">
                </div>
                <div>
                    <label class="text-[9px] text-emerald-500 uppercase font-bold text-left block mb-1">Seu Apelido (Ranking Público)</label>
                    <input type="text" id="user-nick-input" oninput="this.value=this.value.toUpperCase()" placeholder="EX: FÊNIX_77" maxlength="15" class="w-full p-3 rounded-xl text-center uppercase font-bold outline-none border border-emerald-900/50 bg-slate-800 focus:ring-2 focus:ring-emerald-500 text-sm text-emerald-400">
                </div>
            </div>
            <button onclick="window.login()" class="w-full bg-sky-600 text-white py-3 rounded-xl font-bold shadow-lg mt-2 hover:bg-sky-500 transition-all">Acessar Espaço</button>
        </div>
    </div>
</section>

<!-- Home -->
<section id="home" class="tab-content"><div class="glass-card p-6 mb-4"><p class="text-xs text-slate-400">Olá,</p><h2 class="text-xl font-bold text-white heading-font mb-6 client-name">Visitante</h2><div class="grid grid-cols-2 gap-4"><button onclick="window.openChatSelection()" class="p-4 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-3 hover:bg-slate-700 transition-all"><i class="fas fa-comment-medical text-2xl text-sky-400"></i><span class="text-[10px] font-bold uppercase text-slate-300">Conversar</span></button><button onclick="window.showTab('natural-remedies')" class="p-4 bg-emerald-900/30 rounded-2xl border border-emerald-700/50 flex flex-col items-center gap-3 hover:bg-emerald-900/50 transition-all relative overflow-hidden"><div class="absolute top-0 right-0 bg-emerald-500 text-white text-[8px] font-bold px-2 py-1 rounded-bl-lg">RANKING</div><i class="fas fa-leaf text-2xl text-emerald-400"></i><span class="text-[10px] font-bold uppercase text-emerald-300">Remédios Naturais</span></button><button onclick="window.showTab('mural')" class="p-4 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-3 hover:bg-slate-700 transition-all"><i class="fas fa-comments text-2xl text-amber-400"></i><span class="text-[10px] font-bold uppercase text-slate-300">Mural</span></button><button onclick="window.showTab('hope')" class="p-4 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-3 hover:bg-slate-700 transition-all"><i class="fas fa-lightbulb text-2xl text-yellow-400"></i><span class="text-[10px] font-bold uppercase text-slate-300">Caixinha Surpresa</span></button></div><div class="grid grid-cols-2 gap-4 mt-4"><button onclick="window.showTab('relaxation')" class="p-4 bg-purple-900/30 rounded-2xl border border-purple-800/50 flex flex-col items-center gap-2 hover:bg-purple-900/50 transition-all"><i class="fas fa-spa text-xl text-purple-400"></i><span class="text-[9px] font-bold uppercase text-purple-300">Relaxar</span></button><button onclick="window.startDescompressao()" class="p-4 bg-rose-900/30 rounded-2xl border border-rose-800/50 flex flex-col items-center gap-2 hover:bg-rose-900/50 transition-all"><i class="fas fa-brain text-xl text-rose-400"></i><span class="text-[9px] font-bold uppercase text-rose-300">Descompressão</span></button></div><button onclick="window.showTab('library')" class="w-full mt-4 p-4 bg-indigo-900/30 rounded-2xl border border-indigo-800/50 flex flex-col items-center gap-2 hover:bg-indigo-900/50 transition-all"><i class="fas fa-book-open text-xl text-indigo-400"></i><span class="text-[9px] font-bold uppercase text-indigo-300">Biblioteca Mágica</span></button></div><div class="mt-auto pt-8 pb-4 text-center flex flex-col items-center justify-center gap-2"><p class="text-[9px] text-slate-600 uppercase font-bold tracking-widest">Desenvolvido por WR-TECNOLOGIA | William Ribeiro</p><i onclick="window.showAdminLogin()" class="fas fa-lock text-slate-700 text-xs admin-trigger" title="Admin"></i></div></section>

<!-- Natural Remedies -->
<section id="natural-remedies" class="tab-content"><div class="glass-card p-5 h-full flex flex-col"><div class="flex items-center gap-3 mb-4 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button><div><h2 class="font-bold text-emerald-400">Remédios Naturais</h2><p class="text-[10px] text-slate-500">Cada tarefa vale 10 pontos no Ranking!</p></div></div><div id="remedies-list" class="flex-1 overflow-y-auto space-y-2 mb-4 pr-1"></div><div class="flex-none pt-2 border-t border-slate-700"><div class="flex justify-between items-center mb-3"><div class="flex flex-col"><span class="text-[10px] text-slate-400 uppercase font-bold">Ranking como:</span><span id="display-ranking-nick" class="text-xs font-bold text-emerald-400">APELIDO</span></div><div class="text-right"><span class="text-[10px] text-slate-400 uppercase font-bold">Soma Hoje:</span><div id="daily-points" class="text-xl font-bold text-emerald-400">0</div></div></div><div class="bg-slate-900 rounded-xl p-3 border border-slate-700 flex-1 min-h-[180px] flex flex-col"><div class="flex justify-between items-center border-b border-slate-800 pb-2 mb-2"><h3 class="text-[10px] font-bold text-slate-500 uppercase">Top Guerreiros (Mês)</h3><button onclick="window.loadRanking()" class="text-[8px] text-sky-500 uppercase font-bold tracking-tighter">Sincronizar <i class="fas fa-sync-alt ml-1"></i></button></div><div id="ranking-list" class="space-y-1 overflow-y-auto flex-1"></div></div></div></div></section>

<!-- Library -->
<section id="library" class="tab-content"><div class="glass-card p-4 h-full flex flex-col"><div class="flex items-center gap-3 mb-4 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-indigo-400">Biblioteca Mágica</h2></div><div class="mb-4 text-center flex-none"><p class="text-xs text-slate-400 mb-2">IA escrevendo para você.</p></div><div class="flex-none mb-4"><select id="book-theme" class="w-full p-3 rounded-xl text-sm bg-slate-800 text-slate-200 border border-slate-600 focus:ring-2 focus:ring-indigo-500"><option value="Autoconhecimento">Autoconhecimento</option><option value="Resiliência">Resiliência</option><option value="Ansiedade e Calma">Ansiedade e Calma</option><option value="Relacionamentos Saudáveis">Relacionamentos Saudáveis</option><option value="Propósito de Vida">Propósito de Vida</option></select><button onclick="window.gerarLeitura()" class="w-full mt-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl shadow-lg">Escrever Capítulo</button></div><div id="book-container" class="flex-1 overflow-y-auto hidden"><div class="book-page"><h3 id="book-title" class="text-xl font-bold mb-4 text-center border-b border-stone-400 pb-2"></h3><div id="book-content" class="text-sm text-justify"></div></div></div><div id="book-loading" class="hidden flex-1 flex flex-col items-center justify-center text-indigo-300"><i class="fas fa-feather-alt fa-spin text-4xl mb-3"></i><p class="text-sm">Escrevendo...</p></div></div></section>

<!-- Outras seções básicas (Chat, Mural, etc) -->
<section id="admin-login-screen" class="tab-content justify-center items-center"><div class="glass-card p-6 w-full text-center"><div class="flex justify-between items-center mb-4"><button onclick="window.showTab('home')" class="text-slate-400"><i class="fas fa-arrow-left"></i></button><h2 class="font-bold text-white text-sm">Acesso Admin</h2><div class="w-4"></div></div><input type="password" id="admin-pass" placeholder="Senha" class="w-full p-3 mb-4 rounded-xl text-center bg-slate-800 border border-slate-700 text-sm"><button onclick="window.attemptAdminLogin()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold text-sm">Entrar</button></div></section>

<section id="chat-selection" class="tab-content"><div class="glass-card p-6 h-full overflow-y-auto"><div class="flex items-center gap-3 mb-4"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-sky-400 text-lg">Nossa Equipe</h2></div><div id="therapist-list" class="space-y-3 pb-20"></div></div></section>

<section id="chat" class="tab-content"><div class="chat-layout h-full"><div class="p-4 border-b border-slate-700 flex items-center gap-3 bg-slate-800/95 flex-none z-10"><div id="active-avatar" class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-md"></div><div class="flex-1"><p id="active-name" class="font-bold text-white text-sm"></p><div class="flex items-center"><span id="active-status-dot" class="status-dot"></span><span id="active-status-text" class="text-[9px] uppercase font-bold text-slate-400">Status</span></div></div><button onclick="window.openChatSelection()" class="text-slate-400 hover:text-white p-2"><i class="fas fa-times"></i></button></div><div id="chat-messages" class="chat-messages-area"></div><div class="flex-none bg-slate-800 border-t border-slate-700 pb-2"><div id="typing-box" class="px-4 py-2 hidden text-xs text-sky-400 italic font-medium bg-slate-900/30">Digitando...</div><div class="p-3"><form id="chat-form" class="flex items-center gap-2"><button type="button" id="mic-btn" onclick="window.toggleMic()" class="w-10 h-10 bg-slate-700 rounded-full text-slate-400 flex items-center justify-center"><i class="fas fa-microphone"></i></button><input type="text" id="chat-input" placeholder="Digite..." class="flex-1 bg-slate-700 border-0 text-white rounded-full px-4 py-2 text-sm outline-none focus:ring-1 focus:ring-sky-500"><button type="submit" class="w-10 h-10 bg-sky-600 text-white rounded-full flex items-center justify-center"><i class="fas fa-paper-plane"></i></button></form></div></div></div></section>

<section id="hope" class="tab-content"><div class="glass-card p-6 h-full flex flex-col justify-center text-center"><button onclick="window.showTab('home')" class="absolute top-6 left-6 w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><i class="fas fa-arrow-left text-slate-300"></i></button><div id="resultadoBox" class="hidden animate-fade-in"><img id="imgBox" class="rounded-xl mb-4 shadow-lg w-full h-40 object-cover border border-slate-700"/><div class="bg-slate-800/80 p-5 rounded-xl border border-slate-700"><p id="msgBox" class="italic text-slate-200 text-sm leading-relaxed"></p></div><button onclick="window.gerarCaixinha()" class="mt-6 text-yellow-500 font-bold text-xs uppercase tracking-widest">Quero outra mensagem</button></div><div id="hope-intro"><i class="fas fa-gift text-yellow-400 text-5xl mb-6 animate-pulse"></i><h3 class="text-xl font-bold mb-4">Caixinha Surpresa</h3><button onclick="window.gerarCaixinha()" class="w-full bg-yellow-600 text-white py-4 rounded-xl font-bold shadow-lg">Abrir Presente</button></div></div></section>

<section id="game-section" class="tab-content"></section>

</main>
<nav class="flex-none bg-slate-900/95 backdrop-blur-md border-t border-slate-800 py-3 flex justify-around z-50"><button onclick="window.showTab('home')" class="text-sky-500 flex flex-col items-center gap-1"><i class="fas fa-home"></i><span class="text-[9px] font-bold tracking-widest">INÍCIO</span></button><button onclick="window.openChatSelection()" class="text-slate-500 flex flex-col items-center gap-1"><i class="fas fa-comment"></i><span class="text-[9px] font-bold tracking-widest">CHAT</span></button></nav>

<script>
// --- CONFIGURAÇÃO ---
window.GROQ_API_KEY="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";
window.SHEET_ID = "1cus7Hm0a4FSU9SiPAoszA6KlrhWrhKYbQwSd7YPsYeY";
window.SHEET_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxPmSrtdjfPuLtZma2hd84WMv42zcZx0IzuVpq3zUUvMtwEDEGD-94CQyibUtOZoWDC/exec";

// Estados Persistentes
window.clientName = localStorage.getItem('wr_client_name') || "Visitante";
window.clientNick = localStorage.getItem('wr_ranking_nick') || "GUERREIRO";
window.clientGender = localStorage.getItem('wr_client_gender') || "homem";
window.isWaiting = false;

// Itens Fixos
const naturalItems = [
    { id: 'resp', txt: '15 min Respiração Consciente' },
    { id: 'sun', txt: '20 min Luz Solar' },
    { id: 'water1', txt: '1 Litro de Água (até 14:00)' },
    { id: 'water2', txt: '1 Litro de Água (até 20:00)' },
    { id: 'meal', txt: '1 Refeição Saudável' },
    { id: 'exercise', txt: '30 min Exercício Físico' },
    { id: 'sleep', txt: '6 Horas de Sono' },
    { id: 'nofood', txt: 'Não Comer Industrializados Hoje' },
    { id: 'meditation', txt: '30 min Meditação / Reflexão' }
];

// Inicialização de Login
window.onload = () => {
    document.querySelectorAll('.client-name').forEach(el => el.innerText = window.clientName);
    document.getElementById('display-ranking-nick').innerText = window.clientNick;
    if(localStorage.getItem('wr_logged') === 'true') {
        document.getElementById('onboarding').classList.remove('active');
        document.getElementById('home').classList.add('active');
    }
}

window.login = function() {
    const real = document.getElementById('user-name-input').value.trim().toUpperCase();
    const nick = document.getElementById('user-nick-input').value.trim().toUpperCase();
    if(real && nick) {
        window.clientName = real;
        window.clientNick = nick;
        localStorage.setItem('wr_client_name', real);
        localStorage.setItem('wr_ranking_nick', nick);
        localStorage.setItem('wr_client_gender', document.getElementById('user-gender').value);
        localStorage.setItem('wr_logged', 'true');
        
        document.querySelectorAll('.client-name').forEach(el => el.innerText = real);
        document.getElementById('display-ranking-nick').innerText = nick;
        window.showTab('home');
    } else alert("Preencha Nome Real e Apelido.");
}

window.showTab = function(id) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    const target = document.getElementById(id);
    if(target) target.classList.add('active');
    if(id === 'natural-remedies') { window.initNaturalRemedies(); window.loadRanking(); }
}

// --- REMÉDIOS NATURAIS & RANKING ---

window.initNaturalRemedies = function() {
    const list = document.getElementById('remedies-list');
    list.innerHTML = '';
    const todayKey = `remedies_${window.clientName}_${new Date().toLocaleDateString('pt-BR')}`;
    const savedChecks = JSON.parse(localStorage.getItem(todayKey) || '[]');
    document.getElementById('daily-points').innerText = savedChecks.length * 10;

    naturalItems.forEach(item => {
        if(savedChecks.includes(item.id)) return;
        const div = document.createElement('div');
        div.id = `item-${item.id}`;
        div.className = 'flex items-center gap-3 bg-slate-800/80 p-4 rounded-xl border border-slate-700 hover:bg-slate-700 transition-all cursor-pointer';
        div.onclick = () => window.checkItem(item.id);
        div.innerHTML = `
            <div class="w-6 h-6 border-2 border-emerald-500 rounded-lg flex items-center justify-center transition-all">
                <i class="fas fa-check text-transparent text-xs"></i>
            </div>
            <span class="text-xs text-slate-200 font-medium">${item.txt}</span>
            <span class="ml-auto text-[10px] font-bold text-emerald-400">+10</span>
        `;
        list.appendChild(div);
    });
}

window.checkItem = async function(itemId) {
    const el = document.getElementById(`item-${itemId}`);
    el.classList.add('slide-out');
    
    // Salva Local vinculado ao login real para controle de interface
    const todayKey = `remedies_${window.clientName}_${new Date().toLocaleDateString('pt-BR')}`;
    const savedChecks = JSON.parse(localStorage.getItem(todayKey) || '[]');
    savedChecks.push(itemId);
    localStorage.setItem(todayKey, JSON.stringify(savedChecks));

    document.getElementById('daily-points').innerText = savedChecks.length * 10;

    // Envia para Planilha com o APELIDO
    try {
        await fetch(window.SHEET_SCRIPT_URL, {
            method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ type: 'ranking', nick: window.clientNick, points: 10 })
        });
        setTimeout(window.loadRanking, 800);
    } catch(e) {}
    setTimeout(() => el.remove(), 500);
}

window.loadRanking = async function() {
    const list = document.getElementById('ranking-list');
    list.innerHTML = '<div class="text-center py-4"><i class="fas fa-circle-notch fa-spin text-emerald-500"></i></div>';
    try {
        const res = await fetch(`https://docs.google.com/spreadsheets/d/${window.SHEET_ID}/gviz/tq?tqx=out:json&sheet=RankingDB`);
        const txt = await res.text();
        const json = JSON.parse(txt.substring(txt.indexOf("{"), txt.lastIndexOf("}") + 1));
        let scores = {};
        const currentMonthRef = (new Date().getMonth() + 1) + "/" + new Date().getFullYear(); 
        if (json.table && json.table.rows) {
            json.table.rows.forEach(row => {
                if((row.c[3] ? row.c[3].v : "") === currentMonthRef) {
                    const nick = row.c[1] ? row.c[1].v : "ANÔNIMO";
                    scores[nick] = (scores[nick] || 0) + (row.c[2] ? parseInt(row.c[2].v) : 0);
                }
            });
        }
        const sorted = Object.entries(scores).sort((a,b) => b[1] - a[1]).slice(0, 10);
        list.innerHTML = sorted.map((entry, idx) => {
            let medal = `<span class="text-[10px] text-slate-500 w-5">#${idx+1}</span>`;
            if(idx === 0) medal = '<i class="fas fa-medal medal-gold"></i>';
            else if(idx === 1) medal = '<i class="fas fa-medal medal-silver"></i>';
            else if(idx === 2) medal = '<i class="fas fa-medal medal-bronze"></i>';
            return `<div class="flex justify-between items-center bg-slate-800/40 px-3 py-2 rounded-lg mb-1 border border-slate-700/30">
                <div class="flex items-center gap-3">${medal}<span class="text-xs text-slate-200">${entry[0]}</span></div>
                <span class="text-[10px] font-mono text-emerald-400 font-bold">${entry[1]} pts</span>
            </div>`;
        }).join('') || '<p class="text-[10px] text-slate-500 text-center py-4">Ranking zerado.</p>';
    } catch(e) { list.innerHTML = '<p class="text-[9px] text-red-400 text-center">Falha na conexão.</p>'; }
}

// --- IA & UTILITÁRIOS ---

window.gerarCaixinha = async function(){
    const mb=document.getElementById("msgBox");
    document.getElementById("hope-intro").classList.add("hidden");
    document.getElementById("resultadoBox").classList.remove("hidden");
    mb.innerText="Abrindo presente...";
    document.getElementById("imgBox").src=`https://loremflickr.com/800/600/nature,peace?lock=${Math.floor(Math.random()*1000)}`;
    const c=`Gere uma frase terapêutica curta (máx 500 chars) sobre esperança e calma.`;
    try{
        const r=await fetch("https://api.groq.com/openai/v1/chat/completions",{
            method:"POST", headers:{Authorization:`Bearer ${window.GROQ_API_KEY}`,"Content-Type":"application/json"},
            body:JSON.stringify({model:"llama-3.3-70b-versatile",messages:[{role:"system",content:c}],temperature:0.9, max_tokens: 150})
        });
        const d=await r.json(); mb.innerText=d.choices[0].message.content;
    } catch(e){ mb.innerText="Você é luz no mundo. Respire."; }
}

window.gerarLeitura = async function(){
    const t=document.getElementById('book-theme').value;
    const l=document.getElementById('book-loading');
    const c=document.getElementById('book-container');
    c.classList.add('hidden'); l.classList.remove('hidden');
    const p=`Escreva um capítulo inspirador sobre ${t}. MÁX 800 tokens. Tags <p>.`;
    try{
        const r=await fetch("https://api.groq.com/openai/v1/chat/completions",{
            method:"POST", headers:{Authorization:`Bearer ${window.GROQ_API_KEY}`,"Content-Type":"application/json"},
            body:JSON.stringify({model:"llama-3.3-70b-versatile",messages:[{role:"system",content:p}],max_tokens:800})
        });
        const d=await r.json();
        document.getElementById('book-title').innerText = t;
        document.getElementById('book-content').innerHTML = d.choices[0].message.content;
        l.classList.add('hidden'); c.classList.remove('hidden');
    } catch(e){ alert("Falha ao escrever."); l.classList.add('hidden'); }
}

// Chat básico (Lia)
const therapists=[{id:'lia',name:'Dra. Lia',color:'#ec4899',icon:'heart'}];
window.openChatSelection = function(){
    const l=document.getElementById('therapist-list'); l.innerHTML='';
    therapists.forEach(t=>{
        const dv=document.createElement('div');
        dv.className='p-4 bg-slate-800 rounded-xl flex items-center gap-3 cursor-pointer';
        dv.onclick=()=>window.startChat(t.id);
        dv.innerHTML=`<div class="w-10 h-10 rounded-full flex items-center justify-center" style="background:${t.color}"><i class="fas fa-${t.icon}"></i></div><span class="font-bold">${t.name}</span>`;
        l.appendChild(dv);
    });
    window.showTab('chat-selection');
}
window.startChat = function(id){
    document.getElementById('active-name').innerText="Dra. Lia";
    document.getElementById('active-avatar').style.background="#ec4899";
    document.getElementById('active-avatar').innerHTML='<i class="fas fa-heart"></i>';
    window.showTab('chat');
}

// Player YouTube Silencioso
window.onYouTubeIframeAPIReady = function(){
    window.player=new YT.Player('bg-music-player',{height:'0',width:'0',videoId:'Cg0dAc4-UCY',playerVars:{'autoplay':0,'loop':1,'playlist':'Cg0dAc4-UCY'}});
}
window.toggleMusic = function(){
    if(!window.player)return;
    const btn=document.getElementById('music-icon');
    if(window.player.isMuted()){
        window.player.unMute(); window.player.playVideo(); window.player.setVolume(20);
        btn.className="fas fa-volume-up text-sky-400";
    } else {
        window.player.mute();
        btn.className="fas fa-volume-mute text-slate-400";
    }
}
</script>
</body>
</html>
