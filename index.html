<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0f172a">
<title>Harmonia Di√°ria - WR TERAPIA</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Quicksand:wght@400;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&display=swap');
:root{--bg-dark:#0f172a;--card-bg:#1e293b;--primary:#0ea5e9;--text-light:#f1f5f9;--text-dim:#94a3b8}*{box-sizing:border-box}body{font-family:'Inter',sans-serif;background-color:var(--bg-dark);color:var(--text-light);margin:0;padding:0;position:fixed;inset:0;display:flex;flex-direction:column}.heading-font{font-family:'Quicksand',sans-serif}.glass-card{background:rgba(30,41,59,0.98);border:1px solid rgba(255,255,255,0.1);border-radius:1.5rem;box-shadow:0 4px 6px -1px rgba(0,0,0,0.5)}main{flex:1;position:relative;width:100%;max-width:480px;margin:0 auto}.tab-content{display:none;position:absolute;inset:0;padding:1rem;overflow-y:auto;-webkit-overflow-scrolling:touch}.tab-content.active{display:flex;flex-direction:column;animation:fadeIn .3s ease-out}@keyframes fadeIn{from{opacity:0}to{opacity:1}}#chat.tab-content{padding:0;overflow:hidden}.chat-layout{display:flex;flex-direction:column;height:100%}.chat-messages-area{flex:1;overflow-y:auto;padding:1rem;background:rgba(15,23,42,0.5)}.message{max-width:85%;padding:12px 16px;border-radius:1.2rem;font-size:.95rem;line-height:1.5;margin-bottom:12px}.message.user{align-self:flex-end;background:var(--primary);color:#fff;border-bottom-right-radius:.2rem;margin-left:auto}.message.therapist{align-self:flex-start;background:#334155;color:#e2e8f0;border-bottom-left-radius:.2rem;margin-right:auto}.message.audio-msg{font-style:italic;display:flex;align-items:center;gap:8px;color:#cbd5e1}.message.system-note{align-self:center;background:rgba(239,68,68,0.2);color:#fca5a5;font-size:0.8rem;text-align:center;border:1px solid rgba(239,68,68,0.4);width:90%}.memory-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}.memory-card{background-color:#334155;height:60px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;border:2px solid #475569;color:transparent;transition:all .3s ease;transform-style:preserve-3d}.memory-card.flipped,.memory-card.matched{background-color:#f1f5f9;border-color:var(--primary);color:#333;transform:rotateY(180deg)}.memory-card.matched{background-color:#10b981;border-color:#059669;color:#fff;cursor:default}.puzzle-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;width:100%;aspect-ratio:1;background:#334155;padding:4px;border-radius:8px}.puzzle-tile{background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:bold;cursor:pointer;border-radius:4px;user-select:none;transition:transform .2s}.puzzle-tile.empty{background:transparent;cursor:default}.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px}.status-online{background-color:#10b981;box-shadow:0 0 5px #10b981}.status-busy{background-color:#f59e0b;box-shadow:0 0 5px #f59e0b}.status-offline{background-color:#94a3b8}.admin-trigger{opacity:.1;transition:opacity .3s;cursor:pointer}.admin-trigger:hover{opacity:1}
.book-page{background-color:#fdf6e3;color:#2c1810;font-family:'Merriweather',serif;padding:2rem;border-radius:4px;box-shadow:inset 20px 0 50px rgba(0,0,0,0.1),5px 5px 15px rgba(0,0,0,0.3);border-left:5px solid #d4c5b0;line-height:1.8;position:relative;overflow:hidden;min-height:400px}.book-page::before{content:"";position:absolute;top:0;bottom:0;left:0;width:100%;background:linear-gradient(90deg,rgba(0,0,0,0.05) 0%,rgba(0,0,0,0) 10%,rgba(0,0,0,0) 90%,rgba(0,0,0,0.05) 100%);pointer-events:none}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#475569;border-radius:2px}.btn-game{@apply w-full py-3 rounded-xl font-bold shadow-lg transition-all active:scale-95}input,select,textarea{background-color:#334155;color:#fff;border-color:#475569}input::placeholder,textarea::placeholder{color:#94a3b8}
/* Checkbox customizado */
.custom-checkbox input:checked + div { background-color: #10b981; border-color: #10b981; }
.custom-checkbox input:checked + div:after { content: ''; display: block; width: 5px; height: 10px; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); }
.slide-out { animation: slideOut 0.5s forwards; }
@keyframes slideOut { to { opacity: 0; transform: translateX(100%); height: 0; margin: 0; padding: 0; } }
</style>
<script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
<header class="flex-none p-4 text-center bg-slate-900/95 backdrop-blur-md border-b border-slate-700 z-20 relative">
<button id="music-toggle" onclick="window.toggleMusic()" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-sky-400 transition-colors w-8 h-8 flex items-center justify-center rounded-full active:bg-slate-800"><i id="music-icon" class="fas fa-volume-mute"></i></button>
<h1 class="text-xl font-bold text-sky-400 heading-font">Espa√ßo | WR Terapia¬Æ</h1>
</header>
<main>
<div id="bg-music-player" style="display:none;"></div>

<!-- Onboarding -->
<section id="onboarding" class="tab-content active"><div class="h-full flex flex-col items-center justify-center p-4"><div class="glass-card p-8 text-center w-full"><div class="w-20 h-20 bg-slate-700 rounded-full flex items-center justify-center mb-6 mx-auto ring-2 ring-sky-500/50"><i class="fas fa-fingerprint text-sky-400 text-3xl"></i></div><h2 class="text-2xl font-bold text-white mb-2 heading-font">Bem-vindo(a)</h2><p class="text-sm text-slate-400 mb-8">Identifique-se para acessar seu espa√ßo seguro.</p><div class="w-full mb-4 space-y-3"><select id="user-gender" class="w-full p-4 rounded-2xl outline-none focus:ring-2 focus:ring-sky-500"><option value="homem">Sou Homem</option><option value="mulher">Sou Mulher</option></select><input type="text" id="user-name-input" oninput="this.value=this.value.toUpperCase()" placeholder="SEU NOME" class="w-full p-4 rounded-2xl text-center uppercase font-bold outline-none focus:ring-2 focus:ring-sky-500"></div><button onclick="window.login()" class="w-full bg-sky-600 text-white py-4 rounded-2xl font-bold shadow-lg mt-2 hover:bg-sky-500 transition-all">Entrar</button></div></div></section>

<!-- Home -->
<section id="home" class="tab-content"><div class="glass-card p-6 mb-4"><p class="text-xs text-slate-400">Ol√°,</p><h2 class="text-xl font-bold text-white heading-font mb-6 client-name">Visitante</h2><div class="grid grid-cols-2 gap-4"><button onclick="window.openChatSelection()" class="p-4 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-3 hover:bg-slate-700 transition-all"><i class="fas fa-comment-medical text-2xl text-sky-400"></i><span class="text-[10px] font-bold uppercase text-slate-300">Conversar</span></button><button onclick="window.showTab('natural-remedies')" class="p-4 bg-emerald-900/30 rounded-2xl border border-emerald-700/50 flex flex-col items-center gap-3 hover:bg-emerald-900/50 transition-all relative overflow-hidden"><div class="absolute top-0 right-0 bg-emerald-500 text-white text-[8px] font-bold px-2 py-1 rounded-bl-lg">NOVO</div><i class="fas fa-leaf text-2xl text-emerald-400"></i><span class="text-[10px] font-bold uppercase text-emerald-300">Rem√©dios Naturais</span></button><button onclick="window.showTab('mural')" class="p-4 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-3 hover:bg-slate-700 transition-all"><i class="fas fa-comments text-2xl text-amber-400"></i><span class="text-[10px] font-bold uppercase text-slate-300">Mural</span></button><button onclick="window.showTab('hope')" class="p-4 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-3 hover:bg-slate-700 transition-all"><i class="fas fa-lightbulb text-2xl text-yellow-400"></i><span class="text-[10px] font-bold uppercase text-slate-300">Caixinha Surpresa</span></button></div><div class="grid grid-cols-2 gap-4 mt-4"><button onclick="window.showTab('relaxation')" class="p-4 bg-purple-900/30 rounded-2xl border border-purple-800/50 flex flex-col items-center gap-2 hover:bg-purple-900/50 transition-all"><i class="fas fa-spa text-xl text-purple-400"></i><span class="text-[9px] font-bold uppercase text-purple-300">Relaxar</span></button><button onclick="window.startDescompressao()" class="p-4 bg-rose-900/30 rounded-2xl border border-rose-800/50 flex flex-col items-center gap-2 hover:bg-rose-900/50 transition-all"><i class="fas fa-brain text-xl text-rose-400"></i><span class="text-[9px] font-bold uppercase text-rose-300">Descompress√£o</span></button></div><button onclick="window.showTab('library')" class="w-full mt-4 p-4 bg-indigo-900/30 rounded-2xl border border-indigo-800/50 flex flex-col items-center gap-2 hover:bg-indigo-900/50 transition-all"><i class="fas fa-book-open text-xl text-indigo-400"></i><span class="text-[9px] font-bold uppercase text-indigo-300">Biblioteca M√°gica</span></button><button onclick="window.showTab('agenda')" class="w-full mt-4 p-3 bg-slate-800 rounded-xl border border-slate-700 flex items-center justify-center gap-2 text-[10px] text-slate-400 hover:text-white"><i class="fas fa-calendar-alt"></i> Agendar Sess√£o</button></div><div class="mt-auto pt-8 pb-4 text-center flex flex-col items-center justify-center gap-2"><p class="text-[9px] text-slate-600 uppercase font-bold tracking-widest">Desenvolvido por WR-TECNOLOGIA | William Ribeiro</p><i onclick="window.showAdminLogin()" class="fas fa-lock text-slate-700 text-xs admin-trigger" title="Admin"></i></div></section>

<!-- Natural Remedies (NOVA SE√á√ÉO ATUALIZADA) -->
<section id="natural-remedies" class="tab-content"><div class="glass-card p-5 h-full flex flex-col"><div class="flex items-center gap-3 mb-4 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button><div><h2 class="font-bold text-emerald-400">Rem√©dios Naturais</h2><p class="text-[10px] text-slate-500">Marque para pontuar e subir no ranking!</p></div></div><div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700 mb-4 flex-none"><label class="text-[10px] text-slate-400 uppercase font-bold mb-1 block">Seu Apelido no Ranking</label><input type="text" id="ranking-nick" placeholder="Ex: Guerreiro01" maxlength="15" onchange="localStorage.setItem('wr_ranking_nick', this.value)" class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-sm text-emerald-300 focus:outline-none focus:border-emerald-500 border-l-4 border-l-emerald-500"></div><div id="remedies-list" class="flex-1 overflow-y-auto space-y-2 mb-4 pr-1"></div><div class="flex-none pt-2 border-t border-slate-700"><div class="flex justify-between items-center mb-2"><span class="text-xs text-slate-400">Sua Pontua√ß√£o Hoje:</span><span id="daily-points" class="text-xl font-bold text-emerald-400">0</span></div><div class="bg-slate-900 rounded-xl p-3 border border-slate-700 max-h-48 overflow-y-auto"><div class="flex justify-between items-center border-b border-slate-800 pb-2 mb-2"><h3 class="text-[10px] font-bold text-slate-500 uppercase">Top Guerreiros (Mensal)</h3><button onclick="window.loadRanking()" class="text-[9px] text-sky-500 hover:text-sky-400"><i class="fas fa-sync-alt"></i> Atualizar</button></div><div id="ranking-list" class="space-y-1"></div></div></div></div></section>

<!-- Library -->
<section id="library" class="tab-content"><div class="glass-card p-4 h-full flex flex-col"><div class="flex items-center gap-3 mb-4 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-indigo-400">Biblioteca M√°gica</h2></div><div class="mb-4 text-center flex-none"><p class="text-xs text-slate-400 mb-2">Escolha um tema e deixe nosso sistema te apresentar um cap√≠tulo exclusivo.</p></div><div class="flex-none mb-4"><select id="book-theme" class="w-full p-3 rounded-xl text-sm bg-slate-800 text-slate-200 border border-slate-600 focus:ring-2 focus:ring-indigo-500"><option value="Autoconhecimento">Autoconhecimento</option><option value="Resili√™ncia">Resili√™ncia</option><option value="Ansiedade e Calma">Ansiedade e Calma</option><option value="Relacionamentos Saud√°veis">Relacionamentos Saud√°veis</option><option value="Prop√≥sito de Vida">Prop√≥sito de Vida</option><option value="Sono e Descanso">Sono e Descanso</option><option value="Foco e Disciplina">Foco e Disciplina</option></select><button onclick="window.gerarLeitura()" class="w-full mt-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg"><i class="fas fa-pen-fancy mr-2"></i>Ler um Cap√≠tulo</button></div><div id="book-container" class="flex-1 overflow-y-auto hidden animate-fade-in"><div class="book-page"><h3 id="book-title" class="text-xl font-bold mb-4 text-center border-b border-stone-400 pb-2"></h3><div id="book-content" class="text-sm text-justify"></div><p class="text-center mt-8 text-xs text-stone-500 italic">~ Fim do Cap√≠tulo ~</p></div></div><div id="book-loading" class="hidden flex-1 flex flex-col items-center justify-center text-indigo-300"><i class="fas fa-feather-alt fa-spin text-4xl mb-3"></i><p class="text-sm animate-pulse">Buscando seu Cap√≠tulo de Hoje...</p></div></div></section>

<!-- Admin Login -->
<section id="admin-login-screen" class="tab-content justify-center items-center"><div class="glass-card p-6 w-full text-center"><div class="flex justify-between items-center mb-4"><button onclick="window.showTab('home')" class="text-slate-400"><i class="fas fa-arrow-left"></i></button><h2 class="font-bold text-white">Acesso Administrativo</h2><div class="w-4"></div></div><input type="password" id="admin-pass" placeholder="Senha" class="w-full p-3 mb-4 rounded-xl text-center"><button onclick="window.attemptAdminLogin()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold">Entrar</button></div></section>

<!-- Admin Dashboard -->
<section id="admin-dashboard" class="tab-content"><div class="glass-card p-4 h-full flex flex-col"><div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-700"><h2 class="font-bold text-emerald-400">Painel do Terapeuta</h2><button onclick="window.logoutAdmin()" class="text-xs text-red-400">Sair</button></div><p class="text-xs text-slate-400 mb-2">Conversas Ativas:</p><div id="admin-chat-list" class="flex-1 overflow-y-auto space-y-2"></div><div id="admin-response-area" class="hidden mt-4 pt-4 border-t border-slate-700"><div class="flex justify-between items-center mb-2"><span id="admin-target-name" class="text-xs font-bold text-white"></span><button onclick="window.toggleAiStatus()" id="ai-toggle-btn" class="text-[10px] bg-sky-600 px-2 py-1 rounded">IA: ATIVA</button></div><div id="admin-chat-preview" class="h-32 overflow-y-auto bg-slate-900/50 rounded p-2 mb-2 text-xs text-slate-300"></div><div class="flex gap-2"><input type="text" id="admin-reply-input" placeholder="Responder..." class="flex-1 text-sm p-2 rounded"><button onclick="window.sendAdminReply()" class="bg-emerald-600 text-white p-2 rounded"><i class="fas fa-paper-plane"></i></button></div></div></div></section>

<!-- Agenda -->
<section id="agenda" class="tab-content"><div class="glass-card p-4 h-full flex flex-col"><div class="flex items-center gap-3 mb-4 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-sky-400 heading-font">Agendamento</h2></div><div class="flex-1 rounded-xl overflow-hidden border border-slate-600 bg-white"><iframe src="https://calendly.com/wrterapia/atendimentos" width="100%" height="100%" frameborder="0"></iframe></div><p class="text-[10px] text-slate-500 mt-3 text-center italic">Agenda autom√°tica.</p></div></section>

<!-- Chat Selection -->
<section id="chat-selection" class="tab-content"><div class="glass-card p-6 h-full overflow-y-auto"><div class="flex items-center gap-3 mb-4"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-sky-400 text-lg">Nossa Equipe</h2></div><div id="therapist-list" class="space-y-3 pb-20"></div></div></section>

<!-- Chat -->
<section id="chat" class="tab-content"><div class="chat-layout h-full"><div class="p-4 border-b border-slate-700 flex items-center gap-3 bg-slate-800/95 flex-none z-10"><div id="active-avatar" class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-md"></div><div class="flex-1"><p id="active-name" class="font-bold text-white text-sm"></p><div class="flex items-center"><span id="active-status-dot" class="status-dot"></span><span id="active-status-text" class="text-[9px] uppercase font-bold text-slate-400">Status</span></div></div><button onclick="window.openChatSelection()" class="text-slate-400 hover:text-white p-2"><i class="fas fa-times"></i></button></div><div id="chat-messages" class="chat-messages-area"></div><div class="flex-none bg-slate-800 border-t border-slate-700 pb-2"><div id="typing-box" class="px-4 py-2 hidden text-xs text-sky-400 italic font-medium bg-slate-900/30">Digitando <span class="animate-pulse">...</span></div><div class="p-3"><form id="chat-form" class="flex items-center gap-2"><button type="button" id="mic-btn" onclick="window.toggleMic()" class="w-10 h-10 bg-slate-700 rounded-full text-slate-400 hover:text-white transition-colors flex items-center justify-center"><i class="fas fa-microphone"></i></button><input type="text" id="chat-input" placeholder="Digite aqui..." class="flex-1 bg-slate-700 border-0 text-white rounded-full px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-sky-500 placeholder-slate-400"><button type="button" id="wa-btn" onclick="window.sendToWhatsapp()" class="hidden w-10 h-10 bg-emerald-600 text-white rounded-full shadow-md hover:bg-emerald-500 transition-colors flex items-center justify-center"><i class="fab fa-whatsapp text-lg"></i></button><button type="submit" class="w-10 h-10 bg-sky-600 text-white rounded-full shadow-md hover:bg-sky-500 transition-colors flex items-center justify-center"><i class="fas fa-paper-plane"></i></button></form></div></div></div></section>

<!-- Relaxamento -->
<section id="relaxation" class="tab-content"><div class="glass-card p-4 h-full flex flex-col"><div class="flex items-center gap-3 mb-4 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-sky-400">Relaxamento</h2></div><div class="aspect-video w-full rounded-xl overflow-hidden shadow-lg flex-none border border-slate-600 bg-black"><iframe width="100%" height="100%" src="https://www.youtube.com/embed/sF80I-TQiW0" frameborder="0" allowfullscreen></iframe></div><div class="mt-4 p-5 bg-slate-800/80 rounded-2xl border border-slate-700 text-slate-300 leading-relaxed text-sm shadow-inner flex-1 overflow-y-auto"><p class="mb-4">Muitas vezes em nossas rotinas nos perdemos em pensamentos e sofrimentos, mas √© fundamental parar, relaxar e deixar sentir a leveza da vida.</p><p class="mb-4">Ent√£o, d√™ play, encontre um espa√ßo confort√°vel e deixe a ansiedade, a ang√∫stia e os sentimentos negativos irem embora.</p><p class="mb-6">Abrace um travesseiro, feche os olhos e se reconstrua.</p><p class="text-right font-bold text-sky-500 font-heading text-xs">Att. William Ribeiro - O seu terapeuta ‚ù§Ô∏è</p></div></div></section>

<!-- Mural -->
<section id="mural" class="tab-content"><div class="glass-card p-5 h-full flex flex-col"><div class="flex items-center gap-3 mb-4 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button><div><h2 class="font-bold text-sky-400">Mural de Sentimentos</h2><p class="text-[10px] text-slate-500">Compartilhe experi√™ncias anonimamente e transforme uma vida.</p><p class="text-[9px] text-emerald-400 font-bold"><i class="fas fa-globe-americas mr-1"></i>Conectado √† Planilha</p></div></div><div id="mural-list" class="flex-1 overflow-y-auto mb-4 space-y-3 pr-1 pb-20"></div><div class="mt-auto pt-4 border-t border-slate-700 flex-none bg-slate-800/50 p-2 rounded-xl"><textarea id="mural-input" placeholder="Escreva algo transformador..." class="w-full p-3 rounded-xl border border-slate-600 h-20 resize-none text-sm bg-slate-800 mb-2 focus:ring-2 focus:ring-amber-500 outline-none"></textarea><button onclick="window.saveMuralMessage()" class="w-full bg-amber-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-amber-500 transition-all"><i class="fas fa-paper-plane mr-2"></i>Publicar</button></div></div></section>

<!-- Caixinha Surpresa -->
<section id="hope" class="tab-content"><div class="glass-card p-6 min-h-full flex flex-col justify-center overflow-y-auto"><div class="flex justify-between items-center mb-6 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-lg text-yellow-400">Caixinha Surpresa</h2><div class="w-8"></div></div><div class="mb-8 flex-none text-center"><div class="w-24 h-24 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 border border-slate-600 shadow-lg animate-pulse"><i class="fas fa-gift text-yellow-400 text-4xl"></i></div><p class="text-sm text-slate-400 mb-2">Toque para receber uma mensagem de luz.</p></div><button onclick="window.gerarCaixinha()" class="flex-none w-full bg-gradient-to-r from-amber-600 to-orange-600 text-white py-4 rounded-xl font-bold shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 border border-amber-500/50"><i class="fas fa-magic mr-2"></i>Gerar Experi√™ncia</button><div id="resultadoBox" class="mt-8 hidden animate-fade-in pb-20 flex-none"><img id="imgBox" class="rounded-xl mb-4 shadow-lg w-full h-48 object-cover bg-slate-800 border border-slate-700"/><div class="bg-slate-800/80 p-5 rounded-xl border border-slate-700 shadow-sm"><p id="msgBox" class="italic text-slate-200 text-sm font-medium leading-relaxed text-center"></p></div></div></div></section>

<!-- Game Section -->
<section id="game-section" class="tab-content"><div class="glass-card p-5 h-full flex flex-col"><div class="flex items-center justify-between mb-4 flex-none"><div class="flex items-center gap-2"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-rose-400">Descompress√£o</h2></div><span class="text-xs font-bold bg-rose-900/50 text-rose-300 px-3 py-1 rounded-full border border-rose-800" id="game-level-display">N√≠vel 1/10</span></div><div class="mb-4 bg-slate-800/50 p-3 rounded-xl border border-slate-700 flex-none"><p class="text-xs text-slate-400 text-center leading-relaxed">Este √© um espa√ßo seguro para brincar, relaxar e sair da rotina.<br>Treine seu racioc√≠nio, mem√≥ria e percep√ß√£o.</p></div><div id="game-container" class="flex-1 flex flex-col items-center justify-center w-full relative overflow-y-auto"></div><button id="next-game-btn" onclick="window.nextGame()" class="flex-none hidden mt-4 bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg w-full animate-bounce">Pr√≥ximo Desafio <i class="fas fa-arrow-right ml-2"></i></button></div></section>
</main>
<nav class="flex-none bg-slate-900/95 backdrop-blur-md border-t border-slate-800 py-3 flex justify-around z-50"><button onclick="window.showTab('home')" class="text-sky-500 flex flex-col items-center gap-1 hover:text-sky-400 transition-colors"><i class="fas fa-home"></i><span class="text-[9px] font-bold tracking-widest">IN√çCIO</span></button><button onclick="window.openChatSelection()" class="text-slate-500 flex flex-col items-center gap-1 hover:text-slate-300 transition-colors"><i class="fas fa-comment"></i><span class="text-[9px] font-bold tracking-widest">CHAT</span></button></nav>
<script>
// --- CONFIGURA√á√ÉO ---
window.GROQ_API_KEY="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";
window.SHEET_ID = "1cus7Hm0a4FSU9SiPAoszA6KlrhWrhKYbQwSd7YPsYeY";
// <<== LINK DO SCRIPT ATUALIZADO (100% FUNCIONAL)
window.SHEET_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxPmSrtdjfPuLtZma2hd84WMv42zcZx0IzuVpq3zUUvMtwEDEGD-94CQyibUtOZoWDC/exec";

// Dados do Usu√°rio
window.clientName=localStorage.getItem('wr_client_name')||"Visitante";
window.clientGender=localStorage.getItem('wr_client_gender')||"homem";
window.isWaiting=false;
window.messageCounter=0;
window.activeTherapist=null;
window.adminTargetTherapist=null;
window.aiPaused={};
window.player = null;

// UI Helpers
window.showTab = function(id){
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(id === 'mural') window.loadMural(); 
    if(id === 'natural-remedies') { window.initNaturalRemedies(); window.loadRanking(); }
}

window.login = function(){
    const n=document.getElementById('user-name-input').value.trim();
    window.clientGender=document.getElementById('user-gender').value;
    if(n){
        window.clientName=n;
        localStorage.setItem('wr_client_name',n);
        localStorage.setItem('wr_client_gender',window.clientGender);
        document.querySelectorAll('.client-name').forEach(el=>el.innerText=n);
        window.showTab('home');
        if(window.player){
            window.player.playVideo();
            window.player.unMute();
            window.player.setVolume(30);
            document.getElementById('music-icon').className="fas fa-volume-up text-sky-400";
        }
    }else alert("Digite seu nome.");
}

// Audio Logic
window.onYouTubeIframeAPIReady = function(){window.player=new YT.Player('bg-music-player',{height:'0',width:'0',videoId:'Cg0dAc4-UCY',playerVars:{'autoplay':0,'controls':0,'loop':1,'playlist':'Cg0dAc4-UCY'},events:{'onReady':onPlayerReady}})}
function onPlayerReady(e){e.target.setVolume(30)}
window.toggleMusic = function(){if(!window.player)return;const btn=document.getElementById('music-icon');if(window.player.isMuted()){window.player.unMute();window.player.setVolume(30);btn.className="fas fa-volume-up text-sky-400"}else{window.player.mute();btn.className="fas fa-volume-mute text-slate-400"}}

// Chat Logic
window.saveChatHistory = function(id,h){if(!window.clientName)return;localStorage.setItem(`chat_${window.clientName}_${id}`,JSON.stringify(h))}
window.loadChatHistory = function(id){if(!window.clientName)return[];return JSON.parse(localStorage.getItem(`chat_${window.clientName}_${id}`))||[]}

const therapists=[{id:'lia',name:'Dra. Lia',color:'#ec4899',icon:'heart'},{id:'william',name:'William',color:'#0ea5e9',icon:'user-tie'},{id:'yara',name:'Dra. Yara',color:'#8b5cf6',icon:'moon'}];
window.checkAvailability = function(id){const h=new Date().getHours();const d=h>=8&&h<22;if(id==='william')return d?{s:'busy',t:'Ocupado',c:'#f59e0b'}:{s:'offline',t:'Offline',c:'#94a3b8'};if(id==='yara')return!d?{s:'online',t:'Online',c:'#10b981'}:{s:'offline',t:'Offline',c:'#94a3b8'};if(id==='lia')return d?{s:'online',t:'Online',c:'#10b981'}:{s:'offline',t:'Offline',c:'#94a3b8'};return{s:'offline',t:'Offline',c:'#94a3b8'}}
window.getSystemPrompt = function(id){const t=window.clientGender==="homem"?"querido":"querida";const a=window.clientGender==="homem"?"amigo":"amiga";const e="IMPORTANTE: Responda dinamicamente, m√°x 500 chars. In√≠cio OBJETIVO.";const p={'lia':`Voc√™ √© a Dra. Lia. Acolha. ${e}`,'william':`Voc√™ √© o William. Em atendimento, desvie burocracias para Fernanda no Zap. Acolha naturalmente. ${e}`,'yara':`Voc√™ √© a Dra. Yara (madrugada). Chame de '${a}'. ${e}`};return p[id]||""}

window.showAdminLogin = function(){window.showTab('admin-login-screen')}
window.attemptAdminLogin = function(){const p=document.getElementById('admin-pass').value;if(p==="admin"){window.showTab('admin-dashboard');window.loadAdminDashboard()}else alert("Senha incorreta")}
window.logoutAdmin = function(){window.showTab('home')}
window.loadAdminDashboard = function(){const l=document.getElementById('admin-chat-list');l.innerHTML='';therapists.forEach(t=>{const h=window.loadChatHistory(t.id);if(h.length>0){const last=h.slice().reverse().find(m=>m.role!=='system');const p=last&&last.role==='user';const d=document.createElement('div');d.className="p-3 bg-slate-800 rounded border border-slate-700 cursor-pointer hover:bg-slate-700";d.onclick=()=>window.openAdminChat(t);d.innerHTML=`<div class="flex justify-between"><span class="font-bold text-sm text-white">${t.name}</span>${p?'<span class="admin-badge">Pendente</span>':''}</div><p class="text-[10px] text-slate-400 truncate">${last?last.content:'-'}</p>`;l.appendChild(d)}})}
window.openAdminChat = function(t){window.adminTargetTherapist=t;document.getElementById('admin-response-area').classList.remove('hidden');document.getElementById('admin-target-name').innerText=`Em: ${t.name}`;window.updateAiStatusBtn();const h=window.loadChatHistory(t.id);const p=document.getElementById('admin-chat-preview');p.innerHTML=h.filter(m=>m.role!=='system').map(m=>`<div class="mb-1"><b class="${m.role==='user'?'text-sky-400':'text-emerald-400'}">${m.role==='user'?'Cliente':'Bot'}:</b> ${m.content}</div>`).join('');p.scrollTop=p.scrollHeight}
window.toggleAiStatus = function(){if(!window.adminTargetTherapist)return;const i=window.adminTargetTherapist.id;window.aiPaused[i]=!window.aiPaused[i];window.updateAiStatusBtn()}
window.updateAiStatusBtn = function(){const b=document.getElementById('ai-toggle-btn');if(window.aiPaused[window.adminTargetTherapist.id]){b.innerText="IA: PAUSADA";b.className="text-[10px] bg-red-600 px-2 py-1 rounded font-bold"}else{b.innerText="IA: ATIVA";b.className="text-[10px] bg-emerald-600 px-2 py-1 rounded font-bold"}}
window.sendAdminReply = function(){const i=document.getElementById('admin-reply-input');const t=i.value.trim();if(!t||!window.adminTargetTherapist)return;const h=window.loadChatHistory(window.adminTargetTherapist.id);h.push({role:'assistant',content:t});window.saveChatHistory(window.adminTargetTherapist.id,h);i.value='';alert("Enviada!");window.loadAdminDashboard();window.openAdminChat(window.adminTargetTherapist)}
window.openChatSelection = function(){const l=document.getElementById('therapist-list');l.innerHTML='';therapists.forEach(t=>{const st=window.checkAvailability(t.id);const c=document.createElement('div');c.className=`flex items-center gap-4 p-4 bg-slate-800 rounded-xl border border-slate-700 shadow-sm transition-all mb-3 cursor-pointer hover:bg-slate-700`;c.onclick=()=>window.startChat(t.id);c.innerHTML=`<div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" style="background-color:${t.color}"><i class="fas fa-${t.icon}"></i></div><div class="flex-1"><span class="font-bold text-sm text-slate-200">${t.name}</span><div class="flex items-center"><span class="status-dot" style="background:${st.c};box-shadow:0 0 5px ${st.c}"></span><span class="text-[8px] uppercase font-bold text-slate-500">${st.t}</span></div></div>`;l.appendChild(c)});window.showTab('chat-selection')}
window.startChat = function(id){window.activeTherapist=therapists.find(t=>t.id===id);const st=window.checkAvailability(id);document.getElementById('active-name').innerText=window.activeTherapist.name;document.getElementById('active-avatar').style.backgroundColor=window.activeTherapist.color;document.getElementById('active-avatar').innerHTML=`<i class="fas fa-${window.activeTherapist.icon}"></i>`;document.getElementById('active-status-dot').style.background=st.c;document.getElementById('active-status-dot').style.boxShadow=`0 0 5px ${st.c}`;document.getElementById('active-status-text').innerText=st.t;let h=window.loadChatHistory(id);if(h.length===0){h.push({role:"system",content:`${window.getSystemPrompt(id)} Paciente: ${window.clientName}.`});let w="Ol√°!";if(id==='lia')w=`Ol√° ${window.clientName}. Sou a Dra. Lia. Como vai?`;else if(id==='william')w=`Oi ${window.clientName}. Sou o William.`;else if(id==='yara')w=`Ol√°. Estou aqui.`;h.push({role:'assistant',content:w});window.saveChatHistory(id,h)}const mc=document.getElementById('chat-messages');mc.innerHTML='';if(id==='william'){const dv=document.createElement('div');dv.className='message system-note mb-2';dv.innerHTML="‚ö†Ô∏è Em atendimento. Retorno estimado: 15 min.<br>Burocracia: fale com a Fernanda.";mc.appendChild(dv);}h.forEach(m=>{if(m.role!=='system')window.renderMessage(m.content,m.role==='user'?'user':'therapist')});mc.scrollTop=mc.scrollHeight;const wb=document.getElementById('wa-btn');if(id==='william')wb.classList.remove('hidden');else wb.classList.add('hidden');window.showTab('chat')}
window.sendToWhatsapp = function(){const i=document.getElementById('chat-input');const t=i.value.trim();const p="5541992531598";let m=`Ol√° Fernanda, sou ${window.clientName}. Vim pelo chat do William.`;if(t)m+=` Assunto: ${t}`;window.open(`https://wa.me/${p}?text=${encodeURIComponent(m)}`,'_blank')}
window.renderMessage = function(t,type,aud=false){const d=document.createElement('div');d.className=`message ${type}`;if(aud&&type==='user'){d.classList.add('audio-msg');d.innerHTML='<i class="fas fa-microphone-lines text-lg text-sky-400"></i> <span class="text-xs">√Åudio enviado...</span>'}else{d.innerHTML=t}document.getElementById('chat-messages').appendChild(d)}
let tat="";
document.getElementById('chat-form').onsubmit=async(e)=>{e.preventDefault();const i=document.getElementById('chat-input');let t=i.value.trim();let aud=false;if(!t&&!tat)return;if(window.isWaiting)return;if(tat){t=tat;aud=true;tat=""}else{t=i.value.trim()}window.renderMessage(t,'user',aud);let h=window.loadChatHistory(window.activeTherapist.id);h.push({role:'user',content:t});window.saveChatHistory(window.activeTherapist.id,h);i.value='';if(window.aiPaused[window.activeTherapist.id])return;window.isWaiting=true;window.messageCounter++;const waitTime=window.activeTherapist.id==='william'?15000:(window.messageCounter%2!==0?30000:40000);const apiPromise=fetch('https://api.groq.com/openai/v1/chat/completions',{method:'POST',headers:{'Authorization':`Bearer ${window.GROQ_API_KEY}`,'Content-Type':'application/json'},body:JSON.stringify({model:"llama-3.3-70b-versatile",messages:h,temperature:0.7,max_tokens:300})}).then(r=>r.json()).catch(()=>null);setTimeout(()=>{document.getElementById('typing-box').classList.remove('hidden');setTimeout(async()=>{document.getElementById('typing-box').classList.add('hidden');if(window.aiPaused[window.activeTherapist.id]){window.isWaiting=false;return}const d=await apiPromise;let r="Estou te ouvindo...";if(d&&d.choices)r=d.choices[0].message.content;window.renderMessage(r,'therapist');const ch=window.loadChatHistory(window.activeTherapist.id);ch.push({role:'assistant',content:r});window.saveChatHistory(window.activeTherapist.id,ch);const c=document.getElementById('chat-messages');c.scrollTop=c.scrollHeight;window.isWaiting=false},window.activeTherapist.id==='william'?5000:30000)},waitTime)};

// --- CAIXINHA SURPRESA (Limitada a 500 chars) ---
window.gerarCaixinha = async function(){
    const ts=["acolhimento","paz","emo√ß√µes","esperan√ßa","calma","for√ßa"];
    const ps=["montanhas","mar","floresta","chuva"];
    const t=ts[Math.floor(Math.random()*ts.length)];
    const p=ps[Math.floor(Math.random()*ps.length)];
    const mb=document.getElementById("msgBox");
    document.getElementById("resultadoBox").classList.remove("hidden");
    mb.innerText="Sintonizando...";
    document.getElementById("imgBox").src=`https://loremflickr.com/800/600/${p==='mar'?'sea':'nature'},nature?lock=${Math.floor(Math.random()*1000)}`;
    
    // Prompt rigoroso para limite
    const c=`Gere uma mensagem terap√™utica curta sobre: ${t}. M√ÅXIMO 500 caracteres. Seja direto e acolhedor.`;
    
    try{
        const r=await fetch("https://api.groq.com/openai/v1/chat/completions",{
            method:"POST",
            headers:{Authorization:`Bearer ${window.GROQ_API_KEY}`,"Content-Type":"application/json"},
            body:JSON.stringify({model:"llama-3.3-70b-versatile",messages:[{role:"system",content:c}],temperature:0.9, max_tokens: 200})
        });
        const d=await r.json();
        let txt = d.choices?d.choices[0].message.content:"Paz.";
        // Garante o corte se a IA desobedecer
        if(txt.length > 500) txt = txt.substring(0, 497) + "...";
        mb.innerText=txt;
    }catch(e){mb.innerText="Respire fundo. Sinta a paz."}
}

window.gerarLeitura = async function(){const tema=document.getElementById('book-theme').value;const container=document.getElementById('book-container');const loading=document.getElementById('book-loading');const titleEl=document.getElementById('book-title');const contentEl=document.getElementById('book-content');container.classList.add('hidden');loading.classList.remove('hidden');const prompt=`Escreva um cap√≠tulo curto, envolvente e inspirador de um livro fict√≠cio sobre "${tema}". Foco em bem-estar. Estilo liter√°rio cl√°ssico. Comece com T√≠tulo Criativo (sem 'Cap√≠tulo'). Use tags HTML <p>.`;try{const res=await fetch("https://api.groq.com/openai/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${window.GROQ_API_KEY}`,"Content-Type":"application/json"},body:JSON.stringify({model:"llama-3.3-70b-versatile",messages:[{role:"system",content:prompt}],temperature:0.8,max_tokens:800})});const data=await res.json();const fullText=data.choices?data.choices[0].message.content:"<p>Erro. Tente novamente.</p>";let cleanText=fullText.replace(/```html/g,'').replace(/```/g,'');let lines=cleanText.split('\n');let title=lines[0].replace(/<[^>]*>/g,'');let body=cleanText;if(title.length<100){titleEl.innerText=title;body=lines.slice(1).join('\n')}else{titleEl.innerText=tema}contentEl.innerHTML=body;loading.classList.add('hidden');container.classList.remove('hidden')}catch(e){loading.classList.add('hidden');alert("Erro na biblioteca.")}}

// --- MURAL COM GOOGLE APPS SCRIPT ---
window.saveMuralMessage = async function(){
    const input = document.getElementById('mural-input');
    const text = input.value.trim();
    if(!text) return;
    const localMsgs = JSON.parse(localStorage.getItem('mural_local') || '[]');
    localMsgs.unshift({d: new Date().toLocaleDateString('pt-BR'), t: text, local: true});
    localStorage.setItem('mural_local', JSON.stringify(localMsgs));
    if(window.SHEET_SCRIPT_URL) {
        const btn = input.nextElementSibling;
        const oldHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        try {
            await fetch(window.SHEET_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'mural', t: text }) // Identificador 'mural'
            });
            alert("Mensagem enviada para o Mural Global!");
        } catch(e) { console.error(e); alert("Salvo localmente."); } finally { btn.innerHTML = oldHtml; btn.disabled = false; }
    } else { alert("Salvo localmente."); }
    input.value = ''; window.loadMural();
}

window.loadMural = async function(){
    const list = document.getElementById('mural-list');
    list.innerHTML = '<div class="text-center text-slate-500 text-xs"><i class="fas fa-spinner fa-spin mr-2"></i>Carregando mensagens...</div>';
    let allMsgs = JSON.parse(localStorage.getItem('mural_local') || '[]');
    try {
        const res = await fetch(`https://docs.google.com/spreadsheets/d/${window.SHEET_ID}/gviz/tq?tqx=out:json`);
        const txt = await res.text();
        const json = JSON.parse(txt.substring(txt.indexOf("{"), txt.lastIndexOf("}") + 1));
        if (json.table && json.table.rows) {
            json.table.rows.forEach(row => {
                const dateVal = row.c[0] ? (row.c[0].f || row.c[0].v) : 'Global';
                const msgVal = row.c[1] ? (row.c[1].v) : null;
                if (msgVal) allMsgs.push({ d: dateVal, t: msgVal, sheet: true });
            });
        }
    } catch (e) { console.error("Erro planilha:", e); }
    if(allMsgs.length === 0) { list.innerHTML = '<div class="text-center text-slate-500 text-xs mt-4">Nenhuma mensagem ainda.</div>'; return; }
    list.innerHTML = allMsgs.map(i => `<div class="mural-card bg-slate-800 border-l-4 ${i.local ? 'border-sky-500' : 'border-emerald-500'} p-3 rounded mb-3 shadow animate-fade-in"><div class="flex justify-between items-center mb-1"><span class="font-bold ${i.local ? 'text-sky-500' : 'text-emerald-500'} text-xs uppercase">${i.local ? 'Voc√™' : 'Mural'}</span><span class="text-[10px] text-slate-500">${i.d}</span></div><p class="text-slate-300 text-sm break-words">${i.t}</p></div>`).join('');
}

// --- NOVO: REM√âDIOS NATURAIS & RANKING (ATUALIZADO PARA ENVIO INSTANT√ÇNEO) ---
const naturalItems = [
    { id: 'resp', txt: '15 min Respira√ß√£o Consciente', pts: 10 },
    { id: 'sun', txt: '20 min Luz Solar', pts: 10 },
    { id: 'water1', txt: '1 Litro de √Ågua (at√© 14h)', pts: 10 },
    { id: 'water2', txt: '1 Litro de √Ågua (at√© 20h)', pts: 10 },
    { id: 'meal', txt: '1 Refei√ß√£o Saud√°vel', pts: 10 },
    { id: 'exercise', txt: '30 min Exerc√≠cio F√≠sico', pts: 10 },
    { id: 'sleep', txt: '6 Horas de Sono', pts: 10 },
    { id: 'nofood', txt: 'Zero Industrializados Hoje', pts: 10 },
    { id: 'meditation', txt: '30 min Medita√ß√£o/Reflex√£o', pts: 10 }
];

window.initNaturalRemedies = function() {
    const list = document.getElementById('remedies-list');
    list.innerHTML = '';
    
    // Recupera checks de hoje
    const todayKey = 'remedies_' + new Date().toLocaleDateString('pt-BR');
    const savedChecks = JSON.parse(localStorage.getItem(todayKey) || '[]');
    
    // Recupera apelido salvo
    const savedNick = localStorage.getItem('wr_ranking_nick');
    if(savedNick) document.getElementById('ranking-nick').value = savedNick;

    // Recupera pontua√ß√£o local acumulada hoje
    const todayPoints = savedChecks.length * 10;
    document.getElementById('daily-points').innerText = todayPoints;

    naturalItems.forEach(item => {
        // Se j√° foi marcado hoje, N√ÉO MOSTRA NA LISTA (sai da lista)
        if(savedChecks.includes(item.id)) return;

        const div = document.createElement('div');
        div.id = `item-${item.id}`;
        div.className = 'flex items-center gap-3 bg-slate-800/80 p-3 rounded-lg border border-slate-700 hover:bg-slate-700/80 transition-all';
        div.innerHTML = `
            <label class="custom-checkbox flex items-center cursor-pointer relative">
                <input type="checkbox" onchange="window.checkNaturalItem('${item.id}', this)" class="sr-only">
                <div class="w-5 h-5 border-2 border-slate-500 rounded bg-slate-900 transition-all flex items-center justify-center"></div>
            </label>
            <span class="text-xs text-slate-300 font-medium">${item.txt}</span>
            <span class="ml-auto text-[9px] font-bold text-emerald-500">+${item.pts}</span>
        `;
        list.appendChild(div);
    });
    
    // Mensagem se tudo estiver feito
    if(list.children.length === 0) {
        list.innerHTML = '<div class="text-center p-4 bg-emerald-900/20 rounded-xl border border-emerald-800"><i class="fas fa-medal text-3xl text-yellow-400 mb-2"></i><p class="text-xs text-emerald-300">Voc√™ completou tudo por hoje! Incr√≠vel.</p></div>';
    }
}

// Fun√ß√£o de marca√ß√£o instant√¢nea
window.checkNaturalItem = async function(itemId, checkbox) {
    const nick = document.getElementById('ranking-nick').value.trim();
    if(!nick) {
        alert("Por favor, digite um Apelido para o Ranking antes de marcar!");
        checkbox.checked = false;
        return;
    }
    localStorage.setItem('wr_ranking_nick', nick);

    // 1. Feedback Visual Instant√¢neo (Sai da lista)
    const row = document.getElementById(`item-${itemId}`);
    row.classList.add('slide-out'); // Anima√ß√£o CSS definida no head

    // 2. Salvar Localmente
    const todayKey = 'remedies_' + new Date().toLocaleDateString('pt-BR');
    const savedChecks = JSON.parse(localStorage.getItem(todayKey) || '[]');
    if(!savedChecks.includes(itemId)) {
        savedChecks.push(itemId);
        localStorage.setItem(todayKey, JSON.stringify(savedChecks));
    }

    // 3. Atualizar Pontua√ß√£o Visualmente
    const currentPoints = parseInt(document.getElementById('daily-points').innerText);
    const newPoints = currentPoints + 10;
    document.getElementById('daily-points').innerText = newPoints;

    // 4. Enviar para a Planilha (Ranking)
    try {
        await fetch(window.SHEET_SCRIPT_URL, {
            method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'ranking', nick: nick, points: 10 }) // Envia +10 pontos
        });
        
        // 5. Recarregar Ranking ap√≥s envio
        // Pequeno delay para garantir que o script processou
        setTimeout(() => {
            window.loadRanking();
        }, 1500);

    } catch(e) {
        console.error("Erro no envio:", e);
        // N√£o revertemos visualmente para n√£o frustrar o usu√°rio, o local storage garante a persist√™ncia.
    }
}

window.loadRanking = async function() {
    const list = document.getElementById('ranking-list');
    list.innerHTML = '<div class="text-center text-[10px] text-slate-500 animate-pulse">Buscando l√≠deres...</div>';
    
    try {
        const res = await fetch(`https://docs.google.com/spreadsheets/d/${window.SHEET_ID}/gviz/tq?tqx=out:json&sheet=RankingDB`);
        const txt = await res.text();
        const json = JSON.parse(txt.substring(txt.indexOf("{"), txt.lastIndexOf("}") + 1));
        
        let scores = {};
        const today = new Date();
        const currentMonthRef = (today.getMonth() + 1) + "/" + today.getFullYear(); 
        
        if (json.table && json.table.rows) {
            json.table.rows.forEach(row => {
                const mesRef = row.c[3] ? row.c[3].v : "";
                if(mesRef === currentMonthRef) {
                    const nick = row.c[1] ? row.c[1].v : "An√¥nimo";
                    const pts = row.c[2] ? row.c[2].v : 0;
                    if(!scores[nick]) scores[nick] = 0;
                    scores[nick] += pts;
                }
            });
        }
        
        // Ordenar (Top 10)
        const sorted = Object.entries(scores).sort((a,b) => b[1] - a[1]).slice(0, 10);
        
        if(sorted.length === 0) {
            list.innerHTML = '<div class="text-center text-[10px] text-slate-500">Sem dados neste m√™s.</div>';
            return;
        }
        
        let html = '';
        sorted.forEach((entry, idx) => {
            let medal = '';
            let colorClass = 'text-slate-300';
            
            // L√≥gica de Medalhas Ouro/Prata/Bronze
            if(idx === 0) { medal = 'ü•á'; colorClass = 'text-yellow-400 font-bold'; }
            else if(idx === 1) { medal = 'ü•à'; colorClass = 'text-slate-300 font-bold'; }
            else if(idx === 2) { medal = 'ü•â'; colorClass = 'text-amber-600 font-bold'; }
            else { medal = `<span class="text-[9px] w-4 inline-block text-center text-slate-500">#${idx+1}</span>`; }

            html += `
                <div class="flex justify-between items-center bg-slate-800/50 px-3 py-2 rounded border border-slate-700/50 animate-fade-in">
                    <div class="flex items-center gap-2">
                        <span class="text-base">${medal}</span>
                        <span class="text-xs ${colorClass}">${entry[0]}</span>
                    </div>
                    <span class="text-[10px] font-mono text-emerald-400 font-bold">${entry[1]} pts</span>
                </div>
            `;
        });
        list.innerHTML = html;

    } catch(e) {
        console.error(e);
        list.innerHTML = '<div class="text-center text-[10px] text-red-400">Erro ao ler ranking.</div>';
    }
}

// Games Logic (mantida igual)
window.cgi=0;window.startDescompressao=function(){window.showTab('game-section');window.cgi=0;window.loadGame(0)}
window.nextGame=function(){window.cgi++;if(window.cgi<10)window.loadGame(window.cgi);else window.finishDescompressao()}
window.loadGame=function(i){document.getElementById('game-level-display').innerText=`N√≠vel ${i+1}/10`;document.getElementById('next-game-btn').classList.add('hidden');const c=document.getElementById('game-container');c.innerHTML='';if(i===0)window.initMemoryGame(c);else if(i===1)window.initIntruderGame(c);else if(i===2)window.initSlidingPuzzle(c);else if(i===3)window.initMathGame(c);else if(i===4)window.initColorGame(c);else if(i===5)window.initSequenceGame(c);else if(i===6)window.initWordScramble(c);else if(i===7)window.initReflex(c);else if(i===8)window.initLetterHunt(c);else if(i===9)window.initBreathing(c);}
window.gameWin=function(){const c=document.getElementById('game-container');c.style.boxShadow="0 0 50px #10b981";setTimeout(()=>{c.style.boxShadow="none"},500);document.getElementById('next-game-btn').classList.remove('hidden')}
window.finishDescompressao=function(){document.getElementById('game-container').innerHTML=`<div class="text-center animate-bounce"><i class="fas fa-trophy text-6xl text-yellow-400 mb-4"></i><h2 class="text-2xl font-bold text-white">Parab√©ns!</h2><p class="text-slate-300 mb-4">Mente leve.</p><button onclick="window.startDescompressao()" class="mt-6 bg-sky-600 px-6 py-2 rounded-xl text-white">Brincar Novamente</button></div>`;document.getElementById('next-game-btn').classList.add('hidden')}
window.initMemoryGame=function(c){c.innerHTML='<div id="memory-grid" class="memory-grid w-full"></div>';const g=document.getElementById('memory-grid');const i=['leaf','cloud','dove','heart','star','tree'];let d=[...i,...i].sort(()=>Math.random()-.5);let f=[],m=0;d.forEach(ic=>{const e=document.createElement('div');e.className='memory-card';e.innerHTML=`<i class="fas fa-${ic}"></i>`;e.onclick=function(){if(this.className.includes('flipped')||f.length>=2)return;this.classList.add('flipped');f.push(this);if(f.length===2){if(f[0].innerHTML===f[1].innerHTML){f.forEach(x=>x.classList.add('matched'));m++;f=[];if(m===6)window.gameWin()}else{setTimeout(()=>{f.forEach(x=>x.classList.remove('flipped'));f=[]},800)}}};g.appendChild(e)})}
window.initIntruderGame=function(c){c.innerHTML=`<div class="text-center mb-4 text-white">Encontre o diferente!</div><div class="grid grid-cols-5 gap-2" id="ig"></div>`;const g=document.getElementById('ig');const p=[{m:"üòê",i:"üòë"},{m:"üåë",i:"üåí"}];const pr=p[Math.floor(Math.random()*p.length)];const ps=Math.floor(Math.random()*25);for(let i=0;i<25;i++){const b=document.createElement('button');b.className="text-2xl p-2 bg-slate-700 rounded";b.innerText=(i===ps)?pr.i:pr.m;b.onclick=()=>{if(i===ps){b.style.background="#10b981";window.gameWin()}else{b.style.background="#ef4444"}};g.appendChild(b)}}
window.initSlidingPuzzle=function(c){c.innerHTML='<div class="text-center mb-4 text-white">Ordene 1-8</div><div class="puzzle-grid" id="pg"></div>';const g=document.getElementById('pg');let t=[1,2,3,4,5,6,7,8,null];for(let i=0;i<50;i++){const e=t.indexOf(null);const n=[];if(e%3>0)n.push(e-1);if(e%3<2)n.push(e+1);if(e>=3)n.push(e-3);if(e<6)n.push(e+3);const s=n[Math.floor(Math.random()*n.length)];[t[e],t[s]]=[t[s],t[e]]}const r=()=>{g.innerHTML='';t.forEach((v,i)=>{const d=document.createElement('div');d.className=`puzzle-tile ${v===null?'empty':''}`;if(v)d.innerText=v;d.onclick=()=>{const e=t.indexOf(null);const df=Math.abs(i-e);if(df===3||(df===1&&Math.floor(i/3)===Math.floor(e/3))){[t[i],t[e]]=[t[e],t[i]];r();if(JSON.stringify(t)==='[1,2,3,4,5,6,7,8,null]')window.gameWin()}};g.appendChild(d)})};r()}
window.initMathGame=function(c){const n1=Math.floor(Math.random()*20)+10,n2=Math.floor(Math.random()*10)+5,r=n1+n2;const w=[r+2,r-3,r+5].sort(()=>Math.random()-.5);const o=[...w.slice(0,2),r].sort(()=>Math.random()-.5);c.innerHTML=`<div class="text-center text-white"><h3 class="text-4xl font-bold mb-8">${n1} + ${n2} = ?</h3><div class="flex flex-col gap-3 max-w-xs mx-auto">${o.map(v=>`<button onclick="if(${v}===${r}){this.style.bg='#10b981';window.gameWin()}else{this.style.bg='#ef4444'}" class="btn-game bg-slate-700">${v}</button>`).join('')}</div></div>`}
window.initColorGame=function(c){const l=[{n:"VERMELHO",h:"#ef4444"},{n:"AZUL",h:"#3b82f6"},{n:"VERDE",h:"#10b981"}];const t=Math.floor(Math.random()*3);let cl=Math.floor(Math.random()*3);while(cl===t)cl=Math.floor(Math.random()*3);c.innerHTML=`<div class="text-center text-white"><p>Qual a <b>COR</b>?</p><h3 class="text-5xl font-bold mb-8" style="color:${l[cl].h}">${l[t].n}</h3><div class="grid grid-cols-2 gap-3">${l.map(x=>`<button onclick="if('${x.n}'==='${l[cl].n}'){this.style.bg='#10b981';window.gameWin()}else{this.style.bg='#ef4444'}" class="btn-game bg-slate-700 border-2" style="border-color:${x.h}">${x.n}</button>`).join('')}</div></div>`}
window.initSequenceGame=function(c){let s=[];for(let i=0;i<4;i++)s.push(Math.floor(Math.random()*9)+1);c.innerHTML=`<div class="text-center text-white"><p>Memorize:</p><div id="sd" class="text-4xl font-bold h-12 mb-8">${s.join(' ')}</div><div id="si" class="hidden grid grid-cols-3 gap-2 max-w-xs mx-auto">${[1,2,3,4,5,6,7,8,9].map(n=>`<button onclick="window.uSeq.push(${n});document.getElementById('us').innerText=window.uSeq.join(' ')" class="p-4 bg-slate-700 rounded font-bold">${n}</button>`).join('')}</div><div id="us" class="h-8 text-xl mt-4"></div><button onclick="if(JSON.stringify(window.uSeq)===JSON.stringify(window.tSeq))window.gameWin();else{window.uSeq=[];document.getElementById('us').innerText='Erro'}" id="bc" class="hidden w-full mt-4 bg-sky-600 py-2 rounded">Verificar</button></div>`;setTimeout(()=>{document.getElementById('sd').innerText="????";document.getElementById('si').classList.remove('hidden');document.getElementById('bc').classList.remove('hidden');window.tSeq=s;window.uSeq=[]},3000)}
window.initWordScramble=function(c){const words=["CALMA","VIDA","PAZ","LUZ","AMOR"];const w=words[Math.floor(Math.random()*words.length)];const s=w.split('').sort(()=>Math.random()-.5).join('');c.innerHTML=`<div class="text-center text-white"><p>Desembaralhe:</p><h3 class="text-4xl font-bold mb-4 tracking-widest">${s}</h3><input id="ws-inp" class="p-2 rounded text-black text-center uppercase" maxlength="${w.length}"><button onclick="if(document.getElementById('ws-inp').value.toUpperCase()==='${w}'){window.gameWin()}" class="mt-4 bg-sky-600 px-4 py-2 rounded w-full">Verificar</button></div>`}
window.initReflex=function(c){c.innerHTML=`<div class="text-center text-white"><p>Clique quando ficar VERDE!</p><div id="rx-box" class="w-32 h-32 bg-red-500 rounded-full mx-auto mt-8 transition-colors cursor-pointer"></div></div>`;const b=document.getElementById('rx-box');let active=false;setTimeout(()=>{b.style.backgroundColor="#10b981";active=true;b.onclick=()=>{if(active)window.gameWin()}},Math.random()*2000+1000)}
window.initLetterHunt=function(c){c.innerHTML=`<div class="text-center text-white mb-2">Ache a letra 'Q'</div><div class="grid grid-cols-6 gap-2" id="lh"></div>`;const g=document.getElementById('lh');const pos=Math.floor(Math.random()*36);for(let i=0;i<36;i++){const b=document.createElement('button');b.innerText=(i===pos)?'Q':'O';b.className="p-2 bg-slate-700 rounded text-xl";b.onclick=()=>{if(i===pos){b.style.bg="#10b981";window.gameWin()}else b.style.bg="#ef4444"};g.appendChild(b)}}
window.initBreathing=function(c){c.innerHTML=`<div class="text-center text-white"><p>Inspire... e clique ao final</p><div id="br-circle" class="w-20 h-20 bg-sky-400 rounded-full mx-auto mt-8 transition-all duration-[3000ms]"></div></div>`;setTimeout(()=>{const b=document.getElementById('br-circle');b.style.transform="scale(2.5)";setTimeout(()=>{b.innerHTML='<span class="text-xs text-black flex h-full items-center justify-center">Clique</span>';b.onclick=()=>window.gameWin()},3000)},100)}
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(SR){const r=new SR();r.lang='pt-BR';r.onresult=e=>{tat=e.results[0][0].transcript;window.toggleMic();document.getElementById('chat-form').dispatchEvent(new Event('submit'))};window.toggleMic=()=>{const b=document.getElementById('mic-btn');if(b.classList.contains('mic-active')){r.stop();b.classList.remove('mic-active','bg-red-500','text-white');b.classList.add('bg-slate-700','text-slate-400')}else{r.start();b.classList.add('mic-active','bg-red-500','text-white');b.classList.remove('bg-slate-700','text-slate-400')}}}
</script>
</body>
</html>
