<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    <title>Harmonia Di√°ria - WR TERAPIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Quicksand:wght@400;600&display=swap');

        :root { 
            --bg-dark: #0f172a; 
            --card-bg: #1e293b; 
            --primary: #0ea5e9; 
            --text-light: #f1f5f9;
            --text-dim: #94a3b8;
        }
        
        * { box-sizing: border-box; }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-dark);
            color: var(--text-light); 
            margin: 0; padding: 0;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            flex-direction: column;
        }

        .heading-font { font-family: 'Quicksand', sans-serif; }
        
        .glass-card {
            background: rgba(30, 41, 59, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        main {
            flex: 1;
            position: relative;
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
        }

        .tab-content { 
            display: none; 
            position: absolute;
            inset: 0;
            padding: 1rem;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab-content.active { 
            display: flex; 
            flex-direction: column;
            animation: fadeIn 0.3s ease-out; 
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #chat.tab-content { padding: 0; overflow: hidden; }

        .chat-layout { display: flex; flex-direction: column; height: 100%; }
        .chat-messages-area { flex: 1; overflow-y: auto; padding: 1rem; background: rgba(15, 23, 42, 0.5); }

        .message { max-width: 85%; padding: 12px 16px; border-radius: 1.2rem; font-size: 0.95rem; line-height: 1.5; margin-bottom: 12px; }
        .message.user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 0.2rem; margin-left: auto; }
        .message.therapist { align-self: flex-start; background: #334155; color: #e2e8f0; border-bottom-left-radius: 0.2rem; margin-right: auto; }
        .message.audio-msg { font-style: italic; display: flex; items-center; gap: 8px; color: #cbd5e1; }
        
        /* Jogos */
        .memory-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; perspective: 1000px; }
        .memory-card {
            background-color: #334155; height: 60px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; cursor: pointer; border: 2px solid #475569;
            color: transparent; transition: all 0.3s ease; transform-style: preserve-3d;
        }
        .memory-card.flipped, .memory-card.matched { background-color: #f1f5f9; border-color: var(--primary); color: #333; transform: rotateY(180deg); }
        .memory-card.matched { background-color: #10b981; border-color: #059669; color: white; cursor: default; }

        /* Puzzle Deslizante */
        .puzzle-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; width: 100%; aspect-ratio: 1; background: #334155; padding: 4px; border-radius: 8px; }
        .puzzle-tile {
            background: var(--primary); color: white; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; font-weight: bold; cursor: pointer; border-radius: 4px;
            user-select: none; transition: transform 0.2s;
        }
        .puzzle-tile.empty { background: transparent; cursor: default; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }

        .btn-game { @apply w-full py-3 rounded-xl font-bold shadow-lg transition-all active:scale-95; }
        input, select, textarea { background-color: #334155; color: white; border-color: #475569; }
        input::placeholder, textarea::placeholder { color: #94a3b8; }
    </style>
</head>
<body>

    <!-- Header Fixo -->
    <header class="flex-none p-4 text-center bg-slate-900/95 backdrop-blur-md border-b border-slate-700 z-20">
        <h1 class="text-xl font-bold text-sky-400 heading-font">Espa√ßo | WR Terapia¬Æ</h1>
    </header>

    <!-- Container Principal -->
    <main>
        
        <!-- ONBOARDING -->
        <section id="onboarding" class="tab-content active">
            <div class="h-full flex flex-col items-center justify-center p-4">
                <div class="glass-card p-8 text-center w-full">
                    <div class="w-20 h-20 bg-slate-700 rounded-full flex items-center justify-center mb-6 mx-auto ring-2 ring-sky-500/50">
                        <i class="fas fa-fingerprint text-sky-400 text-3xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2 heading-font">Bem-vindo(a)</h2>
                    <p class="text-sm text-slate-400 mb-8">Identifique-se para acessar seu espa√ßo seguro.</p>
                    <div class="w-full mb-4 space-y-3">
                        <select id="user-gender" class="w-full p-4 rounded-2xl outline-none focus:ring-2 focus:ring-sky-500">
                            <option value="homem">Sou Homem</option>
                            <option value="mulher">Sou Mulher</option>
                        </select>
                        <input type="text" id="user-name-input" oninput="this.value = this.value.toUpperCase()" placeholder="SEU NOME" class="w-full p-4 rounded-2xl text-center uppercase font-bold outline-none focus:ring-2 focus:ring-sky-500">
                    </div>
                    <button onclick="login()" class="w-full bg-sky-600 text-white py-4 rounded-2xl font-bold shadow-lg mt-2 hover:bg-sky-500 transition-all">Entrar</button>
                </div>
            </div>
        </section>

        <!-- HOME -->
        <section id="home" class="tab-content">
            <div class="glass-card p-6 mb-4">
                <p class="text-xs text-slate-400">Boa noite,</p>
                <h2 class="text-xl font-bold text-white heading-font mb-6 client-name">Visitante</h2>
                
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="openChatSelection()" class="p-4 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-3 hover:bg-slate-700 transition-all">
                        <i class="fas fa-comment-medical text-2xl text-sky-400"></i>
                        <span class="text-[10px] font-bold uppercase text-slate-300">Conversar</span>
                    </button>
                    <button onclick="showTab('agenda')" class="p-4 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-3 hover:bg-slate-700 transition-all">
                        <i class="fas fa-calendar-check text-2xl text-emerald-400"></i>
                        <span class="text-[10px] font-bold uppercase text-slate-300">Agendar</span>
                    </button>
                    <button onclick="showTab('mural')" class="p-4 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-3 hover:bg-slate-700 transition-all">
                        <i class="fas fa-comments text-2xl text-amber-400"></i>
                        <span class="text-[10px] font-bold uppercase text-slate-300">Mural</span>
                    </button>
                    <button onclick="showTab('hope')" class="p-4 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-3 hover:bg-slate-700 transition-all">
                        <i class="fas fa-lightbulb text-2xl text-yellow-400"></i>
                        <span class="text-[10px] font-bold uppercase text-slate-300">Caixinha IA</span>
                    </button>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <button onclick="showTab('relaxation')" class="p-4 bg-purple-900/30 rounded-2xl border border-purple-800/50 flex flex-col items-center gap-2 hover:bg-purple-900/50 transition-all">
                        <i class="fas fa-spa text-xl text-purple-400"></i>
                        <span class="text-[9px] font-bold uppercase text-purple-300">Relaxar</span>
                    </button>
                    <button onclick="startDescompressao()" class="p-4 bg-rose-900/30 rounded-2xl border border-rose-800/50 flex flex-col items-center gap-2 hover:bg-rose-900/50 transition-all">
                        <i class="fas fa-brain text-xl text-rose-400"></i>
                        <span class="text-[9px] font-bold uppercase text-rose-300">Descompress√£o</span>
                    </button>
                </div>
            </div>
            
            <!-- Cr√©ditos Rodap√© -->
            <div class="mt-auto pt-8 pb-4 text-center">
                <p class="text-[9px] text-slate-600 uppercase font-bold tracking-widest">Desenvolvido por WR-TECNOLOGIA | William Ribeiro</p>
            </div>
        </section>

        <!-- AGENDA -->
        <section id="agenda" class="tab-content">
            <div class="glass-card p-4 h-full flex flex-col">
                <div class="flex items-center gap-3 mb-4 flex-none">
                    <button onclick="showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button>
                    <h2 class="font-bold text-sky-400 heading-font">Agendamento</h2>
                </div>
                <div class="flex-1 rounded-xl overflow-hidden border border-slate-600 bg-white">
                    <iframe src="https://calendly.com/wrterapia/atendimentos" width="100%" height="100%" frameborder="0"></iframe>
                </div>
                <p class="text-[10px] text-slate-500 mt-3 text-center italic">Agenda autom√°tica.</p>
            </div>
        </section>

        <!-- SELE√á√ÉO CHAT -->
        <section id="chat-selection" class="tab-content">
            <div class="glass-card p-6 h-full overflow-y-auto">
                <div class="flex items-center gap-3 mb-4">
                    <button onclick="showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button>
                    <h2 class="font-bold text-sky-400 text-lg">Nossa Equipe</h2>
                </div>
                <div id="therapist-list" class="space-y-3 pb-20"></div>
            </div>
        </section>

        <!-- CHAT (Layout Fixo Interno) -->
        <section id="chat" class="tab-content">
            <div class="chat-layout h-full">
                <!-- Chat Header -->
                <div class="p-4 border-b border-slate-700 flex items-center gap-3 bg-slate-800/95 flex-none z-10">
                    <div id="active-avatar" class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-md"></div>
                    <div class="flex-1">
                        <p id="active-name" class="font-bold text-white text-sm"></p>
                        <div class="flex items-center">
                            <span id="active-status-dot" class="status-dot"></span>
                            <span id="active-status-text" class="text-[9px] uppercase font-bold text-slate-400">Status</span>
                        </div>
                    </div>
                    <button onclick="openChatSelection()" class="text-slate-400 hover:text-white p-2"><i class="fas fa-times"></i></button>
                </div>
                
                <!-- Messages Area -->
                <div id="chat-messages" class="chat-messages-area"></div>
                
                <!-- Typing Indicator & Input -->
                <div class="flex-none bg-slate-800 border-t border-slate-700 pb-2">
                    <div id="typing-box" class="px-4 py-2 hidden text-xs text-sky-400 italic font-medium bg-slate-900/30">
                        Digitando <span class="animate-pulse">...</span>
                    </div>
                    <div class="p-3">
                        <form id="chat-form" class="flex items-center gap-2">
                            <button type="button" id="mic-btn" onclick="toggleMic()" class="w-10 h-10 bg-slate-700 rounded-full text-slate-400 hover:text-white transition-colors flex items-center justify-center"><i class="fas fa-microphone"></i></button>
                            <input type="text" id="chat-input" placeholder="Digite aqui..." class="flex-1 bg-slate-700 border-0 text-white rounded-full px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-sky-500 placeholder-slate-400">
                            
                            <!-- Bot√£o WhatsApp (Dr. William) -->
                            <button type="button" id="wa-btn" onclick="sendToWhatsapp()" class="hidden w-10 h-10 bg-emerald-600 text-white rounded-full shadow-md hover:bg-emerald-500 transition-colors flex items-center justify-center"><i class="fab fa-whatsapp text-lg"></i></button>
                            
                            <button type="submit" class="w-10 h-10 bg-sky-600 text-white rounded-full shadow-md hover:bg-sky-500 transition-colors flex items-center justify-center"><i class="fas fa-paper-plane"></i></button>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <!-- RELAXAMENTO -->
        <section id="relaxation" class="tab-content">
            <div class="glass-card p-4 h-full flex flex-col">
                <div class="flex items-center gap-3 mb-4 flex-none">
                    <button onclick="showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button>
                    <h2 class="font-bold text-sky-400">Relaxamento</h2>
                </div>
                
                <div class="aspect-video w-full rounded-xl overflow-hidden shadow-lg flex-none border border-slate-600 bg-black">
                    <iframe width="100%" height="100%" src="https://www.youtube.com/embed/sF80I-TQiW0" frameborder="0" allowfullscreen></iframe>
                </div>
                
                <div class="mt-4 p-5 bg-slate-800/80 rounded-2xl border border-slate-700 text-slate-300 leading-relaxed text-sm shadow-inner flex-1 overflow-y-auto">
                    <p class="mb-4">
                        Muitas vezes em nossas rotinas nos perdemos em pensamentos e sofrimentos, mas √© fundamental parar, relaxar e deixar sentir a leveza da vida.
                    </p>
                    <p class="mb-4">
                        Ent√£o, d√™ play, encontre um espa√ßo confort√°vel e deixe a ansiedade, a ang√∫stia e os sentimentos negativos irem embora. Foco no som agrad√°vel da m√∫sica e nas gotas de chuva, imagine hist√≥rias agrad√°veis, locais lindos e hist√≥rias incr√≠veis.
                    </p>
                    <p class="mb-6">
                        Abrace um travesseiro, feche os olhos e se reconstrua.
                    </p>
                    <p class="text-right font-bold text-sky-500 font-heading text-xs">
                        Att. William Ribeiro - O seu terapeuta ‚ù§Ô∏è
                    </p>
                </div>
            </div>
        </section>

        <!-- MURAL -->
        <section id="mural" class="tab-content">
            <div class="glass-card p-5 h-full flex flex-col">
                <div class="flex items-center gap-3 mb-4 flex-none">
                    <button onclick="showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button>
                    <div>
                        <h2 class="font-bold text-sky-400">Mural de Sentimentos</h2>
                        <p class="text-[10px] text-slate-500">Compartilhe suas experi√™ncias anonimamente.</p>
                    </div>
                </div>
                
                <div id="mural-list" class="flex-1 overflow-y-auto mb-4 space-y-3 pr-1 pb-20">
                    <!-- Mensagens -->
                </div>

                <div class="mt-auto pt-4 border-t border-slate-700 flex-none bg-slate-800/50 p-2 rounded-xl">
                    <textarea id="mural-input" placeholder="Escreva algo transformador..." class="w-full p-3 rounded-xl border border-slate-600 h-20 resize-none text-sm bg-slate-800 mb-2 focus:ring-2 focus:ring-amber-500 outline-none"></textarea>
                    <button onclick="saveMuralMessage()" class="w-full bg-amber-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-amber-500 transition-all">
                        <i class="fas fa-paper-plane mr-2"></i>Publicar
                    </button>
                </div>
            </div>
        </section>

        <!-- CAIXINHA IA -->
        <section id="hope" class="tab-content">
            <div class="glass-card p-6 min-h-full flex flex-col justify-center overflow-y-auto">
                <div class="flex justify-between items-center mb-6 flex-none">
                    <button onclick="showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button>
                    <h2 class="font-bold text-lg text-yellow-400">Caixinha Emocional</h2>
                    <div class="w-8"></div>
                </div>

                <div class="mb-8 flex-none text-center">
                    <div class="w-24 h-24 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 border border-slate-600 shadow-lg animate-pulse">
                        <i class="fas fa-gift text-yellow-400 text-4xl"></i>
                    </div>
                    <p class="text-sm text-slate-400 mb-2">Toque para receber uma mensagem de luz para sua noite.</p>
                </div>

                <button onclick="gerarCaixinha()" class="flex-none w-full bg-gradient-to-r from-amber-600 to-orange-600 text-white py-4 rounded-xl font-bold shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 border border-amber-500/50">
                    <i class="fas fa-magic mr-2"></i>Gerar Experi√™ncia
                </button>

                <div id="resultadoBox" class="mt-8 hidden animate-fade-in pb-20 flex-none">
                    <img id="imgBox" class="rounded-xl mb-4 shadow-lg w-full h-48 object-cover bg-slate-800 border border-slate-700"/>
                    <div class="bg-slate-800/80 p-5 rounded-xl border border-slate-700 shadow-sm">
                        <p id="msgBox" class="italic text-slate-200 text-sm font-medium leading-relaxed text-center"></p>
                    </div>
                </div>
            </div>
        </section>

        <!-- DESCOMPRESS√ÉO (5 JOGOS) -->
        <section id="game-section" class="tab-content">
            <div class="glass-card p-5 h-full flex flex-col">
                <div class="flex items-center justify-between mb-4 flex-none">
                    <div class="flex items-center gap-2">
                        <button onclick="showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i class="fas fa-arrow-left text-slate-300"></i></button>
                        <h2 class="font-bold text-rose-400">Descompress√£o</h2>
                    </div>
                    <span class="text-xs font-bold bg-rose-900/50 text-rose-300 px-3 py-1 rounded-full border border-rose-800" id="game-level-display">N√≠vel 1/6</span>
                </div>

                <div class="mb-4 bg-slate-800/50 p-3 rounded-xl border border-slate-700 flex-none">
                    <p class="text-xs text-slate-400 text-center leading-relaxed">
                        Este √© um espa√ßo seguro para brincar, relaxar e sair da rotina. <br>
                        Treine seu racioc√≠nio, mem√≥ria e percep√ß√£o.
                    </p>
                </div>
                
                <!-- Container dos Jogos -->
                <div id="game-container" class="flex-1 flex flex-col items-center justify-center w-full relative overflow-y-auto">
                    <!-- O conte√∫do do jogo ser√° injetado aqui via JS -->
                </div>

                <!-- Bot√£o Pr√≥ximo -->
                <button id="next-game-btn" onclick="nextGame()" class="flex-none hidden mt-4 bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg w-full animate-bounce">
                    Pr√≥ximo Desafio <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </section>

    </main>

    <!-- Nav Fixo -->
    <nav class="flex-none bg-slate-900/95 backdrop-blur-md border-t border-slate-800 py-3 flex justify-around z-50">
        <button onclick="showTab('home')" class="text-sky-500 flex flex-col items-center gap-1 hover:text-sky-400 transition-colors"><i class="fas fa-home"></i><span class="text-[9px] font-bold tracking-widest">IN√çCIO</span></button>
        <button onclick="openChatSelection()" class="text-slate-500 flex flex-col items-center gap-1 hover:text-slate-300 transition-colors"><i class="fas fa-comment"></i><span class="text-[9px] font-bold tracking-widest">CHAT</span></button>
    </nav>

    <script>
        const GROQ_API_KEY = "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";
        
        let clientName = "Visitante";
        let clientGender = "homem";
        let chatHistory = [];
        let isWaiting = false;
        let messageCounter = 0;
        let activeTherapist = null;
        
        // --- CHAT SYSTEM ---
        const offlineResponses = {
            'lia': ["Conte comigo para o que precisar.", "Respire fundo, estou te ouvindo.", "Seu sentimento √© importante."],
            'william': ["Estou aqui para te ouvir.", "Vamos entender isso juntos.", "Pode falar, estou atento."],
            'yara': ["A noite traz calma, conte comigo.", "Estou aqui por voc√™.", "Pode desabafar tranquilamente."],
            'fer': ["Posso ajudar em algo mais?", "O sistema √© simples, estou √† disposi√ß√£o.", "Qualquer d√∫vida, √© s√≥ chamar."]
        };

        const therapists = [
            { id: 'lia', name: 'Dra. Lia', color: '#ec4899', icon: 'heart' },
            { id: 'william', name: 'Dr. William', color: '#0ea5e9', icon: 'user-tie' },
            { id: 'yara', name: 'Dra. Yara', color: '#8b5cf6', icon: 'moon' },
            { id: 'fer', name: 'Fernanda', color: '#10b981', icon: 'headset' }
        ];

        function getSystemPrompt(therapistId) {
            const tratamento = clientGender === "homem" ? "querido" : "querida";
            const amigo = clientGender === "homem" ? "amigo" : "amiga";
            const formal = clientGender === "homem" ? "Sr." : "Sra.";
            
            // LINGUAGEM NEUTRA E ACOLHEDORA (SEM SOTAQUE) + Din√¢mica de tamanho + In√≠cio Objetivo
            const estilo = "IMPORTANTE: Responda de forma din√¢mica, variando entre respostas curtas, m√©dias e um pouco mais longas, mas NUNCA ultrapasse 500 caracteres. No in√≠cio da conversa, seja MAIS OBJETIVO e fa√ßa perguntas curtas para estimular o cliente a falar mais. Use linguagem culta, leve, calorosa e emp√°tica. Evite g√≠rias ou regionalismos. Foco total em acolhimento e escuta ativa.";

            const prompts = {
                'lia': `Voc√™ √© a Dra. Lia, uma terapeuta muito experiente e maternal (mas profissional). Seu foco √© acolhimento profundo. Trate de forma gentil e valida os sentimentos. ${estilo}`,
                'william': `Voc√™ √© o Dr. William. Jovem, din√¢mico e focado em personaliza√ß√£o. Chame o paciente pelo NOME frequentemente. Ex: 'Entendo, ${clientName}'. ${estilo}`,
                'yara': `Voc√™ √© a Dra. Yara, terapeuta da madrugada. Voz serena e calma. Chame de '${amigo}' e ocasionalmente use '${tratamento}'. ${estilo}`,
                'fer': `Voc√™ √© a Fernanda, recepcionista. Educada e eficiente. Trate por '${formal} ${clientName}'. Ajude com d√∫vidas do app. ${estilo}`
            };
            return prompts[therapistId] || "";
        }

        function login() {
            const name = document.getElementById('user-name-input').value.trim();
            clientGender = document.getElementById('user-gender').value;
            if(name) {
                clientName = name;
                document.querySelectorAll('.client-name').forEach(el => el.innerText = clientName);
                showTab('home');
                loadMural(); 
            } else alert("Por favor, digite seu nome.");
        }

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function openChatSelection() {
            const list = document.getElementById('therapist-list');
            list.innerHTML = '';
            therapists.forEach(t => {
                const card = document.createElement('div');
                card.className = `flex items-center gap-4 p-4 bg-slate-800 rounded-xl border border-slate-700 shadow-sm transition-all mb-3 cursor-pointer hover:bg-slate-700`;
                card.onclick = () => startChat(t.id);
                card.innerHTML = `
                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" style="background-color:${t.color}"><i class="fas fa-${t.icon}"></i></div>
                    <div class="flex-1"><span class="font-bold text-sm text-slate-200">${t.name}</span><div class="flex items-center"><span class="status-dot status-online"></span><span class="text-[8px] uppercase font-bold text-slate-500">Online</span></div></div>
                `;
                list.appendChild(card);
            });
            showTab('chat-selection');
        }

        function startChat(id) {
            activeTherapist = therapists.find(t => t.id === id);
            document.getElementById('active-name').innerText = activeTherapist.name;
            document.getElementById('active-avatar').style.backgroundColor = activeTherapist.color;
            document.getElementById('active-avatar').innerHTML = `<i class="fas fa-${activeTherapist.icon}"></i>`;
            document.getElementById('active-status-dot').className = `status-dot status-online`;
            document.getElementById('active-status-text').innerText = "Online";
            document.getElementById('chat-messages').innerHTML = '';
            messageCounter = 0;
            chatHistory = [{ role: "system", content: `${getSystemPrompt(id)} Paciente: ${clientName}.` }];
            
            // Bot√£o WhatsApp vis√≠vel apenas para Dr. William
            const waBtn = document.getElementById('wa-btn');
            if(id === 'william') {
                waBtn.classList.remove('hidden');
            } else {
                waBtn.classList.add('hidden');
            }
            
            let welcome = "Ol√°! Como posso ajudar?";
            // Boas-vindas sem sugest√£o de agenda para Lia
            if (id === 'lia') welcome = `Ol√° ${clientName}. Que bom ter voc√™ aqui. Sou a Dra. Lia. Como voc√™ est√° se sentindo hoje?`;
            else if (id === 'william') welcome = `Oi ${clientName}, tudo bem? Sou o Dr. William. Estou inteiramente √† sua disposi√ß√£o. O que gostaria de compartilhar?`;
            else if (id === 'yara') welcome = `Ol√°, amigo(a). A noite √© um momento de reflex√£o. Estou aqui ao seu lado, querido(a).`;
            else if (id === 'fer') welcome = `Ol√°, ${clientGender === 'homem' ? 'Sr.' : 'Sra.'} ${clientName}. Sou a Fernanda. Como posso auxiliar voc√™ com o uso do aplicativo?`;

            addMessage(welcome, 'therapist', false);
            showTab('chat');
        }

        function sendToWhatsapp() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            const phone = "5541992531598";
            
            let msg = `Ol√° Dr. William, sou ${clientName}. Vim pelo App Harmonia Di√°ria.`;
            if(text) msg += ` Gostaria de falar sobre: ${text}`;
            
            const url = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }

        function addMessage(text, type, saveToHistory=true, isAudio=false) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            if (isAudio && type === 'user') {
                div.classList.add('audio-msg');
                div.innerHTML = '<i class="fas fa-microphone-lines text-lg text-sky-400"></i> <span class="text-xs">√Åudio enviado...</span>';
            } else {
                div.innerHTML = text;
            }
            const container = document.getElementById('chat-messages');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            if(saveToHistory) chatHistory.push({ role: type === 'user' ? 'user' : 'assistant', content: text });
        }

        let tempAudioText = "";
        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            let text = input.value.trim();
            let isAudioMsg = false;
            if(!text && !tempAudioText) return;
            if(isWaiting) return;
            if (tempAudioText) { text = tempAudioText; isAudioMsg = true; tempAudioText = ""; }
            else { text = input.value.trim(); }
            
            addMessage(text, 'user', true, isAudioMsg);
            input.value = '';
            isWaiting = true;
            messageCounter++;

            let waitTime = (messageCounter % 2 !== 0) ? 30000 : 40000;
            let typingTime = 30000;

            const apiPromise = fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${GROQ_API_KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: chatHistory, temperature: 0.7, max_tokens: 300 }) // Ajustado tokens para resposta m√©dia
            }).then(res => res.json()).catch(() => null);

            setTimeout(() => {
                document.getElementById('typing-box').classList.remove('hidden');
                setTimeout(async () => {
                    document.getElementById('typing-box').classList.add('hidden');
                    const data = await apiPromise;
                    if (data && data.choices) addMessage(data.choices[0].message.content, 'therapist');
                    else addMessage("Estou te ouvindo, pode continuar...", 'therapist');
                    isWaiting = false;
                }, typingTime);
            }, waitTime);
        };

        // --- CAIXINHA EMOCIONAL ---
        async function gerarCaixinha() {
            const temas = ["acolhimento", "paz", "emo√ß√µes", "esperan√ßa", "calma", "gratid√£o"];
            const paisagens = ["montanhas", "mar", "floresta", "chuva", "p√¥r do sol", "campo", "c√©u estrelado"];
            const tema = temas[Math.floor(Math.random() * temas.length)];
            const paisagem = paisagens[Math.floor(Math.random() * paisagens.length)];
            
            const resBox = document.getElementById("resultadoBox");
            const imgBox = document.getElementById("imgBox");
            const msgBox = document.getElementById("msgBox");
            
            resBox.classList.remove("hidden");
            msgBox.innerText = "Sintonizando energia...";
            imgBox.src = "";
            
            const traducoes = { "montanhas": "mountains", "mar": "sea", "floresta": "forest", "chuva": "rain", "p√¥r do sol": "sunset", "campo": "meadow", "c√©u estrelado": "starry night" };
            const termo = traducoes[paisagem] || "nature";
            imgBox.src = `https://loremflickr.com/800/600/${termo},nature?lock=${Math.floor(Math.random() * 1000)}`;

            const comando = `Crie uma mensagem terap√™utica curta (max 3 frases), leve, culta e acolhedora sobre: ${tema} e ${paisagem}.`;
            
            try {
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST", headers: { Authorization: `Bearer ${GROQ_API_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: [{role: "system", content: comando}], temperature: 0.9 })
                });
                const data = await res.json();
                msgBox.innerText = data.choices ? data.choices[0].message.content : "Respire fundo. Vai ficar tudo bem.";
            } catch (e) { msgBox.innerText = "Sinta a paz deste momento."; }
        }

        // --- MURAL ---
        function saveMuralMessage() {
            const txt = document.getElementById('mural-input').value;
            if(!txt) return;
            const msgs = JSON.parse(localStorage.getItem('mural_data') || '[]');
            msgs.unshift({d: new Date().toLocaleDateString(), t: txt});
            localStorage.setItem('mural_data', JSON.stringify(msgs));
            document.getElementById('mural-input').value = '';
            loadMural();
        }
        function loadMural() {
            let msgs = JSON.parse(localStorage.getItem('mural_data') || '[]');
            if(msgs.length === 0) msgs = [{d: 'hoje', t: 'Aprendi que respirar fundo muda tudo.'}, {d: 'ontem', t: 'N√£o tenha medo de recome√ßar.'}];
            document.getElementById('mural-list').innerHTML = msgs.map(i => `
                <div class="mural-card bg-slate-800 border-l-4 border-amber-500 p-3 rounded mb-3 shadow">
                    <div class="flex justify-between items-center mb-1"><span class="font-bold text-amber-500 text-xs uppercase">An√¥nimo</span><span class="text-[10px] text-slate-500">${i.d}</span></div>
                    <p class="text-slate-300 text-sm">${i.t}</p>
                </div>`).join('');
        }

        // --- SISTEMA DE DESCOMPRESS√ÉO (6 JOGOS) ---
        let currentGameIndex = 0;
        
        function startDescompressao() {
            showTab('game-section');
            currentGameIndex = 0;
            loadGame(currentGameIndex);
        }

        function nextGame() {
            currentGameIndex++;
            if(currentGameIndex < 6) {
                loadGame(currentGameIndex);
            } else {
                finishDescompressao();
            }
        }

        function loadGame(index) {
            document.getElementById('game-level-display').innerText = `N√≠vel ${index + 1}/6`;
            document.getElementById('next-game-btn').classList.add('hidden');
            const container = document.getElementById('game-container');
            container.innerHTML = ''; 

            switch(index) {
                case 0: initMemoryGame(container); break;
                case 1: initIntruderGame(container); break;
                case 2: initSlidingPuzzle(container); break; // Novo Jogo
                case 3: initMathGame(container); break;
                case 4: initColorGame(container); break;
                case 5: initSequenceGame(container); break;
            }
        }

        function finishDescompressao() {
            const container = document.getElementById('game-container');
            container.innerHTML = `
                <div class="text-center animate-bounce">
                    <i class="fas fa-trophy text-6xl text-yellow-400 mb-4"></i>
                    <h2 class="text-2xl font-bold text-white mb-2">Parab√©ns!</h2>
                    <p class="text-slate-300">Voc√™ completou a descompress√£o.</p>
                    <p class="text-slate-400 text-sm mt-2">Voc√™ exercitou racioc√≠nio, mem√≥ria e percep√ß√£o.</p>
                    <button onclick="startDescompressao()" class="mt-6 bg-sky-600 text-white px-6 py-2 rounded-xl font-bold">Jogar Novamente</button>
                </div>
            `;
            document.getElementById('game-level-display').innerText = "Conclu√≠do";
            document.getElementById('next-game-btn').classList.add('hidden');
        }

        function gameWin() {
            const container = document.getElementById('game-container');
            container.style.boxShadow = "0 0 50px #10b981";
            setTimeout(() => { container.style.boxShadow = "none"; }, 500);
            document.getElementById('next-game-btn').classList.remove('hidden');
        }

        // JOGO 1: MEM√ìRIA
        function initMemoryGame(container) {
            container.innerHTML = '<div id="memory-grid" class="memory-grid w-full"></div>';
            const grid = document.getElementById('memory-grid');
            const icons = ['leaf', 'cloud', 'dove', 'heart', 'star', 'tree'];
            let cards = [...icons, ...icons].sort(() => Math.random() - 0.5);
            let flipped = [], matched = 0;
            cards.forEach(icon => {
                const card = document.createElement('div');
                card.className = 'memory-card';
                card.innerHTML = `<i class="fas fa-${icon}"></i>`;
                card.onclick = function() {
                    if (this.classList.contains('flipped') || this.classList.contains('matched') || flipped.length >= 2) return;
                    this.classList.add('flipped'); flipped.push(this);
                    if (flipped.length === 2) {
                        if (flipped[0].innerHTML === flipped[1].innerHTML) {
                            flipped.forEach(c => c.classList.add('matched')); matched++; flipped = [];
                            if (matched === icons.length) gameWin();
                        } else { setTimeout(() => { flipped.forEach(c => c.classList.remove('flipped')); flipped = []; }, 800); }
                    }
                };
                grid.appendChild(card);
            });
        }

        // JOGO 2: O INTRUSO (DIF√çCIL)
        function initIntruderGame(container) {
            container.innerHTML = `<div class="text-center mb-4"><p class="text-white">Encontre o diferente!</p></div><div class="grid grid-cols-5 gap-2" id="intruder-grid"></div>`;
            const grid = document.getElementById('intruder-grid');
            // Pares confusos para dificultar
            const pairs = [
                {m: "üòê", i: "üòë"}, {m: "üò†", i: "üò°"}, {m: "üò∫", i: "üò∏"}, 
                {m: "üåë", i: "üåí"}, {m: "üçÄ", i: "‚òòÔ∏è"}, {m: "üè†", i: "üè°"}
            ];
            const pair = pairs[Math.floor(Math.random() * pairs.length)];
            const pos = Math.floor(Math.random() * 25);
            
            for(let i=0; i<25; i++) {
                const btn = document.createElement('button'); btn.className = "text-2xl p-2 bg-slate-700 rounded-lg";
                btn.innerText = (i === pos) ? pair.i : pair.m;
                btn.onclick = () => { if(i===pos){btn.style.bg="#10b981"; gameWin();} else {btn.style.bg="#ef4444"; setTimeout(()=>btn.style.bg="",300);} };
                grid.appendChild(btn);
            }
        }

        // JOGO 3: PUZZLE DESLIZANTE (NOVO)
        function initSlidingPuzzle(container) {
            container.innerHTML = `
                <div class="text-center mb-4"><p class="text-white">Ordene de 1 a 8</p></div>
                <div class="puzzle-grid" id="puzzle-grid"></div>
            `;
            const grid = document.getElementById('puzzle-grid');
            let tiles = [1,2,3,4,5,6,7,8,null];
            
            // Embaralhar (garantindo que seja resolv√≠vel ou apenas randomizando movimentos v√°lidos)
            // M√©todo simples: fazer movimentos aleat√≥rios a partir do resolvido
            for(let i=0; i<100; i++) {
                const emptyIdx = tiles.indexOf(null);
                const neighbors = [];
                if(emptyIdx % 3 > 0) neighbors.push(emptyIdx - 1);
                if(emptyIdx % 3 < 2) neighbors.push(emptyIdx + 1);
                if(emptyIdx >= 3) neighbors.push(emptyIdx - 3);
                if(emptyIdx < 6) neighbors.push(emptyIdx + 3);
                const swapIdx = neighbors[Math.floor(Math.random() * neighbors.length)];
                [tiles[emptyIdx], tiles[swapIdx]] = [tiles[swapIdx], tiles[emptyIdx]];
            }

            const render = () => {
                grid.innerHTML = '';
                tiles.forEach((tile, idx) => {
                    const el = document.createElement('div');
                    el.className = `puzzle-tile ${tile === null ? 'empty' : ''}`;
                    if(tile) el.innerText = tile;
                    el.onclick = () => moveTile(idx);
                    grid.appendChild(el);
                });
                checkWin();
            };

            const moveTile = (idx) => {
                const emptyIdx = tiles.indexOf(null);
                const diff = Math.abs(idx - emptyIdx);
                if (diff === 3 || (diff === 1 && Math.floor(idx/3) === Math.floor(emptyIdx/3))) {
                    [tiles[idx], tiles[emptyIdx]] = [tiles[emptyIdx], tiles[idx]];
                    render();
                }
            };

            const checkWin = () => {
                const winState = [1,2,3,4,5,6,7,8,null];
                if(JSON.stringify(tiles) === JSON.stringify(winState)) gameWin();
            };

            render();
        }

        // JOGO 4: C√ÅLCULO ZEN
        function initMathGame(container) {
            const n1 = Math.floor(Math.random()*20)+10; const n2 = Math.floor(Math.random()*10)+5; const res = n1+n2;
            const wrongs = [res+2, res-3, res+5].sort(()=>Math.random()-0.5); const opts = [...wrongs.slice(0,2), res].sort(()=>Math.random()-0.5);
            container.innerHTML = `<div class="text-center w-full"><h3 class="text-4xl text-white font-bold mb-8">${n1} + ${n2} = ?</h3><div class="flex flex-col gap-3 max-w-xs mx-auto">${opts.map(o=>`<button onclick="checkMath(this,${o},${res})" class="btn-game bg-slate-700 text-white">${o}</button>`).join('')}</div></div>`;
        }
        window.checkMath = (btn,v,c) => { if(v===c){btn.style.backgroundColor="#10b981"; gameWin();} else btn.style.backgroundColor="#ef4444"; };
        
        // JOGO 5: CORES
        function initColorGame(container) {
            const cols = [{n:"VERMELHO",h:"#ef4444"},{n:"AZUL",h:"#3b82f6"},{n:"VERDE",h:"#10b981"},{n:"AMARELO",h:"#eab308"}];
            const tIdx = Math.floor(Math.random()*4); let cIdx = Math.floor(Math.random()*4); while(cIdx===tIdx) cIdx=Math.floor(Math.random()*4);
            container.innerHTML = `<div class="text-center w-full"><p class="text-white mb-2">Qual a <b>COR</b>?</p><h3 class="text-5xl font-bold mb-8" style="color:${cols[cIdx].h}">${cols[tIdx].n}</h3><div class="grid grid-cols-2 gap-3 w-full">${cols.map(c=>`<button onclick="checkColor(this,'${c.n}','${cols[cIdx].n}')" class="btn-game bg-slate-700 text-white border-2" style="border-color:${c.h}">${c.n}</button>`).join('')}</div></div>`;
        }
        window.checkColor = (btn,v,c) => { if(v===c){btn.style.backgroundColor="#10b981"; gameWin();} else btn.style.backgroundColor="#ef4444"; };
        
        // JOGO 6: SEQU√äNCIA
        function initSequenceGame(container) {
            let seq=[]; for(let i=0;i<4;i++) seq.push(Math.floor(Math.random()*9)+1);
            container.innerHTML = `<div class="text-center w-full"><p class="text-white mb-4">Memorize:</p><div id="seq-disp" class="text-4xl font-bold text-sky-400 tracking-widest mb-8 h-12">${seq.join(' ')}</div><div id="seq-inp" class="hidden grid grid-cols-3 gap-2 max-w-xs mx-auto">${[1,2,3,4,5,6,7,8,9].map(n=>`<button onclick="addSeq(${n})" class="p-4 bg-slate-700 rounded-lg text-xl font-bold">${n}</button>`).join('')}</div><div id="u-seq" class="h-8 text-xl text-emerald-400 mt-4 tracking-widest"></div><button onclick="checkSeq()" id="btn-chk" class="hidden w-full mt-4 bg-sky-600 text-white py-2 rounded-xl">Verificar</button></div>`;
            setTimeout(()=>{document.getElementById('seq-disp').innerText="????"; document.getElementById('seq-inp').classList.remove('hidden'); document.getElementById('btn-chk').classList.remove('hidden'); window.tSeq=seq; window.cSeq=[];},3000);
        }
        window.addSeq = (n) => { window.cSeq.push(n); document.getElementById('u-seq').innerText = window.cSeq.join(' '); };
        window.checkSeq = () => { if(JSON.stringify(window.cSeq)===JSON.stringify(window.tSeq)) gameWin(); else { document.getElementById('u-seq').innerText="Tente de novo..."; window.cSeq=[]; setTimeout(()=>document.getElementById('u-seq').innerText="",1000); } };

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(SpeechRecognition) {
            const rec = new SpeechRecognition(); rec.lang = 'pt-BR';
            rec.onresult = e => { tempAudioText = e.results[0][0].transcript; toggleMic(); document.getElementById('chat-form').dispatchEvent(new Event('submit')); };
            window.toggleMic = () => { const btn = document.getElementById('mic-btn'); if(btn.classList.contains('mic-active')) { rec.stop(); btn.classList.remove('mic-active','bg-red-500','text-white'); btn.classList.add('bg-slate-700','text-slate-400'); } else { rec.start(); btn.classList.add('mic-active','bg-red-500','text-white'); btn.classList.remove('bg-slate-700','text-slate-400'); } };
        }
    </script>
</body>
</html>
