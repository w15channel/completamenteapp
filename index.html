<!DOCTYPE html><html lang="pt-br"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="mobile-web-app-capable" content="yes"><meta name="theme-color" content="#0f172a"><title>Harmonia Di√°ria - WR TERAPIA</title><script src="https://cdn.tailwindcss.com"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"><script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script><script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script><style>@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Quicksand:wght@400;600&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&family=Playfair+Display:ital,wght@0,700;1,600&display=swap');:root{--bg-dark:#0f172a;--card-bg:#1e293b;--primary:#0ea5e9;--text-light:#f1f5f9;--text-dim:#94a3b8;--gold:#c4a661}*{box-sizing:border-box}body{font-family:'Inter',sans-serif;background-color:var(--bg-dark);color:var(--text-light);margin:0;padding:0;position:fixed;inset:0;display:flex;flex-direction:column}.heading-font{font-family:'Quicksand',sans-serif}.glass-card{background:rgba(30,41,59,0.98);border:1px solid rgba(255,255,255,0.1);border-radius:1.5rem;box-shadow:0 4px 6px -1px rgba(0,0,0,0.5)}main{flex:1;position:relative;width:100%;max-width:480px;margin:0 auto;transition:max-width 0.3s}.tab-content{display:none;position:absolute;inset:0;padding:1rem;overflow-y:auto;-webkit-overflow-scrolling:touch}.tab-content.active{display:flex;flex-direction:column;animation:fadeIn .3s ease-out}@keyframes fadeIn{from{opacity:0}to{opacity:1}}#chat.tab-content{padding:0;overflow:hidden}.chat-layout{display:flex;flex-direction:column;height:100%}.chat-messages-area{flex:1;overflow-y:auto;padding:1rem;background:rgba(15,23,42,0.5)}.message{max-width:85%;padding:12px 16px;border-radius:1.2rem;font-size:.95rem;line-height:1.5;margin-bottom:12px}.message.user{align-self:flex-end;background:var(--primary);color:#fff;border-bottom-right-radius:.2rem;margin-left:auto}.message.therapist{align-self:flex-start;background:#334155;color:#e2e8f0;border-bottom-left-radius:.2rem;margin-right:auto}.message.audio-msg{font-style:italic;display:flex;align-items:center;gap:8px;color:#cbd5e1}.message.system-note{align-self:center;background:rgba(239,68,68,0.2);color:#fca5a5;font-size:0.8rem;text-align:center;border:1px solid rgba(239,68,68,0.4);width:90%}.memory-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}.memory-card{background-color:#334155;height:60px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;border:2px solid #475569;color:transparent;transition:all .3s ease;transform-style:preserve-3d}.memory-card.flipped,.memory-card.matched{background-color:#f1f5f9;border-color:var(--primary);color:#333;transform:rotateY(180deg)}.memory-card.matched{background-color:#10b981;border-color:#059669;color:#fff;cursor:default}.puzzle-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;width:100%;aspect-ratio:1;background:#334155;padding:4px;border-radius:8px}.puzzle-tile{background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:bold;cursor:pointer;border-radius:4px;user-select:none;transition:transform .2s}.puzzle-tile.empty{background:transparent;cursor:default}.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px}.status-online{background-color:#10b981;box-shadow:0 0 5px #10b981}.status-busy{background-color:#f59e0b;box-shadow:0 0 5px #f59e0b}.status-offline{background-color:#94a3b8}.admin-trigger{opacity:.1;transition:opacity .3s;cursor:pointer}.admin-trigger:hover{opacity:1}.book-page{background-color:#fdf6e3;color:#2c1810;font-family:'Merriweather',serif;padding:2rem;border-radius:4px;box-shadow:inset 20px 0 50px rgba(0,0,0,0.1),5px 5px 15px rgba(0,0,0,0.3);border-left:5px solid #d4c5b0;line-height:1.8;position:relative;overflow:hidden;min-height:400px}.book-page::before{content:"";position:absolute;top:0;bottom:0;left:0;width:100%;background:linear-gradient(90deg,rgba(0,0,0,0.05) 0%,rgba(0,0,0,0) 10%,rgba(0,0,0,0) 90%,rgba(0,0,0,0.05) 100%);pointer-events:none}.slide-frame{position:relative;width:100%;aspect-ratio:1;border-radius:1rem;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,0.6);border:1px solid rgba(196,166,97,0.2)}.slide-bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:1;opacity:0.65}.slide-overlay{position:absolute;inset:0;z-index:2;background:linear-gradient(180deg,rgba(0,0,0,0.1) 0%,rgba(0,0,0,0.9) 100%)}.slide-content{position:relative;z-index:3;height:100%;padding:2rem;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center}.slide-text{font-family:'Playfair Display',serif;font-size:0.95rem;line-height:1.6;color:#fff;margin-bottom:1rem;font-style:italic;text-shadow:2px 2px 4px rgba(0,0,0,0.8);text-align:justify;overflow-y:auto;max-height:85%}.slide-footer{margin-top:auto;font-size:0.6rem;color:var(--gold);letter-spacing:3px;text-transform:uppercase;font-weight:800;font-family:'Inter',sans-serif}.btn-game{@apply w-full py-3 rounded-xl font-bold shadow-lg transition-all active:scale-95}input,select,textarea{background-color:#334155;color:#fff;border-color:#475569}input::placeholder,textarea::placeholder{color:#94a3b8}input:disabled{opacity:0.6;cursor:not-allowed}.admin-grid{display:grid;grid-template-columns:300px 1fr 350px;gap:16px;height:100%}@media(max-width:1024px){.admin-grid{display:flex;flex-direction:column}}::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#475569;border-radius:2px}.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;text-align:center}.cal-header{font-size:0.7rem;font-weight:bold;color:#94a3b8;margin-bottom:4px}.cal-cell{background:#1e293b;border-radius:6px;padding:6px 2px;font-size:0.8rem;position:relative;min-height:45px;display:flex;flex-direction:column;align-items:center}.dot-container{display:flex;gap:2px;margin-top:4px;flex-wrap:wrap;justify-content:center}</style><script src="https://www.youtube.com/iframe_api"></script></head><body><header class="flex-none p-4 text-center bg-slate-900/95 backdrop-blur-md border-b border-slate-700 z-20 relative"><button id="music-toggle" onclick="window.toggleMusic()" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-sky-400 transition-colors w-8 h-8 flex items-center justify-center rounded-full active:bg-slate-800"><i id="music-icon" class="fas fa-volume-mute"></i></button><h1 class="text-lg uppercase tracking-widest font-bold text-sky-400 font-sans">ESPA√áO | WR TERAPIA¬Æ</h1></header><main id="main-area"><div id="bg-music-player" style="display:none;"></div><div id="consent-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/95 backdrop-blur-sm"><div class="glass-card p-6 w-full max-w-sm animate-fade-in border border-sky-500/30"><div class="w-16 h-16 bg-sky-900/50 rounded-full flex items-center justify-center mb-4 mx-auto text-sky-400"><i class="fas fa-hand-holding-heart text-3xl animate-pulse"></i></div><h3 class="text-xl font-bold text-center text-white mb-4 heading-font">Seu acolhimento em primeiro lugar</h3><div class="text-xs text-slate-300 space-y-3 mb-6 text-justify leading-relaxed"><p>"Para garantir que voc√™ nunca fique sem amparo, utilizamos um sistema de <b>Atendimento H√≠brido</b>. Sempre que nossos profissionais estiverem ocupados, acionamos nossa IA de suporte. Ela oferece escuta e conforto imediatos, sempre supervisionada."</p></div><div class="flex flex-col gap-3"><button onclick="window.acceptTerms()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl font-bold shadow-lg transition-all">Aceito os termos</button><button onclick="window.declineTerms()" class="w-full bg-slate-700 hover:bg-slate-600 text-slate-300 py-3 rounded-xl font-bold transition-all">N√£o aceito (Voltar)</button></div></div></div><section id="onboarding" class="tab-content active"><div class="h-full flex flex-col items-center justify-center p-4"><div class="glass-card p-8 text-center w-full"><div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mb-6 mx-auto ring-2 ring-sky-500/50 shadow-[0_0_15px_rgba(14,165,233,0.3)]"><i class="fas fa-fingerprint text-sky-400 text-3xl"></i></div><h2 class="text-2xl font-bold text-white mb-2 heading-font">Acesso Seguro</h2><p class="text-[10px] text-emerald-400 font-bold mb-6"><i class="fas fa-shield-alt mr-1"></i>Ambiente Criptografado</p><div class="w-full mb-4 space-y-3"><select id="user-gender" class="w-full p-4 rounded-xl outline-none bg-slate-800 text-white border border-slate-600 focus:ring-2 focus:ring-sky-500 text-sm font-bold"><option value="" disabled selected>SELECIONE SEU G√äNERO</option><option value="M">Mulher</option><option value="H">Homem</option></select><input type="text" id="user-name-input" oninput="this.value=this.value.toUpperCase()" placeholder="PRIMEIRO E SEGUNDO NOME" class="w-full p-4 rounded-xl text-center uppercase font-bold outline-none focus:ring-2 focus:ring-sky-500 text-sm bg-slate-800 border border-slate-600"><input type="password" id="user-pass-input" placeholder="SENHA (DDMMAAAA)" maxlength="8" class="w-full p-4 rounded-xl text-center font-bold outline-none focus:ring-2 focus:ring-sky-500 tracking-widest text-sm bg-slate-800 border border-slate-600"><label class="flex items-center justify-center gap-2 text-xs text-slate-400 mt-2 cursor-pointer"><input type="checkbox" id="remember-me" class="w-4 h-4 rounded bg-slate-700"> Mantenha-me conectado</label></div><button onclick="window.login(false)" class="w-full bg-sky-600 text-white py-4 rounded-xl font-bold shadow-lg mt-2 hover:bg-sky-500 transition-all">Entrar / Cadastrar</button></div></div></section><section id="home" class="tab-content"><div class="glass-card p-6 mb-4"><p class="text-xs text-slate-400">Muito bom te ver aqui,</p><h2 class="text-xl font-bold text-white heading-font mb-6 client-name">...</h2><div class="grid grid-cols-2 gap-3"><button onclick="window.triggerChatSelection()" class="p-3 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-2 hover:bg-slate-700"><i class="fas fa-comment-medical text-2xl text-sky-400"></i><span class="text-[9px] font-bold uppercase text-slate-300">Conversar</span></button><button onclick="window.showTab('routines')" class="p-3 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-2 hover:bg-slate-700"><i class="fas fa-check-circle text-2xl text-emerald-400"></i><span class="text-[9px] font-bold uppercase text-slate-300">Minha Rotina</span></button><button onclick="window.showTab('cycle')" class="p-3 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-2 hover:bg-slate-700"><i class="fas fa-calendar-alt text-2xl text-rose-400"></i><span class="text-[9px] font-bold uppercase text-slate-300">Meu Ciclo</span></button><button onclick="window.showTab('agenda')" class="p-3 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-2 hover:bg-slate-700"><i class="fas fa-calendar-check text-2xl text-amber-400"></i><span class="text-[9px] font-bold uppercase text-slate-300">Agendar</span></button><button onclick="window.showTab('mural')" class="p-3 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-2 hover:bg-slate-700"><i class="fas fa-comments text-2xl text-orange-400"></i><span class="text-[9px] font-bold uppercase text-slate-300">Mural</span></button><button onclick="window.showTab('hope')" class="p-3 bg-slate-700/50 rounded-2xl border border-slate-600 flex flex-col items-center gap-2 hover:bg-slate-700"><i class="fas fa-lightbulb text-2xl text-yellow-400"></i><span class="text-[9px] font-bold uppercase text-slate-300">Caixinha</span></button><button onclick="window.showTab('relaxation')" class="p-3 bg-purple-900/30 rounded-2xl border border-purple-800/50 flex flex-col items-center gap-2 hover:bg-purple-900/50"><i class="fas fa-spa text-xl text-purple-400"></i><span class="text-[9px] font-bold uppercase text-purple-300">Relaxar</span></button><button onclick="window.startDescompressao()" class="p-3 bg-rose-900/30 rounded-2xl border border-rose-800/50 flex flex-col items-center gap-2 hover:bg-rose-900/50"><i class="fas fa-brain text-xl text-rose-400"></i><span class="text-[9px] font-bold uppercase text-rose-300">Jogos</span></button></div><button onclick="window.showTab('library')" class="w-full mt-3 p-3 bg-indigo-900/30 rounded-2xl border border-indigo-800/50 flex flex-col items-center gap-2 hover:bg-indigo-900/50"><i class="fas fa-book-open text-xl text-indigo-400"></i><span class="text-[9px] font-bold uppercase text-indigo-300">Biblioteca M√°gica</span></button></div><div class="mt-auto pt-4 pb-4 text-center flex flex-col items-center justify-center gap-2"><p class="text-[9px] text-slate-600 uppercase font-bold tracking-widest">Desenvolvido por WR-TECNOLOGIA</p><div class="flex gap-4"><button onclick="window.logoutUser()" class="text-xs text-red-500 font-bold"><i class="fas fa-sign-out-alt"></i> Sair</button><i onclick="window.showAdminLogin()" class="fas fa-lock text-slate-700 text-xs admin-trigger" title="Admin"></i></div></div></section><section id="routines" class="tab-content"><div class="h-full flex flex-col relative"><div class="flex items-center gap-3 mb-3 flex-none px-2"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center hover:bg-slate-700"><i class="fas fa-arrow-left text-slate-300"></i></button><div class="flex-1"><h2 class="font-bold text-emerald-400 text-lg">Minha Rotina</h2><div class="w-full bg-slate-800 rounded-full h-2 mt-1 border border-slate-700 overflow-hidden relative"><div id="rt-progress-bar" class="bg-emerald-500 h-full rounded-full transition-all duration-500" style="width: 0%"></div></div><p id="rt-progress-text" class="text-[9px] text-slate-400 mt-1 font-bold">0% CONCLU√çDO HOJE</p></div></div><div class="px-2 mb-3 flex-none"><div class="bg-slate-800/80 p-3 rounded-xl border border-slate-700 shadow-inner"><input type="text" id="rt-goal-week" placeholder="üéØ Meta da Semana" class="w-full bg-transparent border-b border-slate-600 mb-2 pb-1 text-xs outline-none text-slate-200 placeholder-slate-500 focus:border-emerald-500 transition-colors" onblur="window.saveGoals()"><input type="text" id="rt-goal-month" placeholder="üèÜ Meta do M√™s" class="w-full bg-transparent text-xs outline-none text-slate-200 placeholder-slate-500 focus:border-emerald-500 transition-colors" onblur="window.saveGoals()"></div></div><div id="task-list-container" class="flex-1 overflow-y-auto px-2 pb-20 space-y-4"><div id="area-todo" class="hidden"><h3 class="text-[10px] font-bold text-emerald-400 mb-2 uppercase tracking-widest"><i class="fas fa-clipboard-list mr-1"></i> A Fazer</h3><div id="tasks-todo" class="space-y-2"></div></div><div id="area-done" class="hidden"><h3 class="text-[10px] font-bold text-slate-500 mb-2 uppercase tracking-widest"><i class="fas fa-check-double mr-1"></i> Conclu√≠das</h3><div id="tasks-done" class="space-y-2 opacity-70"></div></div><div id="no-tasks-msg" class="text-center mt-10 text-slate-500 hidden"><i class="fas fa-mug-hot text-4xl mb-3 text-slate-600"></i><p class="text-xs">Sua lista est√° limpa. Adicione tarefas para organizar seu dia.</p></div></div><button onclick="window.openTaskModal()" class="absolute bottom-6 right-4 w-14 h-14 bg-emerald-600 hover:bg-emerald-500 text-white rounded-full shadow-[0_0_20px_rgba(16,185,129,0.4)] flex items-center justify-center text-xl transition-transform active:scale-95 z-30"><i class="fas fa-plus"></i></button><div id="task-modal" class="hidden absolute inset-0 z-50 bg-slate-900/95 backdrop-blur-sm flex flex-col items-center justify-center p-4"><div class="bg-slate-800 border border-slate-700 p-5 rounded-2xl w-full max-w-sm shadow-xl"><h3 class="font-bold text-white mb-4"><i class="fas fa-edit text-emerald-400 mr-2"></i>Nova Tarefa</h3><input type="text" id="task-name" placeholder="Ex: Beber √°gua, Ler 10 p√°ginas..." class="w-full p-3 rounded-xl bg-slate-900 border border-slate-600 text-sm mb-3 outline-none focus:border-emerald-500 text-white font-bold"><div class="flex gap-3 mb-4"><div class="flex-1"><label class="text-[10px] text-slate-400 font-bold ml-1">Hor√°rio (Lembrete)</label><input type="time" id="task-time" class="w-full p-3 rounded-xl bg-slate-900 border border-slate-600 text-sm outline-none text-white focus:border-emerald-500 font-bold"></div><div class="flex-1"><label class="text-[10px] text-slate-400 font-bold ml-1">Frequ√™ncia</label><select id="task-freq" class="w-full p-3 rounded-xl bg-slate-900 border border-slate-600 text-sm outline-none text-white focus:border-emerald-500 font-bold"><option value="daily">Todos os dias</option><option value="weekdays">Dias √∫teis</option><option value="once">Apenas hoje</option></select></div></div><div class="flex gap-2"><button onclick="window.closeTaskModal()" class="flex-1 p-3 rounded-xl font-bold text-slate-300 bg-slate-700 hover:bg-slate-600 transition-colors">Cancelar</button><button onclick="window.saveNewTask()" class="flex-1 p-3 rounded-xl font-bold text-white bg-emerald-600 hover:bg-emerald-500 shadow-lg transition-colors">Salvar</button></div></div></div></div></section><section id="cycle" class="tab-content"><div class="glass-card p-4 h-full flex flex-col"><div class="flex items-center gap-3 mb-4 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><i class="fas fa-arrow-left text-slate-300"></i></button><div><h2 class="font-bold text-rose-400">Meu Ciclo</h2><p class="text-[9px] text-slate-400">Calend√°rio e Sintomas</p></div></div><div id="cycle-woman-view" class="flex-1 flex flex-col hidden"><div class="bg-slate-800 p-3 rounded-xl border border-slate-700 mb-3 flex-none"><label class="block text-slate-300 text-[10px] font-bold mb-1"><i class="fas fa-share-alt text-emerald-400 mr-1"></i>Seu C√≥digo de Compartilhamento:</label><div class="flex items-center gap-2"><input type="text" id="cy-share-code" readonly placeholder="Nenhum c√≥digo gerado" class="flex-1 p-2 rounded bg-slate-900 text-xs text-center font-bold text-emerald-400 tracking-widest border border-slate-600 outline-none"><button onclick="window.generateShareCode()" class="bg-sky-600 text-white p-2 rounded hover:bg-sky-500" title="Gerar Novo C√≥digo"><i class="fas fa-sync-alt"></i></button><button onclick="window.copyShareCode()" class="bg-emerald-600 text-white p-2 rounded hover:bg-emerald-500" title="Copiar"><i class="fas fa-copy"></i></button></div><p class="text-[9px] text-slate-500 mt-1 text-center">Compartilhe este c√≥digo com seu parceiro.</p></div><div class="bg-slate-800 p-3 rounded-xl border border-slate-700 mb-3 flex-none"><label class="block text-slate-300 text-xs font-bold mb-1">Primeiro dia da √∫ltima menstrua√ß√£o:</label><div class="flex gap-2"><input type="date" id="cy-date" class="flex-1 p-2 rounded bg-slate-900 text-sm border border-slate-600 text-white"><button onclick="window.saveCycleDate()" class="bg-rose-600 hover:bg-rose-500 text-white px-3 rounded font-bold shadow-lg"><i class="fas fa-save"></i></button></div><div class="flex items-center justify-center gap-3 mt-3 text-[9px] font-bold text-slate-400"><span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span> Menstrua√ß√£o</span><span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-400"></span> F√©rtil</span><span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-400"></span> TPM</span></div></div><div class="bg-slate-900 p-2 rounded-xl mb-3 flex-none border border-slate-700" id="calendar-container"><div class="text-center text-xs text-slate-500 py-4">Insira a data acima para gerar o calend√°rio.</div></div><div class="flex-1 flex flex-col min-h-[160px] pb-4"><label class="block text-slate-300 text-xs font-bold mb-1"><i class="fas fa-book-open text-sky-400 mr-1"></i>Di√°rio de Sentimentos:</label><div id="cy-notes-list" class="flex-1 overflow-y-auto mb-2 space-y-2 bg-slate-900/50 p-2 rounded-xl border border-slate-700 text-sm"></div><div class="flex gap-2 flex-none"><textarea id="cy-new-note" placeholder="Como est√° se sentindo agora?..." class="flex-1 p-2 rounded-xl resize-none text-sm bg-slate-900 border border-slate-700 h-12 outline-none focus:ring-1 focus:ring-rose-500"></textarea><button onclick="window.saveCycleNote()" class="bg-rose-600 hover:bg-rose-500 text-white px-4 rounded-xl font-bold shadow-lg"><i class="fas fa-paper-plane"></i></button></div></div></div><div id="cycle-man-view" class="flex-1 flex flex-col items-center justify-center hidden text-center"><div class="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mb-4 text-rose-400 shadow-[0_0_15px_rgba(225,29,72,0.3)]"><i class="fas fa-lock text-3xl"></i></div><h3 class="text-white font-bold mb-2">Acesso ao Ciclo</h3><p class="text-xs text-slate-400 mb-6 px-4">Para visualizar o calend√°rio e o di√°rio de sentimentos da sua parceira, insira o c√≥digo gerado por ela.</p><input type="text" id="partner-code-input" placeholder="C√ìDIGO DE COMPARTILHAMENTO" class="w-full p-3 rounded-xl bg-slate-900 border border-slate-700 text-sm text-center font-bold mb-4 outline-none focus:ring-2 focus:ring-rose-500 tracking-widest uppercase"><button onclick="window.loadPartnerCycle()" class="w-full bg-rose-600 text-white py-3 rounded-xl font-bold shadow-lg mb-4">Acessar</button><div id="partner-cycle-result" class="w-full text-left hidden flex-1 overflow-y-auto pb-6"><h4 class="font-bold text-sky-400 text-sm mb-2 border-b border-slate-700 pb-1" id="pc-title"></h4><div id="pc-calendar" class="bg-slate-900 p-2 rounded-xl mb-3 border border-slate-700"></div><div class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col max-h-[250px]"><p class="text-xs font-bold text-slate-300 mb-2 flex-none">Di√°rio de Sentimentos (Apenas Visualiza√ß√£o):</p><div id="pc-notes-list" class="flex-1 overflow-y-auto space-y-2 pr-1"></div></div></div></div></div></section><section id="library" class="tab-content"><div class="glass-card p-4 h-full flex flex-col"><div class="flex items-center gap-3 mb-4 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-indigo-400">Biblioteca M√°gica</h2></div><div class="mb-4 text-center flex-none"><p class="text-xs text-slate-400 mb-2">Escolha um tema e deixe nosso sistema te apresentar um cap√≠tulo exclusivo.</p></div><div class="flex-none mb-4"><select id="book-theme" class="w-full p-3 rounded-xl text-sm bg-slate-800 text-slate-200 border border-slate-600 focus:ring-2 focus:ring-indigo-500"><option value="Autoconhecimento">Autoconhecimento</option><option value="Resili√™ncia">Resili√™ncia</option><option value="Ansiedade e Calma">Ansiedade e Calma</option><option value="Relacionamentos Saud√°veis">Relacionamentos Saud√°veis</option><option value="Prop√≥sito de Vida">Prop√≥sito de Vida</option><option value="Sono e Descanso">Sono e Descanso</option><option value="Foco e Disciplina">Foco e Disciplina</option></select><button onclick="window.gerarLeitura()" class="w-full mt-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg"><i class="fas fa-pen-fancy mr-2"></i>Ler um Cap√≠tulo</button></div><div id="book-container" class="flex-1 overflow-y-auto hidden animate-fade-in"><div class="book-page"><h3 id="book-title" class="text-xl font-bold mb-4 text-center border-b border-stone-400 pb-2"></h3><div id="book-content" class="text-sm text-justify"></div><p class="text-center mt-8 text-xs text-stone-500 italic">~ Fim do Cap√≠tulo ~</p></div></div><div id="book-loading" class="hidden flex-1 flex flex-col items-center justify-center text-indigo-300"><i class="fas fa-feather-alt fa-spin text-4xl mb-3"></i><p class="text-sm animate-pulse">Buscando seu Cap√≠tulo...</p></div></div></section><section id="admin-login-screen" class="tab-content justify-center items-center"><div class="glass-card p-6 w-full text-center max-w-sm mx-auto"><div class="flex justify-between items-center mb-4"><button onclick="window.showTab('home')" class="text-slate-400"><i class="fas fa-arrow-left"></i></button><h2 class="font-bold text-white">Administra√ß√£o</h2><div class="w-4"></div></div><input type="text" id="admin-user" placeholder="Login Admin" class="w-full p-3 mb-3 rounded-xl text-center"><input type="password" id="admin-pass" placeholder="Senha Admin" class="w-full p-3 mb-4 rounded-xl text-center"><button onclick="window.attemptAdminLogin()" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold">Acessar</button></div></section><section id="admin-dashboard" class="tab-content"><div class="glass-card p-4 h-full flex flex-col"><div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-700 flex-none"><h2 class="font-bold text-emerald-400"><i class="fas fa-satellite-dish mr-2"></i>Torre de Controle WR</h2><button onclick="window.logoutAdmin()" class="bg-red-900/50 text-red-300 px-3 py-1 rounded-full text-xs border border-red-800">Sair</button></div><div class="admin-grid flex-1 overflow-hidden"><div class="bg-slate-900/50 rounded-xl border border-slate-700 flex flex-col overflow-hidden"><div class="p-2 bg-slate-800 text-xs font-bold text-slate-300 border-b border-slate-700 text-center">Pacientes Online/Hist√≥rico</div><div id="admin-chat-list" class="flex-1 overflow-y-auto p-2 space-y-2"></div></div><div class="bg-slate-900/50 rounded-xl border border-slate-700 flex flex-col overflow-hidden"><div class="p-2 bg-slate-800 flex justify-between items-center border-b border-slate-700"><span id="admin-target-name" class="text-xs font-bold text-white truncate">Selecione um Chat</span><button onclick="window.toggleAiStatus()" id="ai-toggle-btn" class="text-[9px] bg-slate-600 px-2 py-1 rounded hidden font-bold">IA: ATIVA</button></div><div id="admin-chat-preview" class="flex-1 overflow-y-auto p-4 text-sm bg-[#0f172a]"></div><div class="p-2 bg-slate-800 border-t border-slate-700 flex gap-2"><input type="text" id="admin-reply-input" placeholder="Assumir o controle..." class="flex-1 p-2 rounded bg-slate-700 text-sm"><button onclick="window.sendAdminReply()" class="bg-emerald-600 px-4 py-2 rounded text-white shadow"><i class="fas fa-paper-plane"></i></button></div></div><div class="bg-slate-900/50 rounded-xl border border-slate-700 flex flex-col overflow-hidden"><div class="p-2 bg-slate-800 text-xs font-bold text-sky-400 border-b border-slate-700 text-center"><i class="fas fa-clipboard-list mr-1"></i> Ficha & Notepad</div><div id="admin-user-data" class="flex-1 overflow-y-auto p-4 text-xs space-y-4 text-slate-300 flex flex-col justify-between"><div id="admin-user-info">Selecione um usu√°rio para visualizar cadastro, rotinas, ciclo e bloco de notas.</div><div id="admin-actions" class="hidden flex gap-2 border-t border-slate-700 pt-3"><button onclick="window.adminBlockUser()" class="flex-1 bg-amber-600/20 text-amber-500 border border-amber-500/50 py-2 rounded font-bold">Bloquear</button><button onclick="window.adminDeleteUser()" class="flex-1 bg-red-600/20 text-red-500 border border-red-500/50 py-2 rounded font-bold">Excluir</button></div></div></div></div></div></section><section id="agenda" class="tab-content"><div class="glass-card p-4 h-full flex flex-col"><div class="flex items-center gap-3 mb-4 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-sky-400 heading-font">Agendamento</h2></div><div class="flex-1 rounded-xl overflow-hidden border border-slate-600 bg-white"><iframe src="https://calendly.com/wrterapia/atendimentos" width="100%" height="100%" frameborder="0"></iframe></div></div></section><section id="chat-selection" class="tab-content"><div class="glass-card p-6 h-full overflow-y-auto"><div class="flex items-center gap-3 mb-4"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-sky-400 text-lg">Nossa Equipe</h2></div><div id="therapist-list" class="space-y-3 pb-20"></div></div></section><section id="chat" class="tab-content"><div class="chat-layout h-full"><div class="p-4 border-b border-slate-700 flex items-center gap-3 bg-slate-800/95 flex-none z-10"><div id="active-avatar" class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-md"></div><div class="flex-1"><p id="active-name" class="font-bold text-white text-sm"></p><div class="flex items-center"><span id="active-status-dot" class="status-dot"></span><span id="active-status-text" class="text-[9px] uppercase font-bold text-slate-400">Status</span></div></div><button onclick="window.showTab('chat-selection')" class="text-slate-400 hover:text-white p-2"><i class="fas fa-times"></i></button></div><div id="chat-messages" class="chat-messages-area"></div><div class="flex-none bg-slate-800 border-t border-slate-700 pb-2"><div id="typing-box" class="px-4 py-2 hidden text-xs text-sky-400 italic font-medium bg-slate-900/30">Digitando <span class="animate-pulse">...</span></div><div class="p-3"><form id="chat-form" class="flex items-center gap-2"><input type="text" id="chat-input" placeholder="Digite aqui..." class="flex-1 bg-slate-700 border-0 text-white rounded-full px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-sky-500 placeholder-slate-400 transition-all"><button type="button" id="mic-btn" onclick="window.startVoice()" class="w-10 h-10 bg-slate-600 text-white rounded-full shadow-md flex items-center justify-center hover:bg-slate-500"><i class="fas fa-microphone"></i></button><button type="button" id="wa-btn" onclick="window.sendToWhatsapp()" class="hidden w-10 h-10 bg-emerald-600 text-white rounded-full shadow-md hover:bg-emerald-500 flex items-center justify-center"><i class="fab fa-whatsapp text-lg"></i></button><button type="submit" id="submit-btn" class="w-10 h-10 bg-sky-600 text-white rounded-full shadow-md hover:bg-sky-500 flex items-center justify-center"><i class="fas fa-paper-plane"></i></button></form></div></div></div></section><section id="relaxation" class="tab-content"><div class="glass-card p-4 h-full flex flex-col"><div class="flex items-center gap-3 mb-4 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-sky-400">Relaxamento</h2></div><div class="aspect-video w-full rounded-xl overflow-hidden shadow-lg flex-none border border-slate-600 bg-black"><iframe width="100%" height="100%" src="https://www.youtube.com/embed/sF80I-TQiW0" frameborder="0" allowfullscreen></iframe></div><div class="mt-4 p-5 bg-slate-800/80 rounded-2xl border border-slate-700 text-slate-300 leading-relaxed text-sm shadow-inner flex-1 overflow-y-auto"><p class="mb-4">Muitas vezes em nossas rotinas nos perdemos em pensamentos e sofrimentos, mas √© fundamental parar, relaxar e deixar sentir a leveza da vida.</p><p class="mb-4">Ent√£o, d√™ play, encontre um espa√ßo confort√°vel e deixe a ansiedade, a ang√∫stia e os sentimentos negativos irem embora.</p><p class="mb-6">Abrace um travesseiro, feche os olhos e se reconstrua.</p><p class="text-right font-bold text-sky-500 font-heading text-xs">Att. William Ribeiro - O seu terapeuta ‚ù§Ô∏è</p></div></div></section><section id="mural" class="tab-content"><div class="glass-card p-5 h-full flex flex-col"><div class="flex items-center gap-3 mb-4 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><i class="fas fa-arrow-left text-slate-300"></i></button><div><h2 class="font-bold text-sky-400">Mural de Sentimentos</h2><p class="text-[10px] text-slate-500">Compartilhe experi√™ncias anonimamente.</p></div></div><div id="mural-list" class="flex-1 overflow-y-auto mb-4 space-y-3 pr-1 pb-20"></div><div class="mt-auto pt-4 border-t border-slate-700 flex-none bg-slate-800/50 p-2 rounded-xl"><textarea id="mural-input" placeholder="Escreva algo transformador..." class="w-full p-3 rounded-xl border border-slate-600 h-20 resize-none text-sm bg-slate-800 mb-2 focus:ring-2 focus:ring-amber-500 outline-none"></textarea><button onclick="window.saveMuralMessage()" class="w-full bg-amber-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-amber-500"><i class="fas fa-paper-plane mr-2"></i>Publicar</button></div></div></section><section id="hope" class="tab-content"><div class="glass-card p-6 min-h-full flex flex-col justify-center overflow-y-auto"><div class="flex justify-between items-center mb-6 flex-none"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-lg" style="color:var(--gold)">Caixinha Surpresa</h2><div class="w-8"></div></div><div class="mb-6 flex-none text-center"><div class="w-20 h-20 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 border border-[var(--gold)] shadow-[0_0_15px_rgba(196,166,97,0.2)] animate-pulse"><i class="fas fa-gift text-2xl" style="color:var(--gold)"></i></div><p class="text-xs text-slate-400">Toque para receber luz.</p></div><div id="resultadoBox" class="mb-6 hidden animate-fade-in flex-none w-full"><div class="slide-frame mb-4" id="capture_area"><img id="imgBox" src="" class="slide-bg" crossorigin="anonymous"><div class="slide-overlay"></div><div class="slide-content"><div class="slide-text" id="msgBox">...</div><div class="slide-footer">WR-TEC | CONFORTO</div></div></div><button onclick="window.downloadMsg(event)" class="w-full bg-slate-800 border border-slate-600 text-slate-300 py-3 rounded-xl font-bold hover:bg-slate-700 text-xs"><i class="fa-solid fa-camera mr-2"></i> Salvar na Galeria</button></div><div class="pb-20"><button onclick="window.gerarCaixinha()" id="caixinha-btn" class="w-full border-2 border-[#c4a661] text-[#c4a661] uppercase tracking-[3px] font-bold py-4 rounded-full shadow-[0_0_20px_rgba(196,166,97,0.1)] hover:bg-[#c4a661] hover:text-black text-sm"><i class="fas fa-magic mr-2"></i>Gerar Experi√™ncia</button></div></div></section><section id="game-section" class="tab-content"><div class="glass-card p-5 h-full flex flex-col"><div class="flex items-center justify-between mb-4 flex-none"><div class="flex items-center gap-2"><button onclick="window.showTab('home')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><i class="fas fa-arrow-left text-slate-300"></i></button><h2 class="font-bold text-rose-400">Descompress√£o</h2></div><span class="text-xs font-bold bg-rose-900/50 text-rose-300 px-3 py-1 rounded-full border border-rose-800" id="game-level-display">N√≠vel 1/13</span></div><div class="mb-4 bg-slate-800/50 p-3 rounded-xl border border-slate-700 flex-none"><p class="text-xs text-slate-400 text-center leading-relaxed">Treine racioc√≠nio, mem√≥ria e percep√ß√£o.</p></div><div id="game-container" class="flex-1 flex flex-col items-center justify-center w-full relative overflow-y-auto"></div><button id="next-game-btn" onclick="window.nextGame()" class="flex-none hidden mt-4 bg-emerald-600 text-white py-3 rounded-xl font-bold shadow-lg w-full animate-bounce">Pr√≥ximo Desafio <i class="fas fa-arrow-right ml-2"></i></button></div></section></main><nav id="bottom-nav" class="flex-none bg-slate-900/95 backdrop-blur-md border-t border-slate-800 py-3 flex justify-around z-50" style="display:none;"><button onclick="window.showTab('home')" class="text-sky-500 flex flex-col items-center gap-1"><i class="fas fa-home"></i><span class="text-[9px] font-bold tracking-widest">IN√çCIO</span></button><button onclick="window.triggerChatSelection()" class="text-slate-500 flex flex-col items-center gap-1"><i class="fas fa-comment"></i><span class="text-[9px] font-bold tracking-widest">CHAT</span></button></nav><script>const firebaseConfig={apiKey:"AIzaSyCCi1hrmt4OQFlgrQThbB6-n54v5WwlJoY",authDomain:"completamenteapp.firebaseapp.com",databaseURL:"https://completamenteapp-default-rtdb.firebaseio.com",projectId:"completamenteapp",storageBucket:"completamenteapp.firebasestorage.app",messagingSenderId:"343038230333",appId:"1:343038230333:web:2338b20d2e706743b40f54",measurementId:"G-YTWX2RSV32"};let db=null;try{firebase.initializeApp(firebaseConfig);db=firebase.database();}catch(e){console.warn("DB offline",e);}window.GEMINI_API_KEY="SUA_CHAVE_AQUI";window.VERCEL_PROJECT_URL="https://vercel.com/w15-channels-projects/completamenteapp";window.AI_PROXY_URL="https://completamenteapp.vercel.app/api/ai";window.SHEET_ID="1cus7Hm0a4FSU9SiPAoszA6KlrhWrhKYbQwSd7YPsYeY";window.SHEET_SCRIPT_URL="https://script.google.com/macros/s/AKfycbxPmSrtdjfPuLtZma2hd84WMv42zcZx0IzuVpq3zUUvMtwEDEGD-94CQyibUtOZoWDC/exec";window.clientId="";window.clientName="";window.hasAcceptedTerms=sessionStorage.getItem('wr_terms_accepted')==='true';window.userDataCache={};window.activeTherapist=null;window.isWaiting=false;window.adminTarget=null;window.player=null;window.activeChatRef=null;window.activeAiStatusRef=null;window.isBotPaused=false;
document.addEventListener("DOMContentLoaded",()=>{if(localStorage.getItem('wr_remember')==='true'){const u=localStorage.getItem('wr_user');const p=localStorage.getItem('wr_pass');if(u&&p){document.getElementById('user-name-input').value=u;document.getElementById('user-pass-input').value=p;document.getElementById('remember-me').checked=true;setTimeout(()=>window.login(true),300);}}});
window.setupPresence=function(){if(!db||!window.clientId)return;const userStatusRef=db.ref('/status/'+window.clientId);db.ref('.info/connected').on('value',(s)=>{if(s.val()===false)return;userStatusRef.onDisconnect().set({online:false,last_seen:firebase.database.ServerValue.TIMESTAMP}).then(()=>{userStatusRef.set({online:true,last_seen:firebase.database.ServerValue.TIMESTAMP});});});};
window.getTodayStr=function(){const d=new Date();return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');};
window.showTab=function(id){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.getElementById(id).classList.add('active');if(id!=='chat'&&window.activeChatRef){window.activeChatRef.off();window.activeAiStatusRef.off();window.activeChatRef=null;}if(id==='mural')window.loadMural();if(id==='cycle')window.initCycleTab();if(id==='routines'){if(Notification.permission==='default')Notification.requestPermission();window.renderTasks();}const mainArea=document.getElementById('main-area');const bottomNav=document.getElementById('bottom-nav');if(id==='admin-dashboard'){mainArea.style.maxWidth='100%';bottomNav.style.display='none';}else if(id==='onboarding'||id==='admin-login-screen'){mainArea.style.maxWidth='480px';bottomNav.style.display='none';}else{mainArea.style.maxWidth='480px';bottomNav.style.display='flex';}}
window.login=async function(isAuto){const g=document.getElementById('user-gender').value;const n=document.getElementById('user-name-input').value.trim().toUpperCase();const p=document.getElementById('user-pass-input').value.trim();if(!isAuto&&(!g||n.split(' ').length<2||!/^\d{8}$/.test(p)))return alert("Selecione o G√™nero, digite NOME e SOBRENOME e a Senha (DDMMAAAA).");window.clientId=n.replace(/\s+/g,'_');window.clientName=n.split(' ')[0];if(db){const snap=await db.ref('users/'+window.clientId).once('value');if(!snap.exists()){await db.ref('users/'+window.clientId).set({pass:p,fullName:n,gender:g,created:Date.now()});window.userDataCache={pass:p,fullName:n,gender:g};}else{const u=snap.val();if(u.blocked)return alert("ACESSO BLOQUEADO: Contate a administra√ß√£o.");if(u.pass!==p)return alert("Senha incorreta. Verifique sua data de nascimento.");window.userDataCache=u;if(u.cycle)window.fillCycleForm(u.cycle);if(u.goals){document.getElementById('rt-goal-week').value=u.goals.week||'';document.getElementById('rt-goal-month').value=u.goals.month||'';}}}if(document.getElementById('remember-me').checked){localStorage.setItem('wr_remember','true');localStorage.setItem('wr_user',n);localStorage.setItem('wr_pass',p);}else{localStorage.removeItem('wr_remember');localStorage.removeItem('wr_user');localStorage.removeItem('wr_pass');}document.querySelectorAll('.client-name').forEach(e=>e.innerText=window.clientName);window.setupPresence();window.showTab('home');if(Notification.permission!=='granted')Notification.requestPermission();startReminderLoop();if(window.player){window.player.playVideo();window.player.unMute();window.player.setVolume(30);document.getElementById('music-icon').className="fas fa-volume-up text-sky-400";}}
window.logoutUser=function(){localStorage.removeItem('wr_remember');localStorage.removeItem('wr_user');localStorage.removeItem('wr_pass');window.location.reload();}
window.saveGoals=async function(){const goals={week:document.getElementById('rt-goal-week').value,month:document.getElementById('rt-goal-month').value};window.userDataCache.goals=goals;if(db)await db.ref(`users/${window.clientId}/goals`).set(goals);}
window.openTaskModal=function(){document.getElementById('task-name').value='';document.getElementById('task-time').value='';document.getElementById('task-freq').value='daily';document.getElementById('task-modal').classList.remove('hidden');}
window.closeTaskModal=function(){document.getElementById('task-modal').classList.add('hidden');}
window.saveNewTask=async function(){const name=document.getElementById('task-name').value.trim();const time=document.getElementById('task-time').value;const freq=document.getElementById('task-freq').value;if(!name||!time)return alert("Preencha o Nome e o Hor√°rio da tarefa.");const id="task_"+Date.now();const newTask={name,time,freq,active:true,createdAtStr:window.getTodayStr()};if(!window.userDataCache.tasks)window.userDataCache.tasks={};window.userDataCache.tasks[id]=newTask;if(db)await db.ref(`users/${window.clientId}/tasks/${id}`).set(newTask);window.closeTaskModal();window.renderTasks();if(Notification.permission==='default')Notification.requestPermission();}
window.deleteTask=async function(id){if(!confirm("Excluir esta tarefa definitivamente?"))return;if(window.userDataCache.tasks&&window.userDataCache.tasks[id]){window.userDataCache.tasks[id].active=false;if(db)await db.ref(`users/${window.clientId}/tasks/${id}/active`).set(false);window.renderTasks();}}
window.toggleTask=async function(id,state){const today=window.getTodayStr();if(!window.userDataCache.logs)window.userDataCache.logs={};if(!window.userDataCache.logs[today])window.userDataCache.logs[today]={};if(state)window.userDataCache.logs[today][id]=true;else delete window.userDataCache.logs[today][id];window.renderTasks();if(db)await db.ref(`users/${window.clientId}/logs/${today}`).set(window.userDataCache.logs[today]);}
window.renderTasks=function(){const todoList=document.getElementById('tasks-todo');const doneList=document.getElementById('tasks-done');const areaTodo=document.getElementById('area-todo');const areaDone=document.getElementById('area-done');const msg=document.getElementById('no-tasks-msg');todoList.innerHTML='';doneList.innerHTML='';let tasks=window.userDataCache.tasks||{};let logs=window.userDataCache.logs||{};const today=window.getTodayStr();const todayLogs=logs[today]||{};let total=0;let completed=0;const dayOfWeek=new Date().getDay();for(const[id,t]of Object.entries(tasks)){if(!t.active&&!todayLogs[id])continue;if(t.freq==='weekdays'&&(dayOfWeek===0||dayOfWeek===6)&&!todayLogs[id])continue;if(t.freq==='once'&&t.createdAtStr!==today&&!todayLogs[id])continue;total++;const isDone=!!todayLogs[id];if(isDone)completed++;const card=document.createElement('div');card.className=`flex items-center gap-3 bg-slate-800 p-3 rounded-xl border ${isDone?'border-slate-700':'border-slate-600'} transition-all shadow-sm`;card.innerHTML=`<button onclick="window.toggleTask('${id}', ${!isDone})" class="w-7 h-7 rounded-full border-2 flex items-center justify-center flex-none transition-colors ${isDone?'bg-emerald-500 border-emerald-500 text-white':'border-slate-500 text-transparent'}"><i class="fas fa-check text-xs"></i></button><div class="flex-1 flex flex-col"><span class="text-sm font-bold ${isDone?'line-through text-slate-500':'text-slate-200'}">${t.name}</span><span class="text-[10px] font-bold tracking-widest ${isDone?'text-slate-600':'text-sky-400'}"><i class="far fa-clock"></i> ${t.time} ${t.freq==='once'?'(S√ì HOJE)':''}</span></div><button onclick="window.deleteTask('${id}')" class="text-slate-600 hover:text-red-400 p-2 flex-none"><i class="fas fa-trash-alt"></i></button>`;if(isDone)doneList.appendChild(card);else todoList.appendChild(card);}if(total===0){areaTodo.classList.add('hidden');areaDone.classList.add('hidden');msg.classList.remove('hidden');}else{msg.classList.add('hidden');if(todoList.children.length>0)areaTodo.classList.remove('hidden');else areaTodo.classList.add('hidden');if(doneList.children.length>0)areaDone.classList.remove('hidden');else areaDone.classList.add('hidden');}const pct=total===0?0:Math.round((completed/total)*100);document.getElementById('rt-progress-bar').style.width=pct+'%';document.getElementById('rt-progress-text').innerText=`${pct}% CONCLU√çDO HOJE (${completed}/${total})`;}
window.initCycleTab=function(){const g=window.userDataCache.gender||'M';if(g==='H'){document.getElementById('cycle-woman-view').classList.add('hidden');document.getElementById('cycle-man-view').classList.remove('hidden');}else{document.getElementById('cycle-man-view').classList.add('hidden');document.getElementById('cycle-woman-view').classList.remove('hidden');if(document.getElementById('cy-date').value)window.renderCalendar();}}
window.renderCalendar=function(tgtId='calendar-container',dateVal=null){const dVal=dateVal||document.getElementById('cy-date').value;const c=document.getElementById(tgtId);if(!dVal){c.innerHTML='<div class="text-center text-xs text-slate-500 py-4">Insira a data para gerar o calend√°rio.</div>';return;}const today=new Date();const y=today.getFullYear(),m=today.getMonth();const fDay=new Date(y,m,1).getDay();const dInM=new Date(y,m+1,0).getDate();let md=[],fd=[],pd=[],d=new Date(dVal+'T00:00:00');for(let i=0;i<5;i++){md.push(new Date(d).toLocaleDateString());d.setDate(d.getDate()+1);}d=new Date(dVal+'T00:00:00');d.setDate(d.getDate()+10);for(let i=0;i<6;i++){fd.push(new Date(d).toLocaleDateString());d.setDate(d.getDate()+1);}d=new Date(dVal+'T00:00:00');d.setDate(d.getDate()+21);for(let i=0;i<8;i++){pd.push(new Date(d).toLocaleDateString());d.setDate(d.getDate()+1);}let h='<div class="cal-grid"><div class="cal-header">D</div><div class="cal-header">S</div><div class="cal-header">T</div><div class="cal-header">Q</div><div class="cal-header">Q</div><div class="cal-header">S</div><div class="cal-header">S</div>';for(let i=0;i<fDay;i++)h+='<div></div>';for(let i=1;i<=dInM;i++){let curr=new Date(y,m,i).toLocaleDateString();let dots='';if(md.includes(curr))dots+='<span class="w-1.5 h-1.5 bg-red-500 rounded-full"></span>';if(fd.includes(curr))dots+='<span class="w-1.5 h-1.5 bg-blue-400 rounded-full"></span>';if(pd.includes(curr))dots+='<span class="w-1.5 h-1.5 bg-yellow-400 rounded-full"></span>';let isT=curr===today.toLocaleDateString();h+=`<div class="cal-cell ${isT?'border border-sky-500 font-bold':''}">${i}<div class="dot-container">${dots}</div></div>`;}h+='</div>';c.innerHTML=h;}
window.generateShareCode=async function(){const code=Math.random().toString(36).substring(2,8).toUpperCase();document.getElementById('cy-share-code').value=code;if(!window.userDataCache.cycle)window.userDataCache.cycle={};window.userDataCache.cycle.shareCode=code;if(db)await db.ref('users/'+window.clientId+'/cycle/shareCode').set(code);alert("Novo c√≥digo gerado e salvo com sucesso!");}
window.copyShareCode=function(){const input=document.getElementById('cy-share-code');if(!input.value)return alert("Gere um c√≥digo primeiro.");input.select();document.execCommand("copy");alert("C√≥digo copiado: "+input.value);}
window.saveCycleDate=async function(){const d=document.getElementById('cy-date').value;if(!window.userDataCache.cycle)window.userDataCache.cycle={};window.userDataCache.cycle.date=d;if(db)await db.ref('users/'+window.clientId+'/cycle/date').set(d);alert("Data do ciclo salva!");}
window.saveCycleNote=async function(){const txt=document.getElementById('cy-new-note').value.trim();if(!txt)return;const note={text:txt,timestamp:Date.now(),dateStr:new Date().toLocaleString('pt-BR')};if(!window.userDataCache.cycle)window.userDataCache.cycle={};if(!window.userDataCache.cycle.notesList)window.userDataCache.cycle.notesList=[];window.userDataCache.cycle.notesList.unshift(note);if(db)await db.ref('users/'+window.clientId+'/cycle/notesList').set(window.userDataCache.cycle.notesList);document.getElementById('cy-new-note').value='';window.renderCycleNotes(window.userDataCache.cycle.notesList,'cy-notes-list');}
window.renderCycleNotes=function(notes,eid){const c=document.getElementById(eid);if(!notes||notes.length===0){c.innerHTML='<p class="text-xs text-slate-500 italic text-center mt-4">Nenhum registro no di√°rio ainda.</p>';return;}c.innerHTML=notes.map(n=>`<div class="bg-slate-800 p-3 rounded-lg border border-slate-700 shadow-sm"><div class="text-[9px] text-sky-400 mb-1 font-bold tracking-wider"><i class="far fa-clock"></i> ${n.dateStr||new Date(n.timestamp).toLocaleString('pt-BR')}</div><div class="text-xs text-slate-300 leading-relaxed">${n.text}</div></div>`).join('');}
window.fillCycleForm=function(c){if(c.date)document.getElementById('cy-date').value=c.date;if(c.shareCode)document.getElementById('cy-share-code').value=c.shareCode;if(c.notesList)window.renderCycleNotes(c.notesList,'cy-notes-list');if(c.date&&window.userDataCache.gender!=='H')window.renderCalendar();}
window.loadPartnerCycle=async function(){const code=document.getElementById('partner-code-input').value.trim().toUpperCase();if(!code)return alert("Por favor, digite o c√≥digo da parceira.");const btn=document.querySelector('#cycle-man-view button');const oldHtml=btn.innerHTML;btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Buscando no Servidor...';const res=document.getElementById('partner-cycle-result');res.classList.add('hidden');if(db){const snap=await db.ref('users').once('value');const users=snap.val()||{};let partner=null;for(const[key,u]of Object.entries(users)){if(u.cycle&&u.cycle.shareCode===code){partner=u;break;}}if(partner){document.getElementById('pc-title').innerText="Ciclo de "+partner.fullName.split(' ')[0];window.renderCycleNotes(partner.cycle.notesList||[],'pc-notes-list');window.renderCalendar('pc-calendar',partner.cycle.date);res.classList.remove('hidden');}else{alert("C√≥digo inv√°lido ou parceira n√£o encontrada. Verifique se ela gerou o c√≥digo corretamente.");}}btn.innerHTML=oldHtml;}
let rInterval;function startReminderLoop(){if(rInterval)clearInterval(rInterval);rInterval=setInterval(()=>{if(!window.userDataCache.tasks)return;const now=new Date();const curTime=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;const today=window.getTodayStr();const logs=(window.userDataCache.logs&&window.userDataCache.logs[today])||{};const dayOfWeek=now.getDay();for(const[id,t]of Object.entries(window.userDataCache.tasks)){if(t.active&&t.time===curTime&&!logs[id]){if(t.freq==='weekdays'&&(dayOfWeek===0||dayOfWeek===6))continue;if(t.freq==='once'&&t.createdAtStr!==today)continue;notifyUser("Aten√ß√£o √† Rotina!","Hora de: "+t.name);}}},60000);}
function notifyUser(title,body){if(Notification.permission==="granted"){new Notification(title,{body:body,icon:"https://cdn-icons-png.flaticon.com/512/2965/2965306.png"});}}
window.onYouTubeIframeAPIReady=function(){window.player=new YT.Player('bg-music-player',{height:'0',width:'0',videoId:'Cg0dAc4-UCY',playerVars:{'autoplay':0,'controls':0,'loop':1,'playlist':'Cg0dAc4-UCY'},events:{'onReady':(e)=>e.target.setVolume(30)}});}
window.toggleMusic=function(){if(!window.player)return;const btn=document.getElementById('music-icon');const state=window.player.getPlayerState();if(state===1||state===3){window.player.pauseVideo();btn.className="fas fa-volume-mute text-slate-400";}else{window.player.playVideo();window.player.unMute();window.player.setVolume(30);btn.className="fas fa-volume-up text-sky-400";}}
const therapists=[{id:'lia',name:'Dra. Lia',color:'#ec4899',icon:'heart',schedule:'Seg-Sex (08:00 - 22:00)'},{id:'yara',name:'Dra. Yara',color:'#8b5cf6',icon:'moon',schedule:'Dom-S√°b (22:00 - 08:00)'},{id:'william',name:'William',color:'#0ea5e9',icon:'user-tie',schedule:'Seg-Sex (10-12h / 17-22h)'},{id:'marcos',name:'Dr. Marcos',color:'#10b981',icon:'user-md',schedule:'S√°b (08-12h / 14-22h)'},{id:'juliana',name:'Dra. Juliana',color:'#f59e0b',icon:'star-of-life',schedule:'S√°b 22:00 - Dom 22:00'}];window.checkAvailability=function(id){const d=new Date();const day=d.getDay();const h=d.getHours();const isWeekday=day>=1&&day<=5;let isOnline=false;if(id==='lia'&&isWeekday&&h>=8&&h<22)isOnline=true;else if(id==='yara'&&(h>=22||h<8))isOnline=true;else if(id==='william'&&isWeekday&&((h>=10&&h<12)||(h>=17&&h<22)))return{s:'busy',t:'Ocupado (15 min)',c:'#f59e0b',allow:true};else if(id==='marcos'&&day===6&&((h>=8&&h<12)||(h>=14&&h<22)))isOnline=true;else if(id==='juliana'&&((day===6&&h>=22)||(day===0&&h<22)))isOnline=true;if(isOnline)return{s:'online',t:'Online',c:'#10b981',allow:true};return{s:'offline',t:'Fora do Hor√°rio',c:'#94a3b8',allow:false};}
window.triggerChatSelection=function(){if(!window.hasAcceptedTerms)document.getElementById('consent-modal').classList.remove('hidden');else window.renderTherapistList();}
window.acceptTerms=function(){window.hasAcceptedTerms=true;sessionStorage.setItem('wr_terms_accepted','true');document.getElementById('consent-modal').classList.add('hidden');window.renderTherapistList();}
window.declineTerms=function(){document.getElementById('consent-modal').classList.add('hidden');window.showTab('home');}
window.renderTherapistList=function(){const l=document.getElementById('therapist-list');l.innerHTML='';therapists.forEach(t=>{const st=window.checkAvailability(t.id);const c=document.createElement('div');c.className=`flex items-center gap-4 p-4 rounded-xl border shadow-sm transition-all mb-3 ${st.allow?'bg-slate-800 border-slate-700 cursor-pointer hover:bg-slate-700':'bg-slate-900 border-slate-800 opacity-60 cursor-not-allowed'}`;c.onclick=()=>{if(st.allow)window.startChat(t.id);else alert(`${t.name} atende no hor√°rio: ${t.schedule}`);};c.innerHTML=`<div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold" style="background-color:${st.allow?t.color:'#475569'}"><i class="fas fa-${t.icon}"></i></div><div class="flex-1"><span class="font-bold text-sm ${st.allow?'text-slate-200':'text-slate-500'}">${t.name}</span><p class="text-[9px] text-slate-500">${t.schedule}</p><div class="flex items-center mt-1"><span class="status-dot" style="background:${st.c};box-shadow:0 0 5px ${st.c}"></span><span class="text-[8px] uppercase font-bold text-slate-400">${st.t}</span></div></div>`;l.appendChild(c);});window.showTab('chat-selection');}
window.getSystemPrompt=function(id){
const base="REGRA ABSOLUTA: Voc√™ √© humano. NUNCA diga ser IA. Atende pessoas em fragilidade. Chame pelo primeiro nome. Aja de forma natural, emp√°tica e conversacional.";
const p={'lia':`${base} Dra. Lia, terapeuta 45 anos. Acolhedora. Responda at√© 500 caracteres.`,'yara':`${base} Dra. Yara, terapeuta da madrugada. Tom protetor.`,'marcos':`${base} Dr. Marcos, terapeuta anal√≠tico.`,'juliana':`${base} Dra. Juliana, foco em regula√ß√£o emocional.`};
let prompt=p[id]||base;
const u=window.userDataCache;
if(u){
prompt+=`\n\n[CONTEXTO DO PACIENTE]:\nNome: ${u.fullName}.\nG√™nero: ${u.gender==='M'?'Mulher':'Homem'}. `;
if(u.goals){prompt+=`\nMetas do paciente - Semana: ${u.goals.week||'-'}, M√™s: ${u.goals.month||'-'}. `;}
if(u.tasks){
const tNames=Object.values(u.tasks).filter(x=>x.active).map(x=>x.name).join(', ');
if(tNames)prompt+=`\nRotina di√°ria: ${tNames}. `;}
if(u.cycle&&u.cycle.notesList&&u.cycle.notesList.length>0){prompt+=`\n√öltimo registro no di√°rio de sentimentos: "${u.cycle.notesList[0].text}". `;}
try{
const mLocal=JSON.parse(localStorage.getItem('mural_local')||'[]');
if(mLocal.length>0){prompt+=`\n√öltimo desabafo no mural: "${mLocal[0].t}". `;}
}catch(e){}
prompt+=`\n\nUSE ESTAS INFORMA√á√ïES DE FORMA SUTIL PARA DEMONSTRAR EMPATIA. Nunca diga 'li no seu mural' ou 'vi na sua rotina', aja como se lembrasse organicamente, como um terapeuta humano faria.`
}
return prompt;
}
window.getLocalHistory=function(id){return JSON.parse(localStorage.getItem(`chat_${window.clientId}_${id}`))||[];}
window.startChat=async function(id){const st=window.checkAvailability(id);if(!st.allow)return;window.activeTherapist=therapists.find(t=>t.id===id);document.getElementById('active-name').innerText=window.activeTherapist.name;document.getElementById('active-avatar').style.backgroundColor=window.activeTherapist.color;document.getElementById('active-avatar').innerHTML=`<i class="fas fa-${window.activeTherapist.icon}"></i>`;document.getElementById('active-status-dot').style.background=st.c;document.getElementById('active-status-text').innerText=st.t;const input=document.getElementById('chat-input');const submitBtn=document.getElementById('submit-btn');const waBtn=document.getElementById('wa-btn');const micBtn=document.getElementById('mic-btn');if(id==='william'){input.disabled=true;input.placeholder="Atendimento restrito. Clique no WhatsApp ->";submitBtn.classList.add('hidden');micBtn.classList.add('hidden');waBtn.classList.remove('hidden');document.getElementById('chat-messages').innerHTML=`<div class="message system-note mb-2">Dr. William est√° em atendimento.<br>Espera: 15 min.<br>Clique no √≠cone do WhatsApp para falar com a recep√ß√£o.</div>`;window.showTab('chat');return;}else{input.disabled=false;input.placeholder="Digite aqui...";submitBtn.classList.remove('hidden');micBtn.classList.remove('hidden');waBtn.classList.add('hidden');}const chatId=`${window.clientId}_${id}`;if(!db){let h=window.getLocalHistory(id);if(h.length===0){h.push({role:"system",content:`${window.getSystemPrompt(id)} Paciente: ${window.clientName}.`});localStorage.setItem(`chat_${chatId}`,JSON.stringify(h));}window.refreshChatDisplay(h);}else{window.activeChatRef=db.ref(`chats/${chatId}`);window.activeAiStatusRef=db.ref(`ai_status/${chatId}`);window.activeAiStatusRef.on('value',snap=>{const status=snap.val();window.isBotPaused=status?status.paused:false;});window.activeChatRef.on('value',(snapshot)=>{let h=snapshot.val();if(!h){h=[{role:"system",content:`${window.getSystemPrompt(id)} Paciente: ${window.clientName}.`}];window.activeChatRef.set(h);}localStorage.setItem(`chat_${chatId}`,JSON.stringify(h));window.refreshChatDisplay(h);if(window.isWaiting){const lastMsg=h[h.length-1];if(lastMsg.role==='assistant'){document.getElementById('typing-box').classList.add('hidden');window.isWaiting=false;document.getElementById('submit-btn').disabled=false;document.getElementById('mic-btn').disabled=false;}}});}window.showTab('chat');}
window.refreshChatDisplay=function(h){const mc=document.getElementById('chat-messages');mc.innerHTML='';h.forEach(m=>{if(m.role!=='system'){const uiContent=(m.isAudio)?`<div class="flex items-center gap-2"><i class="fas fa-microphone"></i> Arquivo de √°udio</div>`:m.content;window.renderMessage(uiContent,m.role==='user'?'user':'therapist');}});mc.scrollTop=mc.scrollHeight;}
window.renderMessage=function(t,type){const d=document.createElement('div');d.className=`message ${type}`;d.innerHTML=t;document.getElementById('chat-messages').appendChild(d);}
window.sendToWhatsapp=function(){window.open(`https://wa.me/5541992531598?text=${encodeURIComponent(`Ol√°, sou ${window.clientName}. Gostaria de agendar com o William.`)}`,'_blank');}
window.submitChat=async function(t,isAudio=false){
if(!t||window.isWaiting)return;
const chatId=`${window.clientId}_${window.activeTherapist.id}`;
const chatInput=document.getElementById('chat-input');
if(chatInput)chatInput.value='';
window.isWaiting=true;
document.getElementById('submit-btn').disabled=true;
document.getElementById('mic-btn').disabled=true;
let h=[];
if(db){
const snap=await db.ref(`chats/${chatId}`).once('value');
h=snap.val()||[];
h.push({role:'user',content:t,isAudio:isAudio});
await db.ref(`chats/${chatId}`).set(h);
}else{
h=window.getLocalHistory(window.activeTherapist.id);
h.push({role:'user',content:t,isAudio:isAudio});
localStorage.setItem(`chat_${chatId}`,JSON.stringify(h));
window.refreshChatDisplay(h);
}
const typingBox=document.getElementById('typing-box');
if(window.isBotPaused){
typingBox.classList.remove('hidden');
typingBox.innerHTML='<i class="fas fa-user-md mr-1"></i> O Terapeuta est√° acompanhando...';
return;
}
const start=Date.now();
try{
const cleanH=h.map(m=>({role:m.role,content:m.content}));
const res=await fetch(window.AI_PROXY_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:cleanH,temperature:0.7,max_tokens:350})});
if(!res.ok)throw new Error();
const data=await res.json();
const rt=data.choices&&data.choices[0]?data.choices[0].message.content:"Desculpe, a conex√£o oscilou. Pode repetir?";
const apiTime=Date.now()-start;

// 1. Pausa de expectativa (10 segundos totais)
let readDelay=10000-apiTime;
if(readDelay<0)readDelay=0;

// 2. Tempo de escrita realista (130 palavras por min -> aprox 461ms por palavra)
const botWords=Math.max(rt.split(/\s+/).length,1);
let typeDelay=Math.round(botWords*(60000/130));
if(typeDelay>15000)typeDelay=15000;
if(typeDelay<2000)typeDelay=2000;

setTimeout(()=>{
if(window.isBotPaused){typingBox.innerHTML='<i class="fas fa-user-md mr-1"></i> O Terapeuta assumiu...';return;}
typingBox.innerHTML='Digitando <span class="animate-pulse">...</span>';
typingBox.classList.remove('hidden');

setTimeout(async()=>{
if(window.isBotPaused){typingBox.innerHTML='<i class="fas fa-user-md mr-1"></i> O Terapeuta assumiu...';return;}
h.push({role:'assistant',content:rt});
if(db){
await db.ref(`chats/${chatId}`).set(h);
}else{
localStorage.setItem(`chat_${chatId}`,JSON.stringify(h));
window.refreshChatDisplay(h);
typingBox.classList.add('hidden');
window.isWaiting=false;
document.getElementById('submit-btn').disabled=false;
document.getElementById('mic-btn').disabled=false;
}
},typeDelay);
},readDelay);

}catch(err){
typingBox.classList.add('hidden');
window.renderMessage("Nossos sistemas ca√≠ram, aguarde um instante.",'therapist');
window.isWaiting=false;
document.getElementById('submit-btn').disabled=false;
document.getElementById('mic-btn').disabled=false;
}
};
document.getElementById('chat-form').onsubmit=(e)=>{e.preventDefault();window.submitChat(document.getElementById('chat-input').value.trim(),false);};
window.startVoice=function(){if(window.isWaiting)return;const SR=window.SpeechRecognition||window.webkitSpeechRecognition;if(!SR)return alert("Seu navegador n√£o suporta microfone.");const rec=new SR();rec.lang='pt-BR';const btn=document.getElementById('mic-btn');rec.onstart=()=>{btn.classList.replace('bg-slate-600','bg-red-500');btn.classList.add('animate-pulse');};rec.onend=()=>{btn.classList.replace('bg-red-500','bg-slate-600');btn.classList.remove('animate-pulse');};rec.onresult=(e)=>{const txt=e.results[0][0].transcript;if(txt)window.submitChat(txt,true);};rec.start();};
window.gerarCaixinha=async function(){const mb=document.getElementById("msgBox");const imgBox=document.getElementById("imgBox");const btn=document.getElementById("caixinha-btn");const resBox=document.getElementById("resultadoBox");resBox.classList.remove("hidden");mb.innerText="Sintonizando energia e luz...";imgBox.src="";btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Gerando...';const temas=["conforto","motiva√ß√£o","√¢nimo","esperan√ßa"];const tema=temas[Math.floor(Math.random()*temas.length)];try{const c=`Escreva uma reflex√£o po√©tica curta sobre ${tema}. Retorne APENAS um JSON: {"frase": "mensagem aqui", "prompt_imagem": "descri√ß√£o em ingles de fundo abstrato"}`;const textRes=await fetch(window.AI_PROXY_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"groq",messages:[{role:"system",content:c}],temperature:0.9,max_tokens:400})});const data=await textRes.json();let rawText=data.choices?data.choices[0].message.content:'{"frase": "A paz come√ßa de dentro.", "prompt_imagem": "calm sunset landscape"}';let cleanText=rawText.substring(rawText.indexOf('{'),rawText.lastIndexOf('}')+1);let content;try{content=JSON.parse(cleanText);}catch(e){content={frase:"Abrace a sua jornada.",prompt_imagem:"beautiful nature minimal"};}mb.innerText=`"${content.frase}"`;if(window.GEMINI_API_KEY&&window.GEMINI_API_KEY!=="SUA_CHAVE_AQUI"){const imgRes=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${window.GEMINI_API_KEY}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({instances:{prompt:content.prompt_imagem+", cinematic, high resolution, no text"},parameters:{sampleCount:1}})});const imgData=await imgRes.json();if(imgData.predictions&&imgData.predictions[0]){imgBox.src=`data:image/jpeg;base64,${imgData.predictions[0].bytesBase64Encoded}`;}else{throw new Error("Erro Imagen");}}else{throw new Error("Sem Chave API");}}catch(e){const kw=['nature','calm','water','sunset'];imgBox.src=`https://source.unsplash.com/random/600x600/?${kw[Math.floor(Math.random()*kw.length)]}`;imgBox.onerror=()=>imgBox.src='https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=600&h=600&fit=crop';}finally{btn.disabled=false;btn.innerHTML='<i class="fas fa-magic mr-2"></i>Gerar Nova Mensagem';}}
window.downloadMsg=async function(e){const btn=e.currentTarget;const old=btn.innerHTML;btn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i>Salvando...';try{const canvas=await html2canvas(document.getElementById('capture_area'),{scale:2,useCORS:true,allowTaint:true});const link=document.createElement('a');link.download='WR-Mensagem.png';link.href=canvas.toDataURL('image/png');link.click();}catch(err){alert("Erro ao salvar imagem.");}finally{btn.innerHTML=old;}}
window.gerarLeitura=async function(){const tema=document.getElementById('book-theme').value;const container=document.getElementById('book-container');const loading=document.getElementById('book-loading');const titleEl=document.getElementById('book-title');const contentEl=document.getElementById('book-content');container.classList.add('hidden');loading.classList.remove('hidden');const prompt=`Escreva um cap√≠tulo curto de um livro sobre "${tema}". Use tags HTML <p>. Comece com T√≠tulo Criativo.`;try{const res=await fetch(window.AI_PROXY_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:[{role:"system",content:prompt}],temperature:0.8,max_tokens:800})});const data=await res.json();const fullText=data.choices?data.choices[0].message.content:"<p>Erro.</p>";let cleanText=fullText.replace(/```html/g,'').replace(/```/g,'');let lines=cleanText.split('\n');let title=lines[0].replace(/<[^>]*>/g,'');let body=cleanText;if(title.length<100){titleEl.innerText=title;body=lines.slice(1).join('\n');}else{titleEl.innerText=tema;}contentEl.innerHTML=body;loading.classList.add('hidden');container.classList.remove('hidden');}catch(e){loading.classList.add('hidden');alert("Erro na biblioteca.");}}
window.saveMuralMessage=async function(){const input=document.getElementById('mural-input');const text=input.value.trim();if(!text)return;const localMsgs=JSON.parse(localStorage.getItem('mural_local')||'[]');localMsgs.unshift({d:new Date().toLocaleDateString('pt-BR'),t:text,local:true});localStorage.setItem('mural_local',JSON.stringify(localMsgs));if(window.SHEET_SCRIPT_URL){const btn=input.nextElementSibling;const oldHtml=btn.innerHTML;btn.innerHTML='<i class="fas fa-spinner fa-spin"></i>';btn.disabled=true;try{await fetch(window.SHEET_SCRIPT_URL,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify({t:text})});alert("Mensagem enviada!");}catch(e){alert("Salvo localmente.");}finally{btn.innerHTML=oldHtml;btn.disabled=false;}}input.value='';window.loadMural();}
window.loadMural=async function(){const list=document.getElementById('mural-list');list.innerHTML='<div class="text-center text-slate-500 text-xs"><i class="fas fa-spinner fa-spin mr-2"></i>Carregando mensagens...</div>';let allMsgs=[...JSON.parse(localStorage.getItem('mural_local')||'[]')];try{const res=await fetch(`https://docs.google.com/spreadsheets/d/${window.SHEET_ID}/gviz/tq?tqx=out:json`);const txt=await res.text();const json=JSON.parse(txt.substring(txt.indexOf("{"),txt.lastIndexOf("}")+1));if(json.table&&json.table.rows){json.table.rows.forEach(row=>{const dateVal=row.c[0]?(row.c[0].f||row.c[0].v):'Global';const msgVal=row.c[1]?(row.c[1].v):null;if(msgVal)allMsgs.push({d:dateVal,t:msgVal,sheet:true});});}}catch(e){}if(allMsgs.length===0){list.innerHTML='<div class="text-center text-slate-500 text-xs mt-4">Nenhuma mensagem ainda.</div>';return;}list.innerHTML=allMsgs.map(i=>`<div class="mural-card bg-slate-800 border-l-4 ${i.local?'border-sky-500':'border-emerald-500'} p-3 rounded mb-3 shadow animate-fade-in"><div class="flex justify-between items-center mb-1"><span class="font-bold ${i.local?'text-sky-500':'text-emerald-500'} text-xs uppercase">${i.local?'Voc√™':'Mural'}</span><span class="text-[10px] text-slate-500">${i.d}</span></div><p class="text-slate-300 text-sm break-words">${i.t}</p></div>`).join('');}
window.cgi=0;window.startDescompressao=function(){window.showTab('game-section');window.cgi=0;window.loadGame(0)}
window.nextGame=function(){window.cgi++;if(window.cgi<13)window.loadGame(window.cgi);else window.finishDescompressao()}
window.loadGame=function(i){document.getElementById('game-level-display').innerText=`N√≠vel ${i+1}/13`;document.getElementById('next-game-btn').classList.add('hidden');const c=document.getElementById('game-container');c.innerHTML='';if(i===0)window.initBreathing(c);else if(i===1)window.initMemoryGame(c);else if(i===2)window.initIntruderGame(c);else if(i===3)window.initSlidingPuzzle(c);else if(i===4)window.initMathGame(c);else if(i===5)window.initColorGame(c);else if(i===6)window.initSequenceGame(c);else if(i===7)window.initWordScramble(c);else if(i===8)window.initReflex(c);else if(i===9)window.initLetterHunt(c);else if(i===10)window.initBubblePop(c);else if(i===11)window.initStarCount(c);else if(i===12)window.initEmojiMatch(c);}
window.gameWin=function(){const c=document.getElementById('game-container');c.style.boxShadow="0 0 50px #10b981";setTimeout(()=>{c.style.boxShadow="none"},500);document.getElementById('next-game-btn').classList.remove('hidden')}
window.finishDescompressao=function(){document.getElementById('game-container').innerHTML=`<div class="text-center animate-bounce"><i class="fas fa-trophy text-6xl text-yellow-400 mb-4"></i><h2 class="text-2xl font-bold text-white">Parab√©ns!</h2><p class="text-slate-300 mb-4">Mente leve.</p><button onclick="window.startDescompressao()" class="mt-6 bg-sky-600 px-6 py-2 rounded-xl text-white">Brincar Novamente</button></div>`;document.getElementById('next-game-btn').classList.add('hidden')}
window.initBreathing=function(c){c.innerHTML=`<div class="text-center text-white"><p id="br-text" class="text-xl font-bold mb-8 h-8">Preparado?</p><div id="br-circle" class="w-20 h-20 bg-sky-400 rounded-full mx-auto mt-8 transition-all ease-in-out duration-[4000ms]" style="transform:scale(1)"></div></div>`;const text=document.getElementById('br-text');const circle=document.getElementById('br-circle');let cycles=0;const cycle=()=>{if(cycles>=3){window.gameWin();return;}text.innerText="Inspire...";circle.style.backgroundColor="#3b82f6";circle.style.transform="scale(2.5)";setTimeout(()=>{text.innerText="Segure a respira√ß√£o...";circle.style.backgroundColor="#ef4444";setTimeout(()=>{text.innerText="Expire...";circle.style.backgroundColor="#10b981";circle.style.transform="scale(1)";setTimeout(()=>{cycles++;cycle();},4000);},4000);},4000);};setTimeout(cycle,1000);}
window.initMemoryGame=function(c){c.innerHTML='<div id="memory-grid" class="memory-grid w-full"></div>';const g=document.getElementById('memory-grid');const i=['leaf','cloud','dove','heart','star','tree'];let d=[...i,...i].sort(()=>Math.random()-.5);let f=[],m=0;d.forEach(ic=>{const e=document.createElement('div');e.className='memory-card';e.innerHTML=`<i class="fas fa-${ic}"></i>`;e.onclick=function(){if(this.className.includes('flipped')||f.length>=2)return;this.classList.add('flipped');f.push(this);if(f.length===2){if(f[0].innerHTML===f[1].innerHTML){f.forEach(x=>x.classList.add('matched'));m++;f=[];if(m===6)window.gameWin()}else{setTimeout(()=>{f.forEach(x=>x.classList.remove('flipped'));f=[]},800)}}};g.appendChild(e)})}
window.initIntruderGame=function(c){c.innerHTML=`<div class="text-center mb-4 text-white">Encontre o diferente!</div><div class="grid grid-cols-5 gap-2" id="ig"></div>`;const g=document.getElementById('ig');const p=[{m:"üòê",i:"üòë"},{m:"üåë",i:"üåí"}];const pr=p[Math.floor(Math.random()*p.length)];const ps=Math.floor(Math.random()*25);for(let i=0;i<25;i++){const b=document.createElement('button');b.className="text-2xl p-2 bg-slate-700 rounded";b.innerText=(i===ps)?pr.i:pr.m;b.onclick=()=>{if(i===ps){b.style.background="#10b981";window.gameWin()}else{b.style.background="#ef4444"}};g.appendChild(b)}}
window.initSlidingPuzzle=function(c){c.innerHTML='<div class="text-center mb-4 text-white">Ordene 1-8</div><div class="puzzle-grid" id="pg"></div>';const g=document.getElementById('pg');let t=[1,2,3,4,5,6,7,8,null];for(let i=0;i<50;i++){const e=t.indexOf(null);const n=[];if(e%3>0)n.push(e-1);if(e%3<2)n.push(e+1);if(e>=3)n.push(e-3);if(e<6)n.push(e+3);const s=n[Math.floor(Math.random()*n.length)];[t[e],t[s]]=[t[s],t[e]]}const r=()=>{g.innerHTML='';t.forEach((v,i)=>{const d=document.createElement('div');d.className=`puzzle-tile ${v===null?'empty':''}`;if(v)d.innerText=v;d.onclick=()=>{const e=t.indexOf(null);const df=Math.abs(i-e);if(df===3||(df===1&&Math.floor(i/3)===Math.floor(e/3))){[t[i],t[e]]=[t[e],t[i]];r();if(JSON.stringify(t)==='[1,2,3,4,5,6,7,8,null]')window.gameWin()}};g.appendChild(d)})};r()}
window.initMathGame=function(c){const n1=Math.floor(Math.random()*20)+10,n2=Math.floor(Math.random()*10)+5,r=n1+n2;const w=[r+2,r-3,r+5].sort(()=>Math.random()-.5);const o=[...w.slice(0,2),r].sort(()=>Math.random()-.5);c.innerHTML=`<div class="text-center text-white"><h3 class="text-4xl font-bold mb-8">${n1} + ${n2} = ?</h3><div class="flex flex-col gap-3 max-w-xs mx-auto">${o.map(v=>`<button onclick="if(${v}===${r}){this.style.bg='#10b981';window.gameWin()}else{this.style.bg='#ef4444'}" class="btn-game bg-slate-700">${v}</button>`).join('')}</div></div>`}
window.initColorGame=function(c){const l=[{n:"VERMELHO",h:"#ef4444"},{n:"AZUL",h:"#3b82f6"},{n:"VERDE",h:"#10b981"}];const t=Math.floor(Math.random()*3);let cl=Math.floor(Math.random()*3);while(cl===t)cl=Math.floor(Math.random()*3);c.innerHTML=`<div class="text-center text-white"><p>Qual a <b>COR</b>?</p><h3 class="text-5xl font-bold mb-8" style="color:${l[cl].h}">${l[t].n}</h3><div class="grid grid-cols-2 gap-3">${l.map(x=>`<button onclick="if('${x.n}'==='${l[cl].n}'){this.style.bg='#10b981';window.gameWin()}else{this.style.bg='#ef4444'}" class="btn-game bg-slate-700 border-2" style="border-color:${x.h}">${x.n}</button>`).join('')}</div></div>`}
window.initSequenceGame=function(c){let s=[];for(let i=0;i<4;i++)s.push(Math.floor(Math.random()*9)+1);c.innerHTML=`<div class="text-center text-white"><p>Memorize:</p><div id="sd" class="text-4xl font-bold h-12 mb-8">${s.join(' ')}</div><div id="si" class="hidden grid grid-cols-3 gap-2 max-w-xs mx-auto">${[1,2,3,4,5,6,7,8,9].map(n=>`<button onclick="window.uSeq.push(${n});document.getElementById('us').innerText=window.uSeq.join(' ')" class="p-4 bg-slate-700 rounded font-bold">${n}</button>`).join('')}</div><div id="us" class="h-8 text-xl mt-4"></div><button onclick="if(JSON.stringify(window.uSeq)===JSON.stringify(window.tSeq))window.gameWin();else{window.uSeq=[];document.getElementById('us').innerText='Erro'}" id="bc" class="hidden w-full mt-4 bg-sky-600 py-2 rounded">Verificar</button></div>`;setTimeout(()=>{document.getElementById('sd').innerText="????";document.getElementById('si').classList.remove('hidden');document.getElementById('bc').classList.remove('hidden');window.tSeq=s;window.uSeq=[]},3000)}
window.initWordScramble=function(c){const words=["CALMA","VIDA","PAZ","LUZ","AMOR"];const w=words[Math.floor(Math.random()*words.length)];const s=w.split('').sort(()=>Math.random()-.5).join('');c.innerHTML=`<div class="text-center text-white"><p>Desembaralhe:</p><h3 class="text-4xl font-bold mb-4 tracking-widest">${s}</h3><input id="ws-inp" class="p-2 rounded text-black text-center uppercase" maxlength="${w.length}"><button onclick="if(document.getElementById('ws-inp').value.toUpperCase()==='${w}'){window.gameWin()}" class="mt-4 bg-sky-600 px-4 py-2 rounded w-full">Verificar</button></div>`}
window.initReflex=function(c){c.innerHTML=`<div class="text-center text-white"><p>Clique quando ficar VERDE!</p><div id="rx-box" class="w-32 h-32 bg-red-500 rounded-full mx-auto mt-8 transition-colors cursor-pointer"></div></div>`;const b=document.getElementById('rx-box');let active=false;setTimeout(()=>{b.style.backgroundColor="#10b981";active=true;b.onclick=()=>{if(active)window.gameWin()}},Math.random()*2000+1000)}
window.initLetterHunt=function(c){c.innerHTML=`<div class="text-center text-white mb-2">Ache a letra 'Q'</div><div class="grid grid-cols-6 gap-2" id="lh"></div>`;const g=document.getElementById('lh');const pos=Math.floor(Math.random()*36);for(let i=0;i<36;i++){const b=document.createElement('button');b.innerText=(i===pos)?'Q':'O';b.className="p-2 bg-slate-700 rounded text-xl";b.onclick=()=>{if(i===pos){b.style.bg="#10b981";window.gameWin()}else b.style.bg="#ef4444"};g.appendChild(b)}}
window.initBubblePop=function(c){c.innerHTML=`<div class="text-center text-white"><p class="mb-4">Estoure 5 bolhas azuis!</p><div id="bubble-area" class="relative w-64 h-64 bg-slate-800 rounded mx-auto overflow-hidden"></div></div>`;const area=document.getElementById('bubble-area');let popped=0;for(let i=0;i<10;i++){const b=document.createElement('div');b.className="absolute rounded-full bg-sky-400 cursor-pointer shadow-[0_0_10px_#38bdf8]";b.style.width=b.style.height=(Math.random()*30+20)+'px';b.style.left=Math.random()*80+'%';b.style.top=Math.random()*80+'%';b.onclick=(e)=>{e.target.remove();popped++;if(popped>=5)window.gameWin();};area.appendChild(b);}}
window.initStarCount=function(c){c.innerHTML=`<div class="text-center text-white"><p class="mb-4">Encontre 4 estrelas m√°gicas</p><div id="star-area" class="grid grid-cols-4 gap-4 w-64 mx-auto"></div></div>`;const area=document.getElementById('star-area');const items=['moon','cloud','sun','snowflake','bolt'];let arr=['star','star','star','star'];while(arr.length<16)arr.push(items[Math.floor(Math.random()*items.length)]);arr.sort(()=>Math.random()-0.5);let starsFound=0;arr.forEach(item=>{const b=document.createElement('button');b.className="text-2xl p-2 bg-slate-700 rounded transition-colors";b.innerHTML=`<i class="fas fa-${item}"></i>`;b.onclick=()=>{if(item==='star'){b.style.backgroundColor='#10b981';b.style.color='white';b.disabled=true;starsFound++;if(starsFound===4)window.gameWin();}else{b.style.backgroundColor='#ef4444';setTimeout(()=>b.style.backgroundColor='#334155',500);}};area.appendChild(b);});}
window.initEmojiMatch=function(c){const emotions=[{w:'Alegria',e:'üòÑ'},{w:'Tristeza',e:'üò¢'},{w:'Raiva',e:'üò°'},{w:'Amor',e:'‚ù§Ô∏è'}];const target=emotions[Math.floor(Math.random()*emotions.length)];c.innerHTML=`<div class="text-center text-white"><p class="mb-4">Clique no emoji que representa: <br><b class="text-sky-400 text-2xl">${target.w}</b></p><div id="emoji-area" class="flex gap-4 justify-center text-4xl mt-4"></div></div>`;const area=document.getElementById('emoji-area');let shuffled=[...emotions].sort(()=>Math.random()-0.5);shuffled.forEach(emo=>{const b=document.createElement('button');b.className="bg-slate-700 p-4 rounded hover:bg-slate-600";b.innerText=emo.e;b.onclick=()=>{if(emo.w===target.w){b.style.backgroundColor='#10b981';window.gameWin();}else{b.style.backgroundColor='#ef4444';}};area.appendChild(b);});}
window.adminStatusRef=null;window.adminChatsRef=null;window.globalUsersStatus={};window.showAdminLogin=function(){window.showTab('admin-login-screen')}
window.attemptAdminLogin=async function(){const u=document.getElementById('admin-user').value.trim();const p=document.getElementById('admin-pass').value.trim();if(!db)return alert("BD Offline.");const snap=await db.ref('admin_auth').once('value');if(!snap.exists()){await db.ref('admin_auth').set({user:u,pass:p});alert("Admin Registrado! Guarde seu acesso.");window.initAdminPanel();}else{const val=snap.val();if(val.user===u&&val.pass===p)window.initAdminPanel();else alert("Credenciais Incorretas");}}
window.initAdminPanel=function(){window.showTab('admin-dashboard');if(!window.adminStatusRef){window.adminStatusRef=db.ref('status');window.adminStatusRef.on('value',s=>{window.globalUsersStatus=s.val()||{};if(window.lastAllChats)window.renderAdminDashboard(window.lastAllChats);});}if(!window.adminChatsRef){window.adminChatsRef=db.ref('chats');window.adminChatsRef.on('value',s=>{const allChats=s.val()||{};window.lastAllChats=allChats;window.renderAdminDashboard(allChats);if(window.adminTarget){const tk=`${window.adminTarget.clientId}_${window.adminTarget.therapistId}`;if(allChats[tk])window.refreshAdminChatBox(allChats[tk]);}});}}
window.logoutAdmin=function(){window.showTab('home');}
window.renderAdminDashboard=function(allChats){const l=document.getElementById('admin-chat-list');l.innerHTML='';let arr=[];for(const[k,h]of Object.entries(allChats)){if(h&&h.length>0){const parts=k.split('_');const clientId=`${parts[0]}_${parts[1]}`;const isOnline=window.globalUsersStatus[clientId]?window.globalUsersStatus[clientId].online:false;arr.push({k,clientId,therapistId:parts[2]||parts[1],h,isOnline});}}arr.sort((a,b)=>{if(a.isOnline===b.isOnline)return b.h.length-a.h.length;return a.isOnline?-1:1;});arr.forEach(c=>{const last=c.h.slice().reverse().find(m=>m.role!=='system');const d=document.createElement('div');d.className=`p-3 bg-slate-800 rounded border ${c.isOnline?'border-emerald-500/50':'border-slate-700'} cursor-pointer hover:bg-slate-700`;d.onclick=()=>window.openAdminChat(c.clientId,c.therapistId,c.h);d.innerHTML=`<div class="flex justify-between items-center"><span class="font-bold text-[11px] text-white"><span class="w-2 h-2 rounded-full ${c.isOnline?'bg-emerald-500 animate-pulse':'bg-slate-600'} inline-block mr-1"></span>${c.clientId.replace('_',' ')}</span><span class="text-[9px] text-slate-400">${c.therapistId}</span></div><p class="text-[10px] text-slate-400 mt-1 truncate">${last?last.content:'-'}</p>`;l.appendChild(d);});}
window.openAdminChat=async function(clientId,therapistId,h){window.adminTarget={clientId,therapistId};document.getElementById('admin-target-name').innerText=`${clientId.replace('_',' ')} c/ ${therapistId}`;document.getElementById('ai-toggle-btn').classList.remove('hidden');db.ref(`ai_status/${clientId}_${therapistId}`).on('value',s=>{const p=s.val()?s.val().paused:false;const b=document.getElementById('ai-toggle-btn');b.innerText=p?"IA: PAUSADA":"IA: ATIVA";b.className=`text-[9px] px-2 py-1 rounded font-bold ${p?'bg-red-600 animate-pulse':'bg-emerald-600'}`;});window.refreshAdminChatBox(h);const snap=await db.ref('users/'+clientId).once('value');const u=snap.val();if(u){let htmlData=`<div class="mb-4"><b class="text-emerald-400"><i class="fas fa-id-card"></i> CADASTRO</b><br>Nome: ${u.fullName}<br>G√™nero: ${u.gender==='M'?'Mulher':'Homem'}<br>Senha: ${u.pass}</div>`;if(u.goals){htmlData+=`<div class="mb-4"><b class="text-amber-400"><i class="fas fa-bullseye"></i> METAS</b><br>Semana: ${u.goals.week||'-'}<br>M√™s: ${u.goals.month||'-'}</div>`;}if(u.tasks){let ativos=Object.values(u.tasks).filter(x=>x.active).length;htmlData+=`<div class="mb-4"><b class="text-sky-400"><i class="fas fa-clipboard-check"></i> ROTINA (TAREFAS)</b><br>Ativas: ${ativos} tarefa(s) criadas pelo paciente.</div>`;}if(u.cycle){let np='Nenhuma';if(u.cycle.notesList&&u.cycle.notesList.length>0)np=u.cycle.notesList.length+' registro(s)';htmlData+=`<div class="mb-4"><b class="text-rose-400"><i class="fas fa-book"></i> CICLO</b><br>√öltima: ${u.cycle.date||'-'}<br>C√≥d Parceria: ${u.cycle.shareCode||'-'}<br>Di√°rio: ${np}</div>`;}document.getElementById('admin-user-info').innerHTML=htmlData;document.getElementById('admin-actions').classList.remove('hidden');}else{document.getElementById('admin-user-info').innerHTML='Dados de perfil n√£o encontrados.';document.getElementById('admin-actions').classList.add('hidden');}}
window.refreshAdminChatBox=function(h){if(!window.adminTarget||!h)return;const p=document.getElementById('admin-chat-preview');p.innerHTML=h.filter(m=>m.role!=='system').map(m=>`<div class="mb-2"><b class="${m.role==='user'?'text-sky-400':'text-emerald-400'}">${m.role==='user'?'Paciente':'Terapeuta/IA'}:</b> ${m.content}</div>`).join('');p.scrollTop=p.scrollHeight;}
window.toggleAiStatus=function(){const tk=`${window.adminTarget.clientId}_${window.adminTarget.therapistId}`;db.ref(`ai_status/${tk}`).once('value').then(s=>{db.ref(`ai_status/${tk}`).set({paused:!(s.val()&&s.val().paused)});});}
window.sendAdminReply=async function(){const i=document.getElementById('admin-reply-input');const txt=i.value.trim();if(!txt||!window.adminTarget)return;const tk=`${window.adminTarget.clientId}_${window.adminTarget.therapistId}`;i.value='Enviando...';const snap=await db.ref(`chats/${tk}`).once('value');let h=snap.val()||[];h.push({role:'assistant',content:txt});await db.ref(`chats/${tk}`).set(h);await db.ref(`ai_status/${tk}`).set({paused:true});i.value='';}
window.adminBlockUser=async function(){if(!window.adminTarget)return;if(confirm("Deseja bloquear o acesso deste paciente?")){await db.ref('users/'+window.adminTarget.clientId+'/blocked').set(true);alert("Paciente bloqueado.");}}
window.adminDeleteUser=async function(){if(!window.adminTarget)return;if(confirm("EXCLUIR PERFIL? Todos os dados ser√£o deletados!")){await db.ref('users/'+window.adminTarget.clientId).remove();alert("Cadastro exclu√≠do.");window.logoutAdmin();}}
</script></body></html>
